

<!DOCTYPE html>
<html class="writer-html5" lang="en" >
<head>
  <meta charset="utf-8" />
  
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  
  <title>src.Tracking_Functions &mdash; MOAAP-Tracking-Analysis  documentation</title>
  

  
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/pygments.css" type="text/css" />
  <link rel="stylesheet" href="../../_static/css/theme.css" type="text/css" />

  
  

  
  

  

  
  <!--[if lt IE 9]>
    <script src="../../_static/js/html5shiv.min.js"></script>
  <![endif]-->
  
    
      <script type="text/javascript" id="documentation_options" data-url_root="../../" src="../../_static/documentation_options.js"></script>
        <script data-url_root="../../" id="documentation_options" src="../../_static/documentation_options.js"></script>
        <script src="../../_static/doctools.js"></script>
        <script src="../../_static/sphinx_highlight.js"></script>
    
    <script type="text/javascript" src="../../_static/js/theme.js"></script>

    
    <link rel="index" title="Index" href="../../genindex.html" />
    <link rel="search" title="Search" href="../../search.html" /> 
</head>

<body class="wy-body-for-nav">

   
  <div class="wy-grid-for-nav">
    
    <nav data-toggle="wy-nav-shift" class="wy-nav-side">
      <div class="wy-side-scroll">
        <div class="wy-side-nav-search" >
          

          
            <a href="../../index.html" class="icon icon-home"> MOAAP-Tracking-Analysis
          

          
          </a>

          
            
            
          

          
<div role="search">
  <form id="rtd-search-form" class="wy-form" action="../../search.html" method="get">
    <input type="text" name="q" placeholder="Search docs" />
    <input type="hidden" name="check_keywords" value="yes" />
    <input type="hidden" name="area" value="default" />
  </form>
</div>

          
        </div>

        
        <div class="wy-menu wy-menu-vertical" data-spy="affix" role="navigation" aria-label="main navigation">
          
            
            
              
            
            
              <p class="caption" role="heading"><span class="caption-text">Contents:</span></p>
<ul>
<li class="toctree-l1"><a class="reference internal" href="../../modules.html">src</a></li>
</ul>

            
          
        </div>
        
      </div>
    </nav>

    <section data-toggle="wy-nav-shift" class="wy-nav-content-wrap">

      
      <nav class="wy-nav-top" aria-label="top navigation">
        
          <i data-toggle="wy-nav-top" class="fa fa-bars"></i>
          <a href="../../index.html">MOAAP-Tracking-Analysis</a>
        
      </nav>


      <div class="wy-nav-content">
        
        <div class="rst-content">
        
          

















<div role="navigation" aria-label="breadcrumbs navigation">

  <ul class="wy-breadcrumbs">
    
      <li><a href="../../index.html" class="icon icon-home"></a> &raquo;</li>
        
          <li><a href="../index.html">Module code</a> &raquo;</li>
        
      <li>src.Tracking_Functions</li>
    
    
      <li class="wy-breadcrumbs-aside">
        
      </li>
    
  </ul>

  
  <hr/>
</div>
          <div role="main" class="document" itemscope="itemscope" itemtype="http://schema.org/Article">
           <div itemprop="articleBody">
            
  <h1>Source code for src.Tracking_Functions</h1><div class="highlight"><pre>
<span></span><span class="ch">#!/usr/bin/env python</span>

<span class="sd">&#39;&#39;&#39; </span>
<span class="sd">   Tracking_Functions.py</span>

<span class="sd">   This file contains the tracking fuctions for the object</span>
<span class="sd">   identification and tracking of precipitation areas, cyclones,</span>
<span class="sd">   clouds, and moisture streams</span>

<span class="sd">&#39;&#39;&#39;</span>

<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">stats</span>
<span class="kn">import</span> <span class="nn">matplotlib.pyplot</span> <span class="k">as</span> <span class="nn">plt</span>
<span class="kn">from</span> <span class="nn">netCDF4</span> <span class="kn">import</span> <span class="n">Dataset</span>
<span class="kn">import</span> <span class="nn">glob</span>
<span class="kn">import</span> <span class="nn">os</span>
<span class="kn">from</span> <span class="nn">pdb</span> <span class="kn">import</span> <span class="n">set_trace</span> <span class="k">as</span> <span class="n">stop</span>
<span class="c1"># from scipy.ndimage.filters import gaussian_filter</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">gaussian_filter</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">median_filter</span>
<span class="kn">from</span> <span class="nn">scipy.ndimage</span> <span class="kn">import</span> <span class="n">label</span>
<span class="kn">from</span> <span class="nn">matplotlib</span> <span class="kn">import</span> <span class="n">cm</span>
<span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
<span class="kn">import</span> <span class="nn">random</span>
<span class="kn">import</span> <span class="nn">scipy</span>
<span class="kn">import</span> <span class="nn">pickle</span>
<span class="kn">import</span> <span class="nn">datetime</span>
<span class="kn">import</span> <span class="nn">pandas</span> <span class="k">as</span> <span class="nn">pd</span>
<span class="kn">import</span> <span class="nn">subprocess</span>
<span class="kn">import</span> <span class="nn">matplotlib.path</span> <span class="k">as</span> <span class="nn">mplPath</span>
<span class="kn">import</span> <span class="nn">sys</span>
<span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>
<span class="kn">from</span> <span class="nn">itertools</span> <span class="kn">import</span> <span class="n">groupby</span>
<span class="kn">from</span> <span class="nn">tqdm</span> <span class="kn">import</span> <span class="n">tqdm</span>
<span class="kn">import</span> <span class="nn">time</span>

<span class="c1">#### speed up interpolation</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">spint</span>
<span class="kn">import</span> <span class="nn">scipy.spatial.qhull</span> <span class="k">as</span> <span class="nn">qhull</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>
<span class="kn">import</span> <span class="nn">netCDF4</span>


<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>

<span class="c1">### UTILITY Functions</span>
<div class="viewcode-block" id="calc_grid_distance_area"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.calc_grid_distance_area">[docs]</a><span class="k">def</span> <span class="nf">calc_grid_distance_area</span><span class="p">(</span><span class="n">lon</span><span class="p">,</span><span class="n">lat</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Function to calculate grid parameters</span>
<span class="sd">        It uses haversine function to approximate distances</span>
<span class="sd">        It approximates the first row and column to the sencond</span>
<span class="sd">        because coordinates of grid cell center are assumed</span>
<span class="sd">        lat, lon: input coordinates(degrees) 2D [y,x] dimensions</span>
<span class="sd">        dx: distance (m)</span>
<span class="sd">        dy: distance (m)</span>
<span class="sd">        area: area of grid cell (m2)</span>
<span class="sd">        grid_distance: average grid distance over the domain (m)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lon</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">lat</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

    <span class="n">dx</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:]</span><span class="o">=</span><span class="n">haversine</span><span class="p">(</span><span class="n">lon</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span><span class="n">lat</span><span class="p">[:,</span><span class="mi">1</span><span class="p">:],</span><span class="n">lon</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">],</span><span class="n">lat</span><span class="p">[:,:</span><span class="o">-</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">dy</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:]</span><span class="o">=</span><span class="n">haversine</span><span class="p">(</span><span class="n">lon</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:],</span><span class="n">lat</span><span class="p">[</span><span class="mi">1</span><span class="p">:,:],</span><span class="n">lon</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:],</span><span class="n">lat</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>

    <span class="n">dx</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">dx</span><span class="p">[:,</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">dy</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">dy</span><span class="p">[</span><span class="mi">1</span><span class="p">,:]</span>
    
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dx</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dy</span> <span class="o">*</span> <span class="mi">10</span><span class="o">**</span><span class="mi">3</span>

    <span class="n">area</span> <span class="o">=</span> <span class="n">dx</span><span class="o">*</span><span class="n">dy</span>
    <span class="n">grid_distance</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">dy</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">dx</span><span class="p">[:,</span> <span class="p">:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">))</span>

    <span class="k">return</span> <span class="n">dx</span><span class="p">,</span><span class="n">dy</span><span class="p">,</span><span class="n">area</span><span class="p">,</span><span class="n">grid_distance</span></div>


<div class="viewcode-block" id="radialdistance"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.radialdistance">[docs]</a><span class="k">def</span> <span class="nf">radialdistance</span><span class="p">(</span><span class="n">lat1</span><span class="p">,</span><span class="n">lon1</span><span class="p">,</span><span class="n">lat2</span><span class="p">,</span><span class="n">lon2</span><span class="p">):</span>
    <span class="c1"># Approximate radius of earth in km</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mf">6373.0</span>

    <span class="n">lat1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span>
    <span class="n">lon1</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon1</span><span class="p">)</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span>
    <span class="n">lon2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">(</span><span class="n">lon2</span><span class="p">)</span>

    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>

    <span class="n">distance</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">distance</span></div>

<div class="viewcode-block" id="haversine"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.haversine">[docs]</a><span class="k">def</span> <span class="nf">haversine</span><span class="p">(</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Calculate the great circle distance between two points</span>
<span class="sd">    on the earth (specified in decimal degrees)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># convert decimal degrees to radians</span>
    <span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span> <span class="o">=</span> <span class="nb">map</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">radians</span><span class="p">,</span> <span class="p">[</span><span class="n">lon1</span><span class="p">,</span> <span class="n">lat1</span><span class="p">,</span> <span class="n">lon2</span><span class="p">,</span> <span class="n">lat2</span><span class="p">])</span>
    <span class="c1"># haversine formula</span>
    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>
    <span class="n">a</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlat</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">sin</span><span class="p">(</span><span class="n">dlon</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">np</span><span class="o">.</span><span class="n">arcsin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">))</span>
    <span class="n">km</span> <span class="o">=</span> <span class="mi">6367</span> <span class="o">*</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">km</span></div>

<span class="c1"># def haversine(lat1, lon1, lat2, lon2):</span>

<span class="c1">#     &quot;&quot;&quot;Function to calculate grid distances lat-lon</span>
<span class="c1">#        This uses the Haversine formula</span>
<span class="c1">#        lat,lon : input coordinates (degrees) - array or float</span>
<span class="c1">#        dist_m : distance (m)</span>
<span class="c1">#        https://en.wikipedia.org/wiki/Haversine_formula</span>
<span class="c1">#        &quot;&quot;&quot;</span>
<span class="c1">#     # convert decimal degrees to radians</span>
<span class="c1">#     lon1 = np.radians(lon1)</span>
<span class="c1">#     lon2 = np.radians(lon2)</span>
<span class="c1">#     lat1 = np.radians(lat1)</span>
<span class="c1">#     lat2 = np.radians(lat2)</span>

<span class="c1">#     # haversine formula</span>
<span class="c1">#     dlon = lon2 - lon1</span>
<span class="c1">#     dlat = lat2 - lat1</span>
<span class="c1">#     a = np.sin(dlat / 2) ** 2 + \</span>
<span class="c1">#     np.cos(lat1) * np.cos(lat2) * np.sin(dlon / 2) ** 2</span>
<span class="c1">#     c = 2 * np.arcsin(np.sqrt(a))</span>
<span class="c1">#     # Radius of earth in kilometers is 6371</span>
<span class="c1">#     dist_m = c * 6371000 #const.earth_radius</span>
<span class="c1">#     return dist_m</span>

<div class="viewcode-block" id="calculate_area_objects"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.calculate_area_objects">[docs]</a><span class="k">def</span> <span class="nf">calculate_area_objects</span><span class="p">(</span><span class="n">objects_id_pr</span><span class="p">,</span><span class="n">object_indices</span><span class="p">,</span><span class="n">grid_cell_area</span><span class="p">):</span>

<span class="w">    </span><span class="sd">&quot;&quot;&quot; Calculates the area of each object during their lifetime</span>
<span class="sd">        one area value for each object and each timestep it exist</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_indices</span><span class="p">)</span>
    <span class="n">area_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
        <span class="p">[</span>
            <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grid_cell_area</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="mi">1</span><span class="p">:]][</span><span class="n">objects_id_pr</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]][</span><span class="n">tstep</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">obj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">tstep</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">objects_id_pr</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_objects</span><span class="p">)</span>
        <span class="p">],</span>
    <span class="n">dtype</span><span class="o">=</span><span class="nb">object</span>
    <span class="p">)</span>

    <span class="k">return</span> <span class="n">area_objects</span></div>

<div class="viewcode-block" id="remove_small_short_objects"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.remove_small_short_objects">[docs]</a><span class="k">def</span> <span class="nf">remove_small_short_objects</span><span class="p">(</span><span class="n">objects_id</span><span class="p">,</span>
                               <span class="n">area_objects</span><span class="p">,</span>
                               <span class="n">min_area</span><span class="p">,</span>
                               <span class="n">min_time</span><span class="p">,</span>
                               <span class="n">DT</span><span class="p">,</span>
                               <span class="n">objects</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;Checks if the object is large enough during enough time steps</span>
<span class="sd">        and removes objects that do not meet this condition</span>
<span class="sd">        area_object: array of lists with areas of each objects during their lifetime [objects[tsteps]]</span>
<span class="sd">        min_area: minimum area of the object (km2)</span>
<span class="sd">        min_time: minimum time with the object large enough (hours)</span>
<span class="sd">        DT: time step of input data [hours]</span>
<span class="sd">        objects: object slices - speeds up processing if provided</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="c1">#create final object array</span>
    <span class="n">sel_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">objects_id</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="n">new_obj_id</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">area_objects</span><span class="p">):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">area_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">min_area</span> <span class="o">*</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span>
                <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">min_time</span><span class="o">/</span> <span class="n">DT</span><span class="p">)),</span>
                <span class="n">mode</span><span class="o">=</span><span class="s2">&quot;valid&quot;</span><span class="p">,</span>
            <span class="p">)</span>
        <span class="p">)</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_time</span><span class="o">/</span> <span class="n">DT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span>
            <span class="nb">len</span><span class="p">(</span><span class="n">area_objects</span><span class="p">[</span><span class="n">obj</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_time</span><span class="o">/</span> <span class="n">DT</span><span class="p">)</span>
        <span class="p">):</span>
            <span class="k">if</span> <span class="n">objects</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="n">sel_objects</span><span class="p">[</span><span class="n">objects_id</span> <span class="o">==</span> <span class="p">(</span><span class="n">obj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span>     <span class="n">new_obj_id</span>
                <span class="n">new_obj_id</span> <span class="o">+=</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">sel_objects</span><span class="p">[</span><span class="n">objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]][</span><span class="n">objects_id</span><span class="p">[</span><span class="n">objects</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span> <span class="o">==</span> <span class="p">(</span><span class="n">obj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">new_obj_id</span>
                <span class="n">new_obj_id</span> <span class="o">+=</span> <span class="mi">1</span>

    <span class="k">return</span> <span class="n">sel_objects</span></div>




<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>

<span class="c1">###########################################################</span>
<span class="c1">###########################################################</span>
<div class="viewcode-block" id="calc_object_characteristics"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.calc_object_characteristics">[docs]</a><span class="k">def</span> <span class="nf">calc_object_characteristics</span><span class="p">(</span>
    <span class="n">var_objects</span><span class="p">,</span>  <span class="c1"># feature object file</span>
    <span class="n">var_data</span><span class="p">,</span>  <span class="c1"># original file used for feature detection</span>
    <span class="n">filename_out</span><span class="p">,</span>  <span class="c1"># output file name and locaiton</span>
    <span class="n">times</span><span class="p">,</span>  <span class="c1"># timesteps of the data</span>
    <span class="n">Lat</span><span class="p">,</span>  <span class="c1"># 2D latidudes</span>
    <span class="n">Lon</span><span class="p">,</span>  <span class="c1"># 2D Longitudes</span>
    <span class="n">grid_spacing</span><span class="p">,</span>       <span class="c1"># average grid spacing</span>
    <span class="n">grid_cell_area</span><span class="p">,</span>
    <span class="n">min_tsteps</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>   <span class="c1"># minimum lifetime in data timesteps</span>
    <span class="n">dict_keys_offset</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
    <span class="n">split_merge</span> <span class="o">=</span> <span class="kc">None</span>  <span class="c1"># dict containing information of splitting and merging of objects</span>
    <span class="p">):</span>
    <span class="c1"># ========</span>
    <span class="n">num_objects</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">var_objects</span><span class="o">.</span><span class="n">max</span><span class="p">())</span>
<span class="c1">#     num_objects = len(np.unique(var_objects))-1</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">var_objects</span><span class="p">)</span>

    <span class="c1">#print (split_merge)</span>
    <span class="k">if</span> <span class="n">num_objects</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">objects_charac</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            Loop over &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_objects</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; objects&quot;</span><span class="p">)</span>
        
        <span class="k">for</span> <span class="n">iobj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">num_objects</span><span class="p">):</span>
            <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">object_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">var_objects</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>
            <span class="n">data_slice</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">var_data</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>

            <span class="n">time_idx_slice</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">lat_idx_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lon_idx_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">object_slice</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">min_tsteps</span><span class="p">:</span>

                <span class="n">data_slice</span><span class="p">[</span><span class="n">object_slice</span><span class="o">!=</span><span class="p">(</span><span class="n">iobj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">grid_cell_area_slice</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">grid_cell_area</span><span class="p">[</span><span class="n">lat_idx_slice</span><span class="p">,</span> <span class="n">lon_idx_slice</span><span class="p">],</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">data_slice</span><span class="p">),</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
                <span class="n">grid_cell_area_slice</span><span class="p">[</span><span class="n">object_slice</span> <span class="o">!=</span> <span class="p">(</span><span class="n">iobj</span> <span class="o">+</span> <span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">lat_slice</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">lat_idx_slice</span><span class="p">,</span> <span class="n">lon_idx_slice</span><span class="p">]</span>
                <span class="n">lon_slice</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">lat_idx_slice</span><span class="p">,</span> <span class="n">lon_idx_slice</span><span class="p">]</span>


                <span class="c1"># calculate statistics</span>
                <span class="n">obj_times</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="n">time_idx_slice</span><span class="p">]</span>
                <span class="n">obj_size</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">grid_cell_area_slice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">obj_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">data_slice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">obj_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">data_slice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">obj_mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">data_slice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
                <span class="n">obj_tot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">data_slice</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>


                <span class="c1"># Track lat/lon</span>
                <span class="c1"># obj_mass_center = \</span>
                <span class="c1"># np.array([ndimage.measurements.center_of_mass(object_slice[tt,:,:]==(iobj+1)) for tt in range(object_slice.shape[0])])</span>
                <span class="c1"># ### JLa</span>
                <span class="n">obj_mass_center</span> <span class="o">=</span> \
                <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">ndimage</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">object_slice</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">==</span><span class="p">(</span><span class="n">iobj</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">object_slice</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>

                <span class="n">obj_track</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">full</span><span class="p">([</span><span class="nb">len</span><span class="p">(</span><span class="n">obj_mass_center</span><span class="p">),</span> <span class="mi">2</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span><span class="p">)</span>
                <span class="n">iREAL</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obj_mass_center</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">obj_track</span><span class="p">[</span><span class="n">iREAL</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lat_slice</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">obj_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">obj_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>    <span class="k">for</span> <span class="n">tstep</span><span class="p">,</span> <span class="n">obj_loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj_mass_center</span><span class="p">[</span><span class="n">iREAL</span><span class="p">,:])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obj_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">])</span>
                    <span class="n">obj_track</span><span class="p">[</span><span class="n">iREAL</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">lon_slice</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">obj_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])),</span><span class="nb">int</span><span class="p">(</span><span class="nb">round</span><span class="p">(</span><span class="n">obj_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">]))]</span>    <span class="k">for</span> <span class="n">tstep</span><span class="p">,</span> <span class="n">obj_loc</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">obj_mass_center</span><span class="p">[</span><span class="n">iREAL</span><span class="p">,:])</span> <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">obj_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">!=</span> <span class="kc">True</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">stop</span><span class="p">()</span>
                    
                    
<span class="c1">#                 obj_track = np.full([len(obj_mass_center), 2], np.nan)</span>
<span class="c1">#                 try:</span>
<span class="c1">#                     obj_track[:,0]=np.array([lat_slice[int(round(obj_loc[0])),int(round(obj_loc[1]))]    for tstep, obj_loc in enumerate(obj_mass_center[:,:]) if np.isnan(obj_loc[0]) != True])</span>
<span class="c1">#                     obj_track[:,1]=np.array([lon_slice[int(round(obj_loc[0])),int(round(obj_loc[1]))]    for tstep, obj_loc in enumerate(obj_mass_center[:,:]) if np.isnan(obj_loc[0]) != True])</span>
<span class="c1">#                 except:</span>
<span class="c1">#                     stop()</span>
                    
<span class="c1">#                 if np.any(np.isnan(obj_track)):</span>
<span class="c1">#                     raise ValueError(&quot;track array contains NaNs&quot;)</span>

                <span class="n">obj_speed</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">diff</span><span class="p">(</span><span class="n">obj_mass_center</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">grid_spacing</span> <span class="o">/</span> <span class="mf">1000.0</span><span class="p">)</span>
                
                <span class="n">this_object_charac</span> <span class="o">=</span> <span class="p">{</span>
                    <span class="s2">&quot;mass_center_loc&quot;</span><span class="p">:</span> <span class="n">obj_mass_center</span><span class="p">,</span>
                    <span class="s2">&quot;speed&quot;</span><span class="p">:</span> <span class="n">obj_speed</span><span class="p">,</span>
                    <span class="s2">&quot;tot&quot;</span><span class="p">:</span> <span class="n">obj_tot</span><span class="p">,</span>
                    <span class="s2">&quot;min&quot;</span><span class="p">:</span> <span class="n">obj_min</span><span class="p">,</span>
                    <span class="s2">&quot;max&quot;</span><span class="p">:</span> <span class="n">obj_max</span><span class="p">,</span>
                    <span class="s2">&quot;mean&quot;</span><span class="p">:</span> <span class="n">obj_mean</span><span class="p">,</span>
                    <span class="s2">&quot;size&quot;</span><span class="p">:</span> <span class="n">obj_size</span><span class="p">,</span>
                    <span class="c1">#                        &#39;rgrAccumulation&#39;:rgrAccumulation,</span>
                    <span class="s2">&quot;times&quot;</span><span class="p">:</span> <span class="n">obj_times</span><span class="p">,</span>
                    <span class="s2">&quot;track&quot;</span><span class="p">:</span> <span class="n">obj_track</span><span class="p">,</span>
                    <span class="s2">&quot;lon_idx_slice&quot;</span> <span class="p">:</span> <span class="n">lon_idx_slice</span> <span class="p">,</span>
                    <span class="s2">&quot;lat_idx_slice&quot;</span> <span class="p">:</span> <span class="n">lat_idx_slice</span> <span class="p">,</span>
                    <span class="s2">&quot;time_idx_slice&quot;</span> <span class="p">:</span> <span class="n">time_idx_slice</span> <span class="p">,</span>
                    <span class="c1">#&quot;lat_slice&quot;: lat_slice,</span>
                    <span class="c1">#&quot;lon_slice&quot;: lon_slice,</span>
                    <span class="c1">#&quot;object_slice&quot;: object_slice,</span>
                    <span class="s2">&quot;data_slice&quot;</span><span class="p">:</span> <span class="n">data_slice</span><span class="p">,</span>
                    <span class="s2">&quot;split_info&quot;</span> <span class="p">:</span> <span class="n">split_merge</span> <span class="c1">#JRie added</span>
                <span class="p">}</span>

                <span class="k">try</span><span class="p">:</span>
                    <span class="n">objects_charac</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iobj</span> <span class="o">+</span> <span class="mi">1</span> <span class="o">+</span> <span class="n">dict_keys_offset</span><span class="p">)]</span> <span class="o">=</span> <span class="n">this_object_charac</span> <span class="c1">#add offset to dict keys in order to differentiate between objects of different years</span>

                <span class="k">except</span><span class="p">:</span>
                    <span class="k">raise</span> <span class="ne">ValueError</span> <span class="p">(</span><span class="s2">&quot;Error asigning properties to final dictionary&quot;</span><span class="p">)</span>


        <span class="k">if</span> <span class="n">filename_out</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">with</span> <span class="nb">open</span><span class="p">(</span><span class="n">filename_out</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span> <span class="s1">&#39;wb&#39;</span><span class="p">)</span> <span class="k">as</span> <span class="n">handle</span><span class="p">:</span>
                <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">objects_charac</span><span class="p">,</span> <span class="n">handle</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">objects_charac</span></div>

    


    
    

<span class="c1"># This function is a predecessor of calc_object_characteristics</span>
<div class="viewcode-block" id="ObjectCharacteristics"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ObjectCharacteristics">[docs]</a><span class="k">def</span> <span class="nf">ObjectCharacteristics</span><span class="p">(</span><span class="n">PR_objectsFull</span><span class="p">,</span> <span class="c1"># feature object file</span>
                         <span class="n">PR_orig</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                         <span class="n">SaveFile</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                         <span class="n">TIME</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                         <span class="n">Gridspacing</span><span class="p">,</span>     <span class="c1"># average grid spacing</span>
                         <span class="n">Area</span><span class="p">,</span>
                         <span class="n">MinTime</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span>       <span class="c1"># minimum lifetime of an object</span>
                         <span class="n">Boundary</span> <span class="o">=</span> <span class="mi">1</span>
                         <span class="p">):</span>   <span class="c1"># 1 --&gt; remove object when it hits the boundary of the domain</span>
                                              <span class="c1">#</span>


    <span class="c1"># ========</span>

    <span class="kn">import</span> <span class="nn">scipy</span>
    <span class="kn">import</span> <span class="nn">pickle</span>

    <span class="n">nr_objectsUD</span><span class="o">=</span><span class="n">PR_objectsFull</span><span class="o">.</span><span class="n">max</span><span class="p">()</span>
    <span class="n">rgiObjectsUDFull</span> <span class="o">=</span> <span class="n">PR_objectsFull</span>
    <span class="k">if</span> <span class="n">nr_objectsUD</span> <span class="o">&gt;=</span> <span class="mi">1</span><span class="p">:</span>
        <span class="n">grObject</span><span class="o">=</span><span class="p">{}</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            Loop over &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">PR_objectsFull</span><span class="o">.</span><span class="n">max</span><span class="p">())</span><span class="o">+</span><span class="s1">&#39; objects&#39;</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">PR_objectsFull</span><span class="o">.</span><span class="n">max</span><span class="p">())):</span>
    <span class="c1">#             print(&#39;        process object &#39;+str(ob+1)+&#39; out of &#39;+str(PR_objectsFull.max()))</span>
            <span class="n">TT</span><span class="o">=</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">PR_objectsFull</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
            <span class="k">if</span> <span class="nb">sum</span><span class="p">(</span><span class="n">TT</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MinTime</span><span class="p">:</span>
                <span class="n">PR_object</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PR_objectsFull</span><span class="p">[</span><span class="n">TT</span><span class="p">,:,:])</span>
                <span class="n">PR_object</span><span class="p">[</span><span class="n">PR_object</span> <span class="o">!=</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
                <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">PR_object</span><span class="p">)</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">Objects</span> <span class="o">=</span> <span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Objects</span><span class="p">)</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">)[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]]</span>

                <span class="n">ObjAct</span> <span class="o">=</span> <span class="n">PR_object</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">ValAct</span> <span class="o">=</span> <span class="n">PR_orig</span><span class="p">[</span><span class="n">TT</span><span class="p">,:,:][</span><span class="n">Objects</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>
                <span class="n">ValAct</span><span class="p">[</span><span class="n">ObjAct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">AreaAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]][</span><span class="kc">None</span><span class="p">,:,:],</span> <span class="n">ValAct</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
                <span class="n">AreaAct</span><span class="p">[</span><span class="n">ObjAct</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="n">LatAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]])</span>
                <span class="n">LonAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">1</span><span class="p">:]])</span>

                <span class="c1"># calculate statistics</span>
                <span class="n">TimeAct</span><span class="o">=</span><span class="n">TIME</span><span class="p">[</span><span class="n">TT</span><span class="p">]</span>
                <span class="n">rgrSize</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">AreaAct</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">rgrPR_Min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">ValAct</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">rgrPR_Max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">ValAct</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">rgrPR_Mean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">ValAct</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
                <span class="n">rgrPR_Vol</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nansum</span><span class="p">(</span><span class="n">ValAct</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

                <span class="c1"># Track lat/lon</span>
                <span class="n">rgrMassCent</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">scipy</span><span class="o">.</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">ObjAct</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjAct</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
                <span class="n">TrackAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">),</span><span class="mi">2</span><span class="p">));</span> <span class="n">TrackAll</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">FIN</span> <span class="o">=</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span>
                    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                            <span class="n">TrackAll</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">LatAct</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">))]</span>
                            <span class="n">TrackAll</span><span class="p">[</span><span class="n">ii</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">LonAct</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="mi">0</span><span class="p">)),</span> <span class="nb">int</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="mi">0</span><span class="p">))]</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">stop</span><span class="p">()</span>

                <span class="n">rgrObjSpeed</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([((</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">tt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="n">rgrMassCent</span><span class="p">[</span><span class="n">tt</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="mi">1</span><span class="p">])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ValAct</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">)])</span><span class="o">*</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span>

                <span class="n">grAct</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;rgrMassCent&#39;</span><span class="p">:</span><span class="n">rgrMassCent</span><span class="p">,</span> 
                       <span class="s1">&#39;rgrObjSpeed&#39;</span><span class="p">:</span><span class="n">rgrObjSpeed</span><span class="p">,</span>
                       <span class="s1">&#39;rgrPR_Vol&#39;</span><span class="p">:</span><span class="n">rgrPR_Vol</span><span class="p">,</span>
                       <span class="s1">&#39;rgrPR_Min&#39;</span><span class="p">:</span><span class="n">rgrPR_Min</span><span class="p">,</span>
                       <span class="s1">&#39;rgrPR_Max&#39;</span><span class="p">:</span><span class="n">rgrPR_Max</span><span class="p">,</span>
                       <span class="s1">&#39;rgrPR_Mean&#39;</span><span class="p">:</span><span class="n">rgrPR_Mean</span><span class="p">,</span>
                       <span class="s1">&#39;rgrSize&#39;</span><span class="p">:</span><span class="n">rgrSize</span><span class="p">,</span>
    <span class="c1">#                        &#39;rgrAccumulation&#39;:rgrAccumulation,</span>
                       <span class="s1">&#39;TimeAct&#39;</span><span class="p">:</span><span class="n">TimeAct</span><span class="p">,</span>
                       <span class="s1">&#39;rgrMassCentLatLon&#39;</span><span class="p">:</span><span class="n">TrackAll</span><span class="p">}</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">grObject</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span><span class="o">=</span><span class="n">grAct</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="n">stop</span><span class="p">()</span>
                    <span class="k">continue</span>
        <span class="k">if</span> <span class="n">SaveFile</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">grObject</span><span class="p">,</span> <span class="nb">open</span><span class="p">(</span><span class="n">SaveFile</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span> <span class="p">)</span> <span class="p">)</span>
        <span class="k">return</span> <span class="n">grObject</span></div>
    
    
<span class="c1"># ==============================================================</span>
<span class="c1"># ==============================================================</span>

<span class="c1">#### speed up interpolation</span>
<span class="kn">import</span> <span class="nn">scipy.interpolate</span> <span class="k">as</span> <span class="nn">spint</span>
<span class="kn">import</span> <span class="nn">scipy.spatial.qhull</span> <span class="k">as</span> <span class="nn">qhull</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">xarray</span> <span class="k">as</span> <span class="nn">xr</span>

<div class="viewcode-block" id="interp_weights"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.interp_weights">[docs]</a><span class="k">def</span> <span class="nf">interp_weights</span><span class="p">(</span><span class="n">xy</span><span class="p">,</span> <span class="n">uv</span><span class="p">,</span><span class="n">d</span><span class="o">=</span><span class="mi">2</span><span class="p">):</span>
    <span class="n">tri</span> <span class="o">=</span> <span class="n">qhull</span><span class="o">.</span><span class="n">Delaunay</span><span class="p">(</span><span class="n">xy</span><span class="p">)</span>
    <span class="n">simplex</span> <span class="o">=</span> <span class="n">tri</span><span class="o">.</span><span class="n">find_simplex</span><span class="p">(</span><span class="n">uv</span><span class="p">)</span>
    <span class="n">vertices</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">simplices</span><span class="p">,</span> <span class="n">simplex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">tri</span><span class="o">.</span><span class="n">transform</span><span class="p">,</span> <span class="n">simplex</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>
    <span class="n">delta</span> <span class="o">=</span> <span class="n">uv</span> <span class="o">-</span> <span class="n">temp</span><span class="p">[:,</span> <span class="n">d</span><span class="p">]</span>
    <span class="n">bary</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;njk,nk-&gt;nj&#39;</span><span class="p">,</span> <span class="n">temp</span><span class="p">[:,</span> <span class="p">:</span><span class="n">d</span><span class="p">,</span> <span class="p">:],</span> <span class="n">delta</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">vertices</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">hstack</span><span class="p">((</span><span class="n">bary</span><span class="p">,</span> <span class="mi">1</span> <span class="o">-</span> <span class="n">bary</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">,</span> <span class="n">keepdims</span><span class="o">=</span><span class="kc">True</span><span class="p">)))</span></div>

<span class="c1"># ==============================================================</span>
<span class="c1"># ==============================================================</span>

<div class="viewcode-block" id="interpolate"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.interpolate">[docs]</a><span class="k">def</span> <span class="nf">interpolate</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">vtx</span><span class="p">,</span> <span class="n">wts</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">einsum</span><span class="p">(</span><span class="s1">&#39;nj,nj-&gt;n&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">take</span><span class="p">(</span><span class="n">values</span><span class="p">,</span> <span class="n">vtx</span><span class="p">),</span> <span class="n">wts</span><span class="p">)</span></div>


<span class="c1"># ==============================================================</span>
<span class="c1"># ==============================================================</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.filters</span> <span class="k">as</span> <span class="nn">filters</span>
<span class="kn">import</span> <span class="nn">scipy.ndimage.morphology</span> <span class="k">as</span> <span class="nn">morphology</span>

<div class="viewcode-block" id="detect_local_minima"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.detect_local_minima">[docs]</a><span class="k">def</span> <span class="nf">detect_local_minima</span><span class="p">(</span><span class="n">arr</span><span class="p">):</span>
    <span class="c1"># https://stackoverflow.com/questions/3684484/peak-detection-in-a-2d-array/3689710#3689710</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Takes an array and detects the troughs using the local maximum filter.</span>
<span class="sd">    Returns a boolean mask of the troughs (i.e. 1 when</span>
<span class="sd">    the pixel&#39;s value is the neighborhood maximum, 0 otherwise)</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="c1"># define an connected neighborhood</span>
    <span class="c1"># http://www.scipy.org/doc/api_docs/SciPy.ndimage.morphology.html#generate_binary_structure</span>
    <span class="n">neighborhood</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">generate_binary_structure</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">),</span><span class="mi">2</span><span class="p">)</span>
    <span class="c1"># apply the local minimum filter; all locations of minimum value </span>
    <span class="c1"># in their neighborhood are set to 1</span>
    <span class="c1"># http://www.scipy.org/doc/api_docs/SciPy.ndimage.filters.html#minimum_filter</span>
    <span class="n">local_min</span> <span class="o">=</span> <span class="p">(</span><span class="n">filters</span><span class="o">.</span><span class="n">minimum_filter</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">footprint</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">)</span><span class="o">==</span><span class="n">arr</span><span class="p">)</span>
    <span class="c1"># local_min is a mask that contains the peaks we are </span>
    <span class="c1"># looking for, but also the background.</span>
    <span class="c1"># In order to isolate the peaks we must remove the background from the mask.</span>
    <span class="c1"># </span>
    <span class="c1"># we create the mask of the background</span>
    <span class="n">background</span> <span class="o">=</span> <span class="p">(</span><span class="n">arr</span><span class="o">==</span><span class="mi">0</span><span class="p">)</span>
    <span class="c1"># </span>
    <span class="c1"># a little technicality: we must erode the background in order to </span>
    <span class="c1"># successfully subtract it from local_min, otherwise a line will </span>
    <span class="c1"># appear along the background border (artifact of the local minimum filter)</span>
    <span class="c1"># http://www.scipy.org/doc/api_docs/SciPy.ndimage.morphology.html#binary_erosion</span>
    <span class="n">eroded_background</span> <span class="o">=</span> <span class="n">morphology</span><span class="o">.</span><span class="n">binary_erosion</span><span class="p">(</span>
        <span class="n">background</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">neighborhood</span><span class="p">,</span> <span class="n">border_value</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="c1"># </span>
    <span class="c1"># we obtain the final mask, containing only peaks, </span>
    <span class="c1"># by removing the background from the local_min mask</span>
    <span class="n">detected_minima</span> <span class="o">=</span> <span class="n">local_min</span> <span class="o">^</span> <span class="n">eroded_background</span>
    <span class="k">return</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">detected_minima</span><span class="p">)</span>   </div>


<span class="c1"># ==============================================================</span>
<span class="c1"># ==============================================================</span>
<div class="viewcode-block" id="Feature_Calculation"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.Feature_Calculation">[docs]</a><span class="k">def</span> <span class="nf">Feature_Calculation</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">,</span>    <span class="c1"># np array that contains [time,lat,lon,Variables] with vars</span>
                        <span class="n">Variables</span><span class="p">,</span>   <span class="c1"># Variables beeing [&#39;V&#39;, &#39;U&#39;, &#39;T&#39;, &#39;Q&#39;, &#39;SLP&#39;]</span>
                        <span class="n">dLon</span><span class="p">,</span>        <span class="c1"># distance between longitude cells</span>
                        <span class="n">dLat</span><span class="p">,</span>        <span class="c1"># distance between latitude cells</span>
                        <span class="n">Lat</span><span class="p">,</span>         <span class="c1"># Latitude coordinates</span>
                        <span class="n">dT</span><span class="p">,</span>          <span class="c1"># time step in hours</span>
                        <span class="n">Gridspacing</span><span class="p">):</span><span class="c1"># grid spacing in m</span>
    <span class="kn">from</span> <span class="nn">scipy</span> <span class="kn">import</span> <span class="n">ndimage</span>
    
    
    <span class="c1"># 11111111111111111111111111111111111111111111111111</span>
    <span class="c1"># calculate vapor transport on pressure level</span>
    <span class="n">VapTrans</span> <span class="o">=</span> <span class="p">((</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)]</span><span class="o">*</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)]</span><span class="o">*</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Q&#39;</span><span class="p">)])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># 22222222222222222222222222222222222222222222222222</span>
    <span class="c1"># Frontal Detection according to https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017GL073662</span>
    <span class="n">UU</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U&#39;</span><span class="p">)]</span>
    <span class="n">VV</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;V&#39;</span><span class="p">)]</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dLon</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dLat</span>
    <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">UU</span> <span class="p">)</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">VV</span> <span class="p">)</span>
    <span class="n">PV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">dv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dx</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">du</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">dy</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="p">)</span>
    <span class="n">TK</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;T&#39;</span><span class="p">)]</span>
    <span class="n">vgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">TK</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">Tgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vgrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vgrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">Fstar</span> <span class="o">=</span> <span class="n">PV</span> <span class="o">*</span> <span class="n">Tgrad</span>

    <span class="n">Tgrad_zero</span> <span class="o">=</span> <span class="mf">0.45</span><span class="c1">#*100/(np.mean([dLon,dLat], axis=0)/1000.)  # 0.45 K/(100 km)</span>
    <span class="kn">import</span> <span class="nn">metpy.calc</span> <span class="k">as</span> <span class="nn">calc</span>
    <span class="kn">from</span> <span class="nn">metpy.units</span> <span class="kn">import</span> <span class="n">units</span>
    <span class="n">CoriolisPar</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">coriolis_parameter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
    <span class="n">Frontal_Diagnostic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Fstar</span><span class="o">/</span><span class="p">(</span><span class="n">CoriolisPar</span> <span class="o">*</span> <span class="n">Tgrad_zero</span><span class="p">))</span>

    <span class="c1"># # 3333333333333333333333333333333333333333333333333333</span>
    <span class="c1"># # Cyclone identification based on pressure annomaly threshold</span>

    <span class="n">SLP</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SLP&#39;</span><span class="p">)]</span><span class="o">/</span><span class="mf">100.</span>
    <span class="c1"># remove high-frequency variabilities --&gt; smooth over 100 x 100 km (no temporal smoothing)</span>
    <span class="n">SLP_smooth</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">SLP</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
    <span class="c1"># smoothign over 3000 x 3000 km and 78 hours</span>
    <span class="n">SLPsmoothAn</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">SLP</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
    <span class="n">SLP_Anomaly</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">SLP_smooth</span><span class="o">-</span><span class="n">SLPsmoothAn</span><span class="p">)</span>
    <span class="c1"># plt.contour(SLP_Anomaly[tt,:,:], levels=[-9990,-10,1100], colors=&#39;b&#39;)</span>
    <span class="n">Pressure_anomaly</span> <span class="o">=</span> <span class="n">SLP_Anomaly</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">12</span> <span class="c1"># 12 hPa depression</span>
    <span class="n">HighPressure_annomaly</span> <span class="o">=</span> <span class="n">SLP_Anomaly</span> <span class="o">&gt;</span> <span class="mi">12</span>

    <span class="k">return</span> <span class="n">Pressure_anomaly</span><span class="p">,</span> <span class="n">Frontal_Diagnostic</span><span class="p">,</span> <span class="n">VapTrans</span><span class="p">,</span> <span class="n">SLP_Anomaly</span><span class="p">,</span> <span class="n">vgrad</span><span class="p">,</span> <span class="n">HighPressure_annomaly</span></div>



<span class="c1"># ==============================================================</span>
<span class="c1"># ==============================================================</span>
<span class="c1"># from math import radians, cos, sin, asin, sqrt</span>
<span class="c1"># def haversine(lon1, lat1, lon2, lat2):</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     Calculate the great circle distance between two points </span>
<span class="c1">#     on the earth (specified in decimal degrees)</span>
<span class="c1">#     &quot;&quot;&quot;</span>
<span class="c1">#     # convert decimal degrees to radians </span>
<span class="c1">#     lon1, lat1, lon2, lat2 = map(radians, [lon1, lat1, lon2, lat2])</span>
<span class="c1">#     # haversine formula </span>
<span class="c1">#     dlon = lon2 - lon1 </span>
<span class="c1">#     dlat = lat2 - lat1 </span>
<span class="c1">#     a = sin(dlat/2)**2 + cos(lat1) * cos(lat2) * sin(dlon/2)**2</span>
<span class="c1">#     c = 2 * asin(sqrt(a)) </span>
<span class="c1">#     # Radius of earth in kilometers is 6371</span>
<span class="c1">#     km = 6371* c</span>
<span class="c1">#     return km</span>



<div class="viewcode-block" id="ReadERA5"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ReadERA5">[docs]</a><span class="k">def</span> <span class="nf">ReadERA5</span><span class="p">(</span><span class="n">TIME</span><span class="p">,</span>      <span class="c1"># Time period to read (this program will read hourly data)</span>
            <span class="n">var</span><span class="p">,</span>        <span class="c1"># Variable name. See list below for defined variables</span>
            <span class="n">PL</span><span class="p">,</span>         <span class="c1"># Pressure level of variable</span>
            <span class="n">REGION</span><span class="p">):</span>    <span class="c1"># Region to read. Format must be &lt;[N,E,S,W]&gt; in degrees from -180 to +180 longitude</span>
    <span class="c1"># ----------</span>
    <span class="c1"># This function reads hourly ERA5 data for one variable from NCAR&#39;s RDA archive in a region of interest.</span>
    <span class="c1"># ----------</span>

    <span class="n">DayStart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">DayStop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">TimeDD</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">DayStart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">DayStop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">Plevels</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">5</span><span class="p">,</span> <span class="mi">7</span><span class="p">,</span> <span class="mi">10</span><span class="p">,</span> <span class="mi">20</span><span class="p">,</span> <span class="mi">30</span><span class="p">,</span> <span class="mi">50</span><span class="p">,</span> <span class="mi">70</span><span class="p">,</span> <span class="mi">100</span><span class="p">,</span> <span class="mi">125</span><span class="p">,</span> <span class="mi">150</span><span class="p">,</span> <span class="mi">175</span><span class="p">,</span> <span class="mi">200</span><span class="p">,</span> <span class="mi">225</span><span class="p">,</span> <span class="mi">250</span><span class="p">,</span> <span class="mi">300</span><span class="p">,</span> <span class="mi">350</span><span class="p">,</span> <span class="mi">400</span><span class="p">,</span> <span class="mi">450</span><span class="p">,</span> <span class="mi">500</span><span class="p">,</span> <span class="mi">550</span><span class="p">,</span> <span class="mi">600</span><span class="p">,</span> <span class="mi">650</span><span class="p">,</span> <span class="mi">700</span><span class="p">,</span> <span class="mi">750</span><span class="p">,</span> <span class="mi">775</span><span class="p">,</span> <span class="mi">800</span><span class="p">,</span> <span class="mi">825</span><span class="p">,</span> <span class="mi">850</span><span class="p">,</span> <span class="mi">875</span><span class="p">,</span> <span class="mi">900</span><span class="p">,</span> <span class="mi">925</span><span class="p">,</span> <span class="mi">950</span><span class="p">,</span> <span class="mi">975</span><span class="p">,</span> <span class="mi">1000</span><span class="p">])</span>

    <span class="n">dT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">divmod</span><span class="p">((</span><span class="n">TimeDD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">TimeDD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="mi">60</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    
    <span class="c1"># check if variable is defined</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;V&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;v.ll025uv&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.pl/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;V&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Plevels</span> <span class="o">-</span> <span class="n">PL</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;U&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;u.ll025uv&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.pl/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;U&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Plevels</span> <span class="o">-</span> <span class="n">PL</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;T&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;t.ll025sc&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.pl/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;T&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Plevels</span> <span class="o">-</span> <span class="n">PL</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;ZG&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;z.ll025sc&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.pl/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;Z&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Plevels</span> <span class="o">-</span> <span class="n">PL</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;Q&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;q.ll025sc&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.pl/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;Q&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Plevels</span> <span class="o">-</span> <span class="n">PL</span><span class="p">))</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;SLP&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;msl.ll025sc&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.sfc/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;MSL&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;IVTE&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;viwve.ll025sc&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.vinteg/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;VIWVE&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
    <span class="k">if</span> <span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;IVTN&#39;</span><span class="p">:</span>
        <span class="n">ERAvarfile</span> <span class="o">=</span> <span class="s1">&#39;viwvn.ll025sc&#39;</span>
        <span class="n">Dir</span> <span class="o">=</span> <span class="s1">&#39;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.an.vinteg/&#39;</span>
        <span class="n">NCvarname</span> <span class="o">=</span> <span class="s1">&#39;VIWVN&#39;</span>
        <span class="n">PL</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">ERAvarfile</span><span class="p">)</span>
    <span class="c1"># read in the coordinates</span>
    <span class="n">ncid</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="s2">&quot;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.nc&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">Lat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][:])</span>
    <span class="n">Lon</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][:])</span>
    <span class="c1"># Zfull=np.squeeze(ncid.variables[&#39;Z&#39;][:])</span>
    <span class="n">ncid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Lon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
        <span class="n">Lon</span><span class="p">[</span><span class="n">Lon</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Lon</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">]</span> <span class="o">-</span> <span class="mi">360</span>
    <span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span><span class="p">)</span>

    <span class="c1"># get the region of interest</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">REGION</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REGION</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># region crosses zero meridian</span>
        <span class="n">iRoll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iRoll</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">iRoll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">iNorth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">iSouth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">iEeast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">iWest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">iNorth</span><span class="p">,</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">,</span><span class="n">iEeast</span><span class="p">)</span>

    <span class="n">Lon</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">]</span>
    <span class="n">Lat</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">]</span>
    <span class="c1"># Z=np.roll(Zfull,iRoll, axis=1)</span>
    <span class="c1"># Z = Z[iNorth:iSouth,iWest:iEeast]</span>

    <span class="n">DataAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TIME</span><span class="p">),</span><span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span> <span class="n">DataAll</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">tt</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeDD</span><span class="p">)):</span>
        <span class="n">YYYYMM</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">YYYYMMDD</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">DirAct</span> <span class="o">=</span> <span class="n">Dir</span> <span class="o">+</span> <span class="n">YYYYMM</span> <span class="o">+</span> <span class="s1">&#39;/&#39;</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;SLP&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;IVTE&#39;</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="n">var</span> <span class="o">==</span> <span class="s1">&#39;IVTN&#39;</span><span class="p">):</span>
            <span class="n">FILES</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">DirAct</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">ERAvarfile</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">YYYYMM</span><span class="o">+</span><span class="s1">&#39;*.nc&#39;</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">FILES</span> <span class="o">=</span> <span class="n">glob</span><span class="o">.</span><span class="n">glob</span><span class="p">(</span><span class="n">DirAct</span> <span class="o">+</span> <span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">ERAvarfile</span><span class="o">+</span><span class="s1">&#39;*&#39;</span><span class="o">+</span><span class="n">YYYYMMDD</span><span class="o">+</span><span class="s1">&#39;*.nc&#39;</span><span class="p">)</span>
        <span class="n">FILES</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sort</span><span class="p">(</span><span class="n">FILES</span><span class="p">)</span>
        
        <span class="n">TIMEACT</span> <span class="o">=</span> <span class="n">TIME</span><span class="p">[(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">year</span> <span class="o">==</span> <span class="n">TIME</span><span class="o">.</span><span class="n">year</span><span class="p">)</span> <span class="o">&amp;</span>  <span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">month</span> <span class="o">==</span> <span class="n">TIME</span><span class="o">.</span><span class="n">month</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">TimeDD</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">day</span> <span class="o">==</span> <span class="n">TIME</span><span class="o">.</span><span class="n">day</span><span class="p">)]</span>
        
        <span class="k">for</span> <span class="n">fi</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">FILES</span><span class="p">)):</span> <span class="c1">#[7:9]:</span>
            <span class="nb">print</span><span class="p">(</span><span class="n">FILES</span><span class="p">[</span><span class="n">fi</span><span class="p">])</span>
            <span class="n">ncid</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">FILES</span><span class="p">[</span><span class="n">fi</span><span class="p">],</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
            <span class="n">time_var</span> <span class="o">=</span> <span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;time&#39;</span><span class="p">]</span>
            <span class="n">dtime</span> <span class="o">=</span> <span class="n">netCDF4</span><span class="o">.</span><span class="n">num2date</span><span class="p">(</span><span class="n">time_var</span><span class="p">[:],</span><span class="n">time_var</span><span class="o">.</span><span class="n">units</span><span class="p">)</span>
            <span class="n">TimeNC</span> <span class="o">=</span> <span class="n">pd</span><span class="o">.</span><span class="n">to_datetime</span><span class="p">([</span><span class="n">pd</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">d</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">day</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">hour</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">minute</span><span class="p">,</span> <span class="n">d</span><span class="o">.</span><span class="n">second</span><span class="p">)</span> <span class="k">for</span> <span class="n">d</span> <span class="ow">in</span> <span class="n">dtime</span><span class="p">])</span>
            <span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">TimeNC</span><span class="p">,</span> <span class="n">TIMEACT</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iRoll</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">PL</span> <span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="k">try</span><span class="p">:</span>
                        <span class="n">DATAact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">NCvarname</span><span class="p">][</span><span class="n">TT</span><span class="p">,</span><span class="n">PL</span><span class="p">,</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,:])</span>
                    <span class="k">except</span><span class="p">:</span>
                        <span class="n">stop</span><span class="p">()</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">DATAact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">NCvarname</span><span class="p">][</span><span class="n">TT</span><span class="p">,</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,:])</span>
                <span class="n">ncid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">PL</span> <span class="o">!=-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="n">DATAact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">NCvarname</span><span class="p">][</span><span class="n">TT</span><span class="p">,</span><span class="n">PL</span><span class="p">,</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">])</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">DATAact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">NCvarname</span><span class="p">][</span><span class="n">TT</span><span class="p">,</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">])</span>
                <span class="n">ncid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
            <span class="c1"># cut out region</span>
            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DATAact</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
                <span class="n">DATAact</span><span class="o">=</span><span class="n">DATAact</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:]</span>
            <span class="n">DATAact</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">DATAact</span><span class="p">,</span><span class="n">iRoll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">iRoll</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">DATAact</span> <span class="o">=</span> <span class="n">DATAact</span><span class="p">[:,:,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">DATAact</span> <span class="o">=</span> <span class="n">DATAact</span><span class="p">[:,:,:]</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">DataAll</span><span class="p">[</span><span class="n">tt</span><span class="p">:</span><span class="n">tt</span><span class="o">+</span><span class="n">DATAact</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:,:]</span><span class="o">=</span><span class="n">DATAact</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">tt</span> <span class="o">=</span> <span class="n">tt</span><span class="o">+</span><span class="n">DATAact</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">DataAll</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span></div>



<span class="c1"># =======================================================================================</span>
<div class="viewcode-block" id="ReadERA5_2D"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ReadERA5_2D">[docs]</a><span class="k">def</span> <span class="nf">ReadERA5_2D</span><span class="p">(</span><span class="n">TIME</span><span class="p">,</span>      <span class="c1"># Time period to read (this program will read hourly data)</span>
            <span class="n">var</span><span class="p">,</span>        <span class="c1"># Variable name. See list below for defined variables</span>
            <span class="n">PL</span><span class="p">,</span>         <span class="c1"># Pressure level of variable</span>
            <span class="n">REGION</span><span class="p">):</span>    <span class="c1"># Region to read. Format must be &lt;[N,E,S,W]&gt; in degrees from -180 to +180 longitude</span>
    <span class="c1"># ----------</span>
    <span class="c1"># This function reads hourly 2D ERA5 data.</span>
    <span class="c1"># ----------</span>
    <span class="kn">from</span> <span class="nn">calendar</span> <span class="kn">import</span> <span class="n">monthrange</span>

    <span class="n">DayStart</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">TIME</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">DayStop</span> <span class="o">=</span> <span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">,</span> <span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">,</span><span class="n">TIME</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span>
    <span class="n">TimeDD</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">DayStart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">DayStop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;d&#39;</span><span class="p">)</span>
    <span class="n">TimeMM</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">DayStart</span><span class="p">,</span> <span class="n">end</span><span class="o">=</span><span class="n">DayStop</span><span class="p">,</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;m&#39;</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">TimeMM</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">TimeMM</span> <span class="o">=</span> <span class="p">[</span><span class="n">TimeDD</span><span class="p">[</span><span class="mi">0</span><span class="p">]]</span>

    <span class="n">dT</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="nb">divmod</span><span class="p">((</span><span class="n">TimeDD</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">TimeDD</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">(),</span> <span class="mi">60</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span><span class="o">/</span><span class="mi">60</span><span class="p">)</span>
    <span class="n">ERA5dir</span> <span class="o">=</span> <span class="s1">&#39;/glade/campaign/mmm/c3we/prein/ERA5/hourly/&#39;</span>
    <span class="k">if</span> <span class="n">PL</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
        <span class="n">DirName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">PL</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DirName</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="n">var</span><span class="p">)</span>
    <span class="c1"># read in the coordinates</span>
    <span class="n">ncid</span><span class="o">=</span><span class="n">Dataset</span><span class="p">(</span><span class="s2">&quot;/gpfs/fs1/collections/rda/data/ds633.0/e5.oper.invariant/197901/e5.oper.invariant.128_129_z.ll025sc.1979010100_1979010100.nc&quot;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
    <span class="n">Lat</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;latitude&#39;</span><span class="p">][:])</span>
    <span class="n">Lon</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="s1">&#39;longitude&#39;</span><span class="p">][:])</span>
    <span class="c1"># Zfull=np.squeeze(ncid.variables[&#39;Z&#39;][:])</span>
    <span class="n">ncid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">Lon</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">180</span><span class="p">:</span>
        <span class="n">Lon</span><span class="p">[</span><span class="n">Lon</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">]</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Lon</span> <span class="o">&gt;=</span> <span class="mi">180</span><span class="p">]</span> <span class="o">-</span> <span class="mi">360</span>
    <span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span><span class="p">)</span>

    <span class="c1"># get the region of interest</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">REGION</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">REGION</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">):</span>
        <span class="c1"># region crosses zero meridian</span>
        <span class="n">iRoll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">iRoll</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">Lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">iRoll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">iNorth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">iSouth</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">2</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">iEeast</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">1</span><span class="p">]))</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">iWest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">REGION</span><span class="p">[</span><span class="mi">3</span><span class="p">]))</span>
    <span class="nb">print</span><span class="p">(</span><span class="n">iNorth</span><span class="p">,</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">,</span><span class="n">iEeast</span><span class="p">)</span>

    <span class="n">Lon</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">]</span>
    <span class="n">Lat</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">]</span>
    <span class="c1"># Z=np.roll(Zfull,iRoll, axis=1)</span>
    <span class="c1"># Z = Z[iNorth:iSouth,iWest:iEeast]</span>

    <span class="n">DataAll</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">TIME</span><span class="p">),</span><span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]));</span> <span class="n">DataAll</span><span class="p">[:]</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">tt</span><span class="o">=</span><span class="mi">0</span>
    
    <span class="k">for</span> <span class="n">mm</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">TimeMM</span><span class="p">))):</span>
        <span class="n">YYYYMM</span> <span class="o">=</span> <span class="nb">str</span><span class="p">(</span><span class="n">TimeMM</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">TimeMM</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">YYYY</span> <span class="o">=</span> <span class="n">TimeMM</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">year</span>
        <span class="n">MM</span> <span class="o">=</span> <span class="n">TimeMM</span><span class="p">[</span><span class="n">mm</span><span class="p">]</span><span class="o">.</span><span class="n">month</span>
        <span class="n">DD</span> <span class="o">=</span> <span class="n">monthrange</span><span class="p">(</span><span class="n">YYYY</span><span class="p">,</span> <span class="n">MM</span><span class="p">)[</span><span class="mi">1</span><span class="p">]</span>
        
        <span class="n">TimeFile</span> <span class="o">=</span> <span class="n">TimeDD</span><span class="o">=</span><span class="n">pd</span><span class="o">.</span><span class="n">date_range</span><span class="p">(</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">YYYY</span><span class="p">,</span> <span class="n">MM</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">),</span> <span class="n">end</span><span class="o">=</span><span class="n">datetime</span><span class="o">.</span><span class="n">datetime</span><span class="p">(</span><span class="n">YYYY</span><span class="p">,</span> <span class="n">MM</span><span class="p">,</span> <span class="n">DD</span><span class="p">,</span><span class="mi">23</span><span class="p">),</span> <span class="n">freq</span><span class="o">=</span><span class="s1">&#39;h&#39;</span><span class="p">)</span>
        <span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">TimeFile</span><span class="p">,</span><span class="n">TIME</span><span class="p">)</span>
        
        <span class="n">ncid</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">ERA5dir</span><span class="o">+</span><span class="n">DirName</span><span class="o">+</span><span class="s1">&#39;/&#39;</span><span class="o">+</span><span class="n">YYYYMM</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">DirName</span><span class="o">+</span><span class="s1">&#39;_ERA5.nc&#39;</span><span class="p">,</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;r&#39;</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iRoll</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">DATAact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">TT</span><span class="p">,</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,:])</span>
            <span class="n">ncid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">DATAact</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">squeeze</span><span class="p">(</span><span class="n">ncid</span><span class="o">.</span><span class="n">variables</span><span class="p">[</span><span class="n">var</span><span class="p">][</span><span class="n">TT</span><span class="p">,</span><span class="n">iNorth</span><span class="p">:</span><span class="n">iSouth</span><span class="p">,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">])</span>
            <span class="n">ncid</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        <span class="c1"># cut out region</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">DATAact</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">DATAact</span><span class="o">=</span><span class="n">DATAact</span><span class="p">[</span><span class="kc">None</span><span class="p">,:,:]</span>
        <span class="n">DATAact</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">DATAact</span><span class="p">,</span><span class="n">iRoll</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">iRoll</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">DATAact</span> <span class="o">=</span> <span class="n">DATAact</span><span class="p">[:,:,</span><span class="n">iWest</span><span class="p">:</span><span class="n">iEeast</span><span class="p">]</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">DataAll</span><span class="p">[</span><span class="n">tt</span><span class="p">:</span><span class="n">tt</span><span class="o">+</span><span class="n">DATAact</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],:,:]</span><span class="o">=</span><span class="n">DATAact</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">tt</span> <span class="o">=</span> <span class="n">tt</span><span class="o">+</span><span class="n">DATAact</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="k">return</span> <span class="n">DataAll</span><span class="p">,</span> <span class="n">Lat</span><span class="p">,</span> <span class="n">Lon</span></div>

<div class="viewcode-block" id="ConnectLon"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ConnectLon">[docs]</a><span class="k">def</span> <span class="nf">ConnectLon</span><span class="p">(</span><span class="n">object_indices</span><span class="p">):</span>
    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">object_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">EDGE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">object_indices</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">iEDGE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">EDGE</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">OBJ_Left</span> <span class="o">=</span> <span class="n">EDGE</span><span class="p">[</span><span class="n">iEDGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">OBJ_Right</span> <span class="o">=</span> <span class="n">EDGE</span><span class="p">[</span><span class="n">iEDGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">OBJ_joint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">OBJ_Left</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">OBJ_Right</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OBJ_Left</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">NotSame</span> <span class="o">=</span> <span class="n">OBJ_Left</span> <span class="o">!=</span> <span class="n">OBJ_Right</span>
        <span class="n">OBJ_joint</span> <span class="o">=</span> <span class="n">OBJ_joint</span><span class="p">[</span><span class="n">NotSame</span><span class="p">]</span>
        <span class="n">OBJ_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">OBJ_joint</span><span class="p">)</span>
        <span class="c1"># set the eastern object to the number of the western object in all timesteps</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OBJ_unique</span><span class="p">):</span>
            <span class="n">ObE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OBJ_unique</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ObW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OBJ_unique</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">object_indices</span><span class="p">[</span><span class="n">object_indices</span> <span class="o">==</span> <span class="n">ObE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObW</span>
    <span class="k">return</span> <span class="n">object_indices</span></div>


<div class="viewcode-block" id="ConnectLon_on_timestep"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ConnectLon_on_timestep">[docs]</a><span class="k">def</span> <span class="nf">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">object_indices</span><span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; This function connects objects over the date line on a time-step by</span>
<span class="sd">        time-step basis, which makes it different from the ConnectLon function.</span>
<span class="sd">        This function is needed when long-living objects are first split into</span>
<span class="sd">        smaller objects using the BreakupObjects function.</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">object_indices</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">EDGE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span>
            <span class="n">object_indices</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="o">-</span><span class="mi">1</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="mi">0</span><span class="p">][:,</span> <span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span>
        <span class="p">)</span>
        <span class="n">iEDGE</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">EDGE</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="o">==</span> <span class="mi">2</span>
        <span class="n">OBJ_Left</span> <span class="o">=</span> <span class="n">EDGE</span><span class="p">[</span><span class="n">iEDGE</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span>
        <span class="n">OBJ_Right</span> <span class="o">=</span> <span class="n">EDGE</span><span class="p">[</span><span class="n">iEDGE</span><span class="p">,</span> <span class="mi">1</span><span class="p">]</span>
        <span class="n">OBJ_joint</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
                <span class="n">OBJ_Left</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot;_&quot;</span> <span class="o">+</span> <span class="n">OBJ_Right</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">str</span><span class="p">)</span>
                <span class="k">for</span> <span class="n">ii</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OBJ_Left</span><span class="p">)</span>
            <span class="p">]</span>
        <span class="p">)</span>
        <span class="n">NotSame</span> <span class="o">=</span> <span class="n">OBJ_Left</span> <span class="o">!=</span> <span class="n">OBJ_Right</span>
        <span class="n">OBJ_joint</span> <span class="o">=</span> <span class="n">OBJ_joint</span><span class="p">[</span><span class="n">NotSame</span><span class="p">]</span>
        <span class="n">OBJ_unique</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">OBJ_joint</span><span class="p">)</span>
        <span class="c1"># set the eastern object to the number of the western object in all timesteps</span>
        <span class="k">for</span> <span class="n">obj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">OBJ_unique</span><span class="p">):</span>
            <span class="n">ObE</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OBJ_unique</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">ObW</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">OBJ_unique</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span><span class="o">.</span><span class="n">split</span><span class="p">(</span><span class="s2">&quot;_&quot;</span><span class="p">)[</span><span class="mi">0</span><span class="p">])</span>
            <span class="n">object_indices</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">object_indices</span><span class="p">[</span><span class="n">tt</span><span class="p">,:]</span> <span class="o">==</span> <span class="n">ObE</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObW</span>
    <span class="k">return</span> <span class="n">object_indices</span></div>


<span class="c1">### Break up long living objects by extracting the biggest object at each time</span>
<div class="viewcode-block" id="BreakupObjects"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.BreakupObjects">[docs]</a><span class="k">def</span> <span class="nf">BreakupObjects</span><span class="p">(</span>
    <span class="n">DATA</span><span class="p">,</span>  <span class="c1"># 3D matrix [time,lat,lon] containing the objects</span>
    <span class="n">min_tsteps</span><span class="p">,</span>  <span class="c1"># minimum lifetime in data timesteps</span>
    <span class="n">dT</span><span class="p">,</span><span class="c1"># time step in hours</span>
    <span class="n">obj_history</span> <span class="o">=</span> <span class="kc">False</span><span class="p">,</span>  <span class="c1"># calculates how object start and end</span>
    <span class="p">):</span>  

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
    <span class="n">MaxOb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
    <span class="n">MinLif</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_tsteps</span> <span class="o">/</span> <span class="n">dT</span><span class="p">)</span>  <span class="c1"># min lifetime of object to be split</span>
    <span class="n">AVmax</span> <span class="o">=</span> <span class="mf">1.5</span>

    <span class="n">obj_structure_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">,</span> <span class="mi">3</span><span class="p">))</span>
    <span class="n">obj_structure_2D</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">rgiObjects2D</span><span class="p">,</span> <span class="n">nr_objects2D</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">obj_structure_2D</span><span class="p">)</span>

    <span class="n">rgiObjNrs</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">DATA</span><span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
    <span class="n">TT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">MaxOb</span><span class="p">))</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">MaxOb</span><span class="p">):</span>  
        <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">TT</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
    <span class="n">TT</span> <span class="o">=</span> <span class="n">TT</span><span class="p">[</span><span class="n">rgiObjNrs</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>
    <span class="n">TT</span> <span class="o">=</span> <span class="n">TT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
    <span class="c1"># Sel_Obj = rgiObjNrs[TT &gt; MinLif]</span>

    <span class="c1"># Average 2D objects in 3D objects?</span>
    <span class="n">Av_2Dob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiObjNrs</span><span class="p">)))</span>
    <span class="n">Av_2Dob</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    
    <span class="n">object_split</span> <span class="o">=</span> <span class="p">{}</span> <span class="c1"># this directory holds information about splitting and merging of objects</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiObjNrs</span><span class="p">))):</span>
        <span class="n">iOb</span> <span class="o">=</span> <span class="n">rgiObjNrs</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">TT</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">MinLif</span><span class="p">:</span>
            <span class="c1"># ignore short lived objects</span>
            <span class="n">DATA</span><span class="p">[</span><span class="n">DATA</span> <span class="o">==</span> <span class="n">iOb</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>
        <span class="n">SelOb</span> <span class="o">=</span> <span class="n">rgiObjNrs</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">-</span> <span class="mi">1</span>
        <span class="n">DATA_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">SelOb</span><span class="p">]])</span>
        <span class="n">rgiObjects2D_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjects2D</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">SelOb</span><span class="p">]])</span>
        <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">DATA_ACT</span> <span class="o">!=</span> <span class="n">iOb</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">Av_2Dob</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span>
            <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
                <span class="p">[</span>
                    <span class="nb">len</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]))</span> <span class="o">-</span> <span class="mi">1</span>
                    <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">DATA_ACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
                <span class="p">]</span>
            <span class="p">)</span>
        <span class="p">)</span>

        <span class="k">if</span> <span class="n">Av_2Dob</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">AVmax</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">obj_history</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># this is a signle[ object</span>
                <span class="n">object_split</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iOb</span><span class="p">)]</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="n">TT</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">SelOb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="c1"># object starts when tracking starts</span>
                    <span class="n">object_split</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iOb</span><span class="p">)][</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">SelOb</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">==</span> <span class="n">DATA</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                    <span class="c1"># object stops when tracking stops</span>
                    <span class="n">object_split</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">iOb</span><span class="p">)][</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">rgiObAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])[</span><span class="mi">1</span><span class="p">:]</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">rgiObActCP</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObAct</span><span class="p">))</span>
                <span class="k">for</span> <span class="n">ob1</span> <span class="ow">in</span> <span class="n">rgiObAct</span><span class="p">:</span>
                    <span class="n">tt1_obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                            <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">ob1</span><span class="p">]</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt1_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                        <span class="c1"># this object ends here</span>
                        <span class="n">rgiObActCP</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">ob1</span><span class="p">)</span>
                        <span class="k">continue</span>
                    <span class="k">elif</span> <span class="nb">len</span><span class="p">(</span><span class="n">tt1_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">rgiObjects2D_ACT</span><span class="p">[</span>
                            <span class="n">tt</span><span class="p">,</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">tt1_obj</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">ob1</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">VOL</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">tt1_obj</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">tt1_obj</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="n">rgiObjects2D_ACT</span><span class="p">[</span>
                            <span class="n">tt</span><span class="p">,</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">tt1_obj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">VOL</span><span class="p">)]</span>
                        <span class="p">]</span> <span class="o">=</span> <span class="n">ob1</span>
                        <span class="n">tt1_obj</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">tt1_obj</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">VOL</span><span class="p">)])</span>
                        <span class="n">rgiObActCP</span> <span class="o">=</span> <span class="n">rgiObActCP</span> <span class="o">+</span> <span class="nb">list</span><span class="p">(</span><span class="n">tt1_obj</span><span class="p">)</span>

                <span class="c1"># make sure that mergers are assigned the largest object</span>
                <span class="k">for</span> <span class="n">ob2</span> <span class="ow">in</span> <span class="n">rgiObActCP</span><span class="p">:</span>
                    <span class="n">ttm1_obj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span>
                        <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span>
                            <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">ob2</span><span class="p">]</span>
                        <span class="p">)[</span><span class="mi">1</span><span class="p">:]</span>
                    <span class="p">)</span>
                    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ttm1_obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">:</span>
                        <span class="n">VOL</span> <span class="o">=</span> <span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span> <span class="o">-</span> <span class="mi">1</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">ttm1_obj</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                            <span class="k">for</span> <span class="n">jj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">ttm1_obj</span><span class="p">)</span>
                        <span class="p">]</span>
                        <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">ob2</span><span class="p">]</span> <span class="o">=</span> <span class="n">ttm1_obj</span><span class="p">[</span>
                            <span class="n">np</span><span class="o">.</span><span class="n">argmax</span><span class="p">(</span><span class="n">VOL</span><span class="p">)</span>
                        <span class="p">]</span>

                <span class="c1"># are there new object?</span>
                <span class="n">NewObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:])[</span><span class="mi">1</span><span class="p">:]</span>
                <span class="n">NewObj</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">setdiff1d</span><span class="p">(</span><span class="n">NewObj</span><span class="p">,</span> <span class="n">rgiObAct</span><span class="p">))</span>
                <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">NewObj</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">rgiObActCP</span> <span class="o">=</span> <span class="n">rgiObActCP</span> <span class="o">+</span> <span class="n">NewObj</span>
                <span class="n">rgiObActCP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">rgiObActCP</span><span class="p">)</span>
                <span class="n">rgiObAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObActCP</span><span class="p">)</span>

            <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">rgiObjects2D_ACT</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span>
                <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">rgiObjects2D_ACT</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">+</span> <span class="n">MaxOb</span>
            <span class="p">)</span>
            <span class="n">MaxOb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>

            <span class="c1"># save the new objects to the original object array</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DATA</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">SelOb</span><span class="p">]])</span>
            <span class="n">TMP</span><span class="p">[</span><span class="n">rgiObjects2D_ACT</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">rgiObjects2D_ACT</span><span class="p">[</span><span class="n">rgiObjects2D_ACT</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">]</span>
            <span class="n">DATA</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">SelOb</span><span class="p">]]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">TMP</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">obj_history</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
                <span class="c1"># ----------------------------------</span>
                <span class="c1"># remember how objects start and end</span>
                <span class="n">temp_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">TMP</span><span class="p">[</span><span class="n">DATA_ACT</span><span class="p">[:,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">==</span> <span class="n">iOb</span><span class="p">])</span>
                <span class="k">for</span> <span class="n">ob_ms</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">temp_obj</span><span class="p">)):</span>
                    <span class="n">t1_obj</span> <span class="o">=</span> <span class="n">temp_obj</span><span class="p">[</span><span class="n">ob_ms</span><span class="p">]</span>
                    <span class="n">sel_time</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">TMP</span> <span class="o">==</span> <span class="n">t1_obj</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)[</span><span class="mi">0</span><span class="p">]</span>
                    <span class="n">obj_charac</span> <span class="o">=</span> <span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">*</span> <span class="nb">len</span><span class="p">(</span><span class="n">sel_time</span><span class="p">)</span>
                    <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">sel_time</span><span class="p">)):</span>
                        <span class="k">if</span> <span class="n">sel_time</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># object starts when tracking starts</span>
                            <span class="n">obj_charac</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">elif</span> <span class="n">sel_time</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">TMP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="c1"># object ends when tracking ends</span>
                            <span class="n">obj_charac</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

                        <span class="c1"># check if system starts from splitting</span>
                        <span class="n">t0_ob</span> <span class="o">=</span> <span class="n">TMP</span><span class="p">[</span><span class="n">sel_time</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:][</span><span class="n">TMP</span><span class="p">[</span><span class="n">sel_time</span><span class="p">[</span><span class="n">kk</span><span class="p">],:,:]</span> <span class="o">==</span> <span class="n">t1_obj</span><span class="p">]</span>
                        <span class="n">unique_t0</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">t0_ob</span><span class="p">))</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_t0</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">try</span><span class="p">:</span>
                            <span class="n">unique_t0</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t1_obj</span><span class="p">)</span>
                        <span class="k">except</span><span class="p">:</span>
                            <span class="k">pass</span>
                        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_t0</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
                            <span class="c1"># object has pure start or continues without interactions</span>
                            <span class="k">continue</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="c1"># Object merges with other object</span>
                            <span class="n">obj_charac</span><span class="p">[</span><span class="n">kk</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_t0</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="c1"># check if object ends by merging</span>
                    <span class="k">if</span> <span class="n">obj_charac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">!=</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                        <span class="k">if</span> <span class="n">sel_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span> <span class="o">==</span> <span class="n">TMP</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
                            <span class="n">obj_charac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">t2_ob</span> <span class="o">=</span> <span class="n">TMP</span><span class="p">[</span><span class="n">sel_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">,:,:][</span><span class="n">TMP</span><span class="p">[</span><span class="n">sel_time</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">],:,:]</span> <span class="o">==</span> <span class="n">t1_obj</span><span class="p">]</span>
                            <span class="n">unique_t2</span> <span class="o">=</span> <span class="nb">list</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">t2_ob</span><span class="p">))</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">unique_t2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="mi">0</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">try</span><span class="p">:</span>
                                <span class="n">unique_t2</span><span class="o">.</span><span class="n">remove</span><span class="p">(</span><span class="n">t1_obj</span><span class="p">)</span>
                            <span class="k">except</span><span class="p">:</span>
                                <span class="k">pass</span>
                            <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">unique_t2</span><span class="p">)</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
                                <span class="n">obj_charac</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">unique_t2</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>

                    <span class="n">object_split</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">t1_obj</span><span class="p">)]</span> <span class="o">=</span> <span class="n">obj_charac</span>

    <span class="c1"># clean up object matrix</span>
    <span class="k">if</span> <span class="n">obj_history</span> <span class="o">==</span> <span class="kc">True</span><span class="p">:</span>
        <span class="n">DATA_fin</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span>    <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span>
                                    <span class="n">dT</span><span class="p">,</span>
                                    <span class="n">min_tsteps</span><span class="p">,</span> 
                                    <span class="n">obj_splitmerge</span> <span class="o">=</span> <span class="n">object_split</span><span class="p">)</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">DATA_fin</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span>    <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span>
                                    <span class="n">dT</span><span class="p">,</span>
                                    <span class="n">min_tsteps</span><span class="p">)</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">DATA_fin</span><span class="p">,</span> <span class="n">object_split</span></div>




<span class="c1"># from https://stackoverflow.com/questions/27779677/how-to-format-elapsed-time-from-seconds-to-hours-minutes-seconds-and-milliseco</span>
<div class="viewcode-block" id="timer"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.timer">[docs]</a><span class="k">def</span> <span class="nf">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span><span class="n">end</span><span class="p">):</span>
    <span class="n">hours</span><span class="p">,</span> <span class="n">rem</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">end</span><span class="o">-</span><span class="n">start</span><span class="p">,</span> <span class="mi">3600</span><span class="p">)</span>
    <span class="n">minutes</span><span class="p">,</span> <span class="n">seconds</span> <span class="o">=</span> <span class="nb">divmod</span><span class="p">(</span><span class="n">rem</span><span class="p">,</span> <span class="mi">60</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        &quot;</span><span class="o">+</span><span class="s2">&quot;</span><span class="si">{:0&gt;2}</span><span class="s2">:</span><span class="si">{:0&gt;2}</span><span class="s2">:</span><span class="si">{:05.2f}</span><span class="s2">&quot;</span><span class="o">.</span><span class="n">format</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">hours</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="n">minutes</span><span class="p">),</span><span class="n">seconds</span><span class="p">))</span></div>


<span class="c1"># this function removes nan values by interpolating temporally</span>
<span class="kn">from</span> <span class="nn">numba</span> <span class="kn">import</span> <span class="n">jit</span>
<div class="viewcode-block" id="interpolate_numba"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.interpolate_numba">[docs]</a><span class="nd">@jit</span><span class="p">(</span><span class="n">nopython</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
<span class="k">def</span> <span class="nf">interpolate_numba</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">no_data</span><span class="o">=-</span><span class="mi">32768</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;return array interpolated along time-axis to fill missing values&quot;&quot;&quot;</span>
    <span class="n">result</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros_like</span><span class="p">(</span><span class="n">arr</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">int16</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">x</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]):</span>
        <span class="c1"># slice along x axis</span>
        <span class="k">for</span> <span class="n">y</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]):</span>
            <span class="c1"># slice along y axis</span>
            <span class="k">for</span> <span class="n">z</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">arr</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">value</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                <span class="k">if</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>  <span class="c1"># don&#39;t interpolate first value</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">elif</span> <span class="n">z</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span>  <span class="c1"># don&#39;t interpolate last value</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>

                <span class="k">elif</span> <span class="n">value</span> <span class="o">==</span> <span class="n">no_data</span><span class="p">:</span>  <span class="c1"># interpolate</span>

                    <span class="n">left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                    <span class="n">right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                    <span class="c1"># look for valid neighbours</span>
                    <span class="k">if</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">right</span> <span class="o">!=</span> <span class="n">no_data</span><span class="p">:</span>  <span class="c1"># left and right are valid</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="k">elif</span> <span class="n">left</span> <span class="o">==</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>  <span class="c1"># boundary condition left</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">elif</span> <span class="n">right</span> <span class="o">==</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">z</span> <span class="o">==</span> <span class="nb">len</span><span class="p">(</span><span class="n">arr</span><span class="p">[:,</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">])</span><span class="o">-</span><span class="mi">2</span><span class="p">:</span>  <span class="c1"># boundary condition right</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>

                    <span class="k">elif</span> <span class="n">left</span> <span class="o">==</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">right</span> <span class="o">!=</span> <span class="n">no_data</span><span class="p">:</span>  <span class="c1"># take second neighbour to the left</span>
                        <span class="n">more_left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">more_left</span> <span class="o">==</span> <span class="n">no_data</span><span class="p">:</span>
                            <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">more_left</span> <span class="o">+</span> <span class="n">right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="k">elif</span> <span class="n">left</span> <span class="o">!=</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">right</span> <span class="o">==</span> <span class="n">no_data</span><span class="p">:</span>  <span class="c1"># take second neighbour to the right</span>
                        <span class="n">more_right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">more_right</span> <span class="o">==</span> <span class="n">no_data</span><span class="p">:</span>
                            <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">more_right</span> <span class="o">+</span> <span class="n">left</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>

                    <span class="k">elif</span> <span class="n">left</span> <span class="o">==</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">right</span> <span class="o">==</span> <span class="n">no_data</span><span class="p">:</span>  <span class="c1"># take second neighbour on both sides</span>
                        <span class="n">more_left</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="o">-</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                        <span class="n">more_right</span> <span class="o">=</span> <span class="n">arr</span><span class="p">[</span><span class="n">z</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span>
                        <span class="k">if</span> <span class="n">more_left</span> <span class="o">!=</span> <span class="n">no_data</span> <span class="ow">and</span> <span class="n">more_right</span> <span class="o">!=</span> <span class="n">no_data</span><span class="p">:</span>
                            <span class="n">new_value</span> <span class="o">=</span> <span class="p">(</span><span class="n">more_left</span> <span class="o">+</span> <span class="n">more_right</span><span class="p">)</span> <span class="o">/</span> <span class="mi">2</span>
                        <span class="k">else</span><span class="p">:</span>
                            <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                    <span class="k">else</span><span class="p">:</span>
                        <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="k">else</span><span class="p">:</span>
                    <span class="n">new_value</span> <span class="o">=</span> <span class="n">value</span>
                <span class="n">result</span><span class="p">[</span><span class="n">z</span><span class="p">,</span><span class="n">y</span><span class="p">,</span><span class="n">x</span><span class="p">]</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">new_value</span><span class="p">)</span>
    <span class="k">return</span> <span class="n">result</span></div>


<span class="c1"># ============================================================</span>
<span class="c1">#              tropical wave classification</span>
<span class="c1"># https://github.com/tmiyachi/mcclimate/blob/master/kf_filter.py</span>

<span class="kn">import</span> <span class="nn">numpy</span>
<span class="kn">import</span> <span class="nn">scipy.fftpack</span> <span class="k">as</span> <span class="nn">fftpack</span>
<span class="kn">import</span> <span class="nn">scipy.signal</span> <span class="k">as</span> <span class="nn">signal</span>
<span class="kn">import</span> <span class="nn">sys</span>

<span class="n">gravitational_constant</span> <span class="o">=</span> <span class="mf">6.673e-11</span> <span class="c1">#Nm^2/kg^2</span>
<span class="n">gasconst</span> <span class="o">=</span> <span class="mf">8.314e+3</span> <span class="c1">#JK^-1kmol^-1</span>

<span class="c1">#earth</span>
<span class="n">gravity_earth</span> <span class="o">=</span> <span class="mf">9.81</span> <span class="c1">#m/s^2</span>
<span class="n">radius_earth</span> <span class="o">=</span> <span class="mf">6.37e+6</span>
<span class="n">omega_earth</span> <span class="o">=</span> <span class="mf">7.292e-5</span>

<span class="c1">#air</span>
<span class="n">gasconst_dry</span> <span class="o">=</span> <span class="mi">287</span>
<span class="n">specific_heat_pressure</span> <span class="o">=</span> <span class="mi">1004</span>
<span class="n">specific_heat_volume</span> <span class="o">=</span> <span class="mi">717</span>
<span class="n">ratio_gamma</span> <span class="o">=</span> <span class="n">specific_heat_pressure</span><span class="o">/</span><span class="n">specific_heat_volume</span>

<span class="n">NA</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">newaxis</span>
<span class="n">pi</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">pi</span>
<span class="n">g</span> <span class="o">=</span> <span class="n">gravity_earth</span>
<span class="n">a</span> <span class="o">=</span> <span class="n">radius_earth</span>
<span class="n">beta</span> <span class="o">=</span> <span class="mf">2.0</span><span class="o">*</span><span class="n">omega_earth</span><span class="o">/</span><span class="n">radius_earth</span>


<div class="viewcode-block" id="KFfilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter">[docs]</a><span class="k">class</span> <span class="nc">KFfilter</span><span class="p">:</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;class for wavenumber-frequency filtering for WK99 and WKH00&quot;&quot;&quot;</span>
    <span class="k">def</span> <span class="fm">__init__</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">datain</span><span class="p">,</span> <span class="n">spd</span><span class="p">,</span> <span class="n">tim_taper</span><span class="o">=</span><span class="mf">0.1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;Arguments:</span>
<span class="sd">        </span>
<span class="sd">       &#39;datain&#39;    -- the data to be filtered. dimension must be (time, lat, lon)</span>

<span class="sd">       &#39;spd&#39;       -- samples per day</span>

<span class="sd">       &#39;tim_taper&#39; -- tapering ratio by cos. applay tapering first and last tim_taper%</span>
<span class="sd">                      samples. default is cos20 tapering</span>

<span class="sd">                      &quot;&quot;&quot;</span>
        <span class="n">ntim</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nlon</span> <span class="o">=</span> <span class="n">datain</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1">#remove the lowest three harmonics of the seasonal cycle (WK99, WKW03)</span>
<span class="c1">##         if ntim &gt; 365*spd/3:</span>
<span class="c1">##             rf = fftpack.rfft(datain,axis=0)</span>
<span class="c1">##             freq = fftpack.rfftfreq(ntim*spd, d=1./float(spd))</span>
<span class="c1">##             rf[(freq &lt;= 3./365) &amp; (freq &gt;=1./365),:,:] = 0.0     #freq&lt;=3./365 only??</span>
<span class="c1">##             datain = fftpack.irfft(rf,axis=0)</span>

        <span class="c1">#remove dominal trend</span>
        <span class="n">data</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">detrend</span><span class="p">(</span><span class="n">datain</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

        <span class="c1">#tapering</span>
        <span class="k">if</span> <span class="n">tim_taper</span> <span class="o">==</span> <span class="s1">&#39;hann&#39;</span><span class="p">:</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">signal</span><span class="o">.</span><span class="n">hann</span><span class="p">(</span><span class="n">ntim</span><span class="p">)</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">window</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,</span><span class="n">NA</span><span class="p">]</span>
        <span class="k">elif</span> <span class="n">tim_taper</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1">#taper by cos tapering same dtype as input array</span>
            <span class="n">tp</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">ntim</span><span class="o">*</span><span class="n">tim_taper</span><span class="p">)</span>
            <span class="n">window</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">ntim</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="n">datain</span><span class="o">.</span><span class="n">dtype</span><span class="p">)</span>
            <span class="n">x</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">arange</span><span class="p">(</span><span class="n">tp</span><span class="p">)</span>
            <span class="n">window</span><span class="p">[:</span><span class="n">tp</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">tp</span><span class="p">))</span>
            <span class="n">window</span><span class="p">[</span><span class="o">-</span><span class="n">tp</span><span class="p">:]</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="mf">1.0</span><span class="o">-</span><span class="n">numpy</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">x</span><span class="p">[::</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">*</span><span class="n">pi</span><span class="o">/</span><span class="n">tp</span><span class="p">))</span>
            <span class="n">data</span> <span class="o">=</span> <span class="n">data</span> <span class="o">*</span> <span class="n">window</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,</span><span class="n">NA</span><span class="p">]</span>

        <span class="c1">#FFT</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fft2</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1">#Note</span>
        <span class="c1"># fft is defined by exp(-ikx), so to adjust exp(ikx) multipried minus         </span>
        <span class="n">wavenumber</span> <span class="o">=</span> <span class="o">-</span><span class="n">fftpack</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">nlon</span><span class="p">)</span><span class="o">*</span><span class="n">nlon</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">fftfreq</span><span class="p">(</span><span class="n">ntim</span><span class="p">,</span> <span class="n">d</span><span class="o">=</span><span class="mf">1.</span><span class="o">/</span><span class="nb">float</span><span class="p">(</span><span class="n">spd</span><span class="p">))</span>
        <span class="n">knum</span><span class="p">,</span> <span class="n">freq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">meshgrid</span><span class="p">(</span><span class="n">wavenumber</span><span class="p">,</span> <span class="n">frequency</span><span class="p">)</span>

        <span class="c1">#make f&lt;0 domain same as f&gt;0 domain</span>
        <span class="c1">#CAUTION: wave definition is exp(i(k*x-omega*t)) but FFT definition exp(-ikx)</span>
        <span class="c1">#so cahnge sign</span>
        <span class="n">knum</span><span class="p">[</span><span class="n">freq</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="n">knum</span><span class="p">[</span><span class="n">freq</span><span class="o">&lt;</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">freq</span><span class="p">)</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">knum</span> <span class="o">=</span> <span class="n">knum</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">freq</span> <span class="o">=</span> <span class="n">freq</span>

        <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span> <span class="o">=</span> <span class="n">wavenumber</span>
        <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span> <span class="o">=</span> <span class="n">frequency</span>

<div class="viewcode-block" id="KFfilter.decompose_antisymm"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.decompose_antisymm">[docs]</a>    <span class="k">def</span> <span class="nf">decompose_antisymm</span><span class="p">(</span><span class="bp">self</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;decompose attribute data to sym and antisym component</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">symm</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fftdata</span><span class="p">[:,:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="o">+</span><span class="mi">1</span><span class="p">,:]</span> <span class="o">+</span> <span class="n">fftdata</span><span class="p">[:,</span><span class="n">nlat</span><span class="p">:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span>  
        <span class="n">anti</span> <span class="o">=</span> <span class="mf">0.5</span><span class="o">*</span><span class="p">(</span><span class="n">fftdata</span><span class="p">[:,:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">fftdata</span><span class="p">[:,</span><span class="n">nlat</span><span class="p">:</span><span class="n">nlat</span><span class="o">/</span><span class="mi">2</span><span class="p">:</span><span class="o">-</span><span class="mi">1</span><span class="p">,:])</span> 
        
        <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">concatenate</span><span class="p">([</span><span class="n">anti</span><span class="p">,</span> <span class="n">symm</span><span class="p">],</span><span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span></div>

<div class="viewcode-block" id="KFfilter.kfmask"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.kfmask">[docs]</a>    <span class="k">def</span> <span class="nf">kfmask</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="kc">None</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;return wavenumber-frequency mask for wavefilter method</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; --</span>

<span class="sd">           &#39;kmin/kmax&#39; --</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>

        <span class="c1">#wavenumber cut-off</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="k">return</span> <span class="n">mask</span></div>

<div class="viewcode-block" id="KFfilter.wavefilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.wavefilter">[docs]</a>    <span class="k">def</span> <span class="nf">wavefilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">mask</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;apply wavenumber-frequency filtering by original mask.</span>
<span class="sd">        </span>
<span class="sd">        Arguments:</span>
<span class="sd">        </span>
<span class="sd">           &#39;mask&#39; -- 2D boolean array (wavenumber, frequency).domain to be filterd</span>
<span class="sd">                     is False (True member to be zero)</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">wavenumber</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">wavenumber</span>
        <span class="n">frequency</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">frequency</span>
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="k">if</span> <span class="p">(</span><span class="n">nf</span><span class="p">,</span> <span class="n">nk</span><span class="p">)</span> <span class="o">!=</span> <span class="n">mask</span><span class="o">.</span><span class="n">shape</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span> <span class="s2">&quot;mask array size is incorrect.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>    
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="c1">#inverse FFT</span>
        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>

    <span class="c1">#filter</span>
<div class="viewcode-block" id="KFfilter.kelvinfilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.kelvinfilter">[docs]</a>    <span class="k">def</span> <span class="nf">kelvinfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="mf">0.05</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">0.4</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">14</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;kelvin wave filter</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number</span>

<span class="sd">           &#39;hmin/hmax&#39; --equivalent depth</span>
<span class="sd">        &quot;&quot;&quot;</span>
        
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>         <span class="c1">#adusting ^2pia to ^m</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span> <span class="o">-</span> <span class="n">k</span> <span class="o">&lt;</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span> <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>         <span class="c1">#adusting ^2pia to ^m</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span> <span class="o">-</span> <span class="n">k</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">)</span>

        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="KFfilter.erfilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.erfilter">[docs]</a>    <span class="k">def</span> <span class="nf">erfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;equatorial wave filter</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>

<span class="sd">           &#39;n&#39;         -- meridional mode number</span>
<span class="sd">        &quot;&quot;&quot;</span>

        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span><span class="o">%</span><span class="mi">1</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n must be n&gt;=1 integer&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">k</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">*</span><span class="p">(</span><span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">))</span> <span class="o">+</span> <span class="n">k</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="KFfilter.igfilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.igfilter">[docs]</a>    <span class="k">def</span> <span class="nf">igfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">15</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;n&gt;=1 inertio gravirt wave filter. default is n=1 WIG.</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>

<span class="sd">           &#39;n&#39;         -- meridional mode number</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">n</span> <span class="o">&lt;=</span><span class="mi">0</span> <span class="ow">or</span> <span class="n">n</span><span class="o">%</span><span class="mi">1</span> <span class="o">!=</span><span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;n must be n&gt;=1 integer. for n=0 EIG you must use eig0filter method.&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="p">(</span><span class="mi">2</span><span class="o">*</span><span class="n">n</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span>  <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>
        
        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="KFfilter.eig0filter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.eig0filter">[docs]</a>    <span class="k">def</span> <span class="nf">eig0filter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="mf">0.55</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=</span><span class="mi">15</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">12</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">50</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;n&gt;=0 eastward inertio gravirt wave filter.</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kmin must be positive. if k &lt; 0, this mode is MRG&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>

        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="KFfilter.mrgfilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.mrgfilter">[docs]</a>    <span class="k">def</span> <span class="nf">mrgfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">8</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;mixed Rossby gravity wave</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>

<span class="sd">           &#39;hmin/hmax&#39; -- equivalent depth</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;kmax must be negative. if k &gt; 0, this mode is the same as n=0 EIG&quot;</span><span class="p">)</span>
            <span class="n">sys</span><span class="o">.</span><span class="n">exit</span><span class="p">()</span>
            
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>

        <span class="c1"># filtering ############################################################</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>
        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="k">if</span> <span class="n">hmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmin</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">hmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">c</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">g</span><span class="o">*</span><span class="n">hmax</span><span class="p">)</span>
            <span class="n">omega</span> <span class="o">=</span> <span class="mf">2.</span><span class="o">*</span><span class="n">pi</span><span class="o">*</span><span class="n">freq</span><span class="o">/</span><span class="mf">24.</span><span class="o">/</span><span class="mf">3600.</span> <span class="o">/</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">beta</span><span class="o">*</span><span class="n">c</span><span class="p">)</span>           <span class="c1">#adusting day^-1 to s^-1</span>
            <span class="n">k</span>     <span class="o">=</span> <span class="n">knum</span><span class="o">/</span><span class="n">a</span> <span class="o">*</span> <span class="n">numpy</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">c</span><span class="o">/</span><span class="n">beta</span><span class="p">)</span>                         <span class="c1">#adusting ^2pia to ^m               </span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">omega</span><span class="o">**</span><span class="mi">2</span> <span class="o">-</span> <span class="n">k</span><span class="o">*</span><span class="n">omega</span> <span class="o">-</span> <span class="mi">1</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div>

<div class="viewcode-block" id="KFfilter.tdfilter"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.KFfilter.tdfilter">[docs]</a>    <span class="k">def</span> <span class="nf">tdfilter</span><span class="p">(</span><span class="bp">self</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">20</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">6</span><span class="p">):</span>
<span class="w">        </span><span class="sd">&quot;&quot;&quot;KTH05 TD-type filter.</span>

<span class="sd">        Arguments:</span>

<span class="sd">           &#39;fmin/fmax&#39; -- unit is cycle per day</span>

<span class="sd">           &#39;kmin/kmax&#39; -- zonal wave number. negative is westward, positive is</span>
<span class="sd">                          eastward</span>
<span class="sd">        &quot;&quot;&quot;</span>
        <span class="n">fftdata</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">fftdata</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">knum</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">knum</span>
        <span class="n">freq</span> <span class="o">=</span> <span class="bp">self</span><span class="o">.</span><span class="n">freq</span>
        <span class="n">nf</span><span class="p">,</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">nk</span> <span class="o">=</span> <span class="n">fftdata</span><span class="o">.</span><span class="n">shape</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">nf</span><span class="p">,</span><span class="n">nk</span><span class="p">),</span> <span class="n">dtype</span><span class="o">=</span><span class="n">numpy</span><span class="o">.</span><span class="n">bool</span><span class="p">)</span>

        <span class="c1">#wavenumber cut-off</span>
        <span class="k">if</span> <span class="n">kmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">knum</span> <span class="o">&lt;</span> <span class="n">kmin</span><span class="p">)</span> 
        <span class="k">if</span> <span class="n">kmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">kmax</span> <span class="o">&lt;</span> <span class="n">knum</span><span class="p">)</span>

        <span class="c1">#frequency cutoff</span>
        <span class="k">if</span> <span class="n">fmin</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">freq</span> <span class="o">&lt;</span> <span class="n">fmin</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">fmax</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="n">fmax</span> <span class="o">&lt;</span> <span class="n">freq</span><span class="p">)</span>

        <span class="c1">#dispersion filter</span>
        <span class="n">mask</span> <span class="o">=</span> <span class="n">mask</span> <span class="o">|</span> <span class="p">(</span><span class="mi">84</span><span class="o">*</span><span class="n">freq</span><span class="o">+</span><span class="n">knum</span><span class="o">-</span><span class="mi">22</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="mi">210</span><span class="o">*</span><span class="n">freq</span><span class="o">+</span><span class="mf">2.5</span><span class="o">*</span><span class="n">knum</span><span class="o">-</span><span class="mi">13</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">)</span>                                                                                         
        <span class="n">mask</span> <span class="o">=</span> <span class="n">numpy</span><span class="o">.</span><span class="n">repeat</span><span class="p">(</span><span class="n">mask</span><span class="p">[:,</span><span class="n">NA</span><span class="p">,:],</span> <span class="n">nlat</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

        <span class="n">fftdata</span><span class="p">[</span><span class="n">mask</span><span class="p">]</span> <span class="o">=</span> <span class="mf">0.0</span>

        <span class="n">filterd</span> <span class="o">=</span> <span class="n">fftpack</span><span class="o">.</span><span class="n">ifft2</span><span class="p">(</span><span class="n">fftdata</span><span class="p">,</span> <span class="n">axes</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="k">return</span> <span class="n">filterd</span><span class="o">.</span><span class="n">real</span></div></div>




<span class="c1"># from - https://stackoverflow.com/questions/19412462/getting-distance-between-two-points-based-on-latitude-longitude</span>
<div class="viewcode-block" id="DistanceCoord"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.DistanceCoord">[docs]</a><span class="k">def</span> <span class="nf">DistanceCoord</span><span class="p">(</span><span class="n">Lo1</span><span class="p">,</span><span class="n">La1</span><span class="p">,</span><span class="n">Lo2</span><span class="p">,</span><span class="n">La2</span><span class="p">):</span>

    <span class="kn">from</span> <span class="nn">math</span> <span class="kn">import</span> <span class="n">sin</span><span class="p">,</span> <span class="n">cos</span><span class="p">,</span> <span class="n">sqrt</span><span class="p">,</span> <span class="n">atan2</span><span class="p">,</span> <span class="n">radians</span>

    <span class="c1"># approximate radius of earth in km</span>
    <span class="n">R</span> <span class="o">=</span> <span class="mf">6373.0</span>

    <span class="n">lat1</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">La1</span><span class="p">)</span>
    <span class="n">lon1</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">Lo1</span><span class="p">)</span>
    <span class="n">lat2</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">La2</span><span class="p">)</span>
    <span class="n">lon2</span> <span class="o">=</span> <span class="n">radians</span><span class="p">(</span><span class="n">Lo2</span><span class="p">)</span>

    <span class="n">dlon</span> <span class="o">=</span> <span class="n">lon2</span> <span class="o">-</span> <span class="n">lon1</span>
    <span class="n">dlat</span> <span class="o">=</span> <span class="n">lat2</span> <span class="o">-</span> <span class="n">lat1</span>

    <span class="n">a</span> <span class="o">=</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlat</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat1</span><span class="p">)</span> <span class="o">*</span> <span class="n">cos</span><span class="p">(</span><span class="n">lat2</span><span class="p">)</span> <span class="o">*</span> <span class="n">sin</span><span class="p">(</span><span class="n">dlon</span> <span class="o">/</span> <span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span>
    <span class="n">c</span> <span class="o">=</span> <span class="mi">2</span> <span class="o">*</span> <span class="n">atan2</span><span class="p">(</span><span class="n">sqrt</span><span class="p">(</span><span class="n">a</span><span class="p">),</span> <span class="n">sqrt</span><span class="p">(</span><span class="mi">1</span> <span class="o">-</span> <span class="n">a</span><span class="p">))</span>

    <span class="n">distance</span> <span class="o">=</span> <span class="n">R</span> <span class="o">*</span> <span class="n">c</span>
    <span class="k">return</span> <span class="n">distance</span></div>


<span class="kn">import</span> <span class="nn">cartopy.io.shapereader</span> <span class="k">as</span> <span class="nn">shpreader</span>
<span class="kn">import</span> <span class="nn">shapely.geometry</span> <span class="k">as</span> <span class="nn">sgeom</span>
<span class="kn">from</span> <span class="nn">shapely.ops</span> <span class="kn">import</span> <span class="n">unary_union</span>
<span class="kn">from</span> <span class="nn">shapely.prepared</span> <span class="kn">import</span> <span class="n">prep</span>

<span class="n">land_shp_fname</span> <span class="o">=</span> <span class="n">shpreader</span><span class="o">.</span><span class="n">natural_earth</span><span class="p">(</span><span class="n">resolution</span><span class="o">=</span><span class="s1">&#39;50m&#39;</span><span class="p">,</span>
                                       <span class="n">category</span><span class="o">=</span><span class="s1">&#39;physical&#39;</span><span class="p">,</span> <span class="n">name</span><span class="o">=</span><span class="s1">&#39;land&#39;</span><span class="p">)</span>

<span class="n">land_geom</span> <span class="o">=</span> <span class="n">unary_union</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">shpreader</span><span class="o">.</span><span class="n">Reader</span><span class="p">(</span><span class="n">land_shp_fname</span><span class="p">)</span><span class="o">.</span><span class="n">geometries</span><span class="p">()))</span>
<span class="n">land</span> <span class="o">=</span> <span class="n">prep</span><span class="p">(</span><span class="n">land_geom</span><span class="p">)</span>

<div class="viewcode-block" id="is_land"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.is_land">[docs]</a><span class="k">def</span> <span class="nf">is_land</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">):</span>
    <span class="k">return</span> <span class="n">land</span><span class="o">.</span><span class="n">contains</span><span class="p">(</span><span class="n">sgeom</span><span class="o">.</span><span class="n">Point</span><span class="p">(</span><span class="n">x</span><span class="p">,</span> <span class="n">y</span><span class="p">))</span></div>


<span class="c1"># https://stackoverflow.com/questions/13542855/algorithm-to-find-the-minimum-area-rectangle-for-given-points-in-order-to-comput/33619018#33619018</span>
<span class="kn">import</span> <span class="nn">numpy</span> <span class="k">as</span> <span class="nn">np</span>
<span class="kn">from</span> <span class="nn">scipy.spatial</span> <span class="kn">import</span> <span class="n">ConvexHull</span>

<div class="viewcode-block" id="minimum_bounding_rectangle"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.minimum_bounding_rectangle">[docs]</a><span class="k">def</span> <span class="nf">minimum_bounding_rectangle</span><span class="p">(</span><span class="n">points</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot;</span>
<span class="sd">    Find the smallest bounding rectangle for a set of points.</span>
<span class="sd">    Returns a set of points representing the corners of the bounding box.</span>

<span class="sd">    :param points: an nx2 matrix of coordinates</span>
<span class="sd">    :rval: an nx2 matrix of coordinates</span>
<span class="sd">    &quot;&quot;&quot;</span>
    <span class="kn">from</span> <span class="nn">scipy.ndimage.interpolation</span> <span class="kn">import</span> <span class="n">rotate</span>
    <span class="n">pi2</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">pi</span><span class="o">/</span><span class="mf">2.</span>

    <span class="c1"># get the convex hull for the points</span>
    <span class="n">hull_points</span> <span class="o">=</span> <span class="n">points</span><span class="p">[</span><span class="n">ConvexHull</span><span class="p">(</span><span class="n">points</span><span class="p">)</span><span class="o">.</span><span class="n">vertices</span><span class="p">]</span>

    <span class="c1"># calculate edge angles</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">hull_points</span><span class="p">)</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">edges</span> <span class="o">=</span> <span class="n">hull_points</span><span class="p">[</span><span class="mi">1</span><span class="p">:]</span> <span class="o">-</span> <span class="n">hull_points</span><span class="p">[:</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">edges</span><span class="p">)))</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">arctan2</span><span class="p">(</span><span class="n">edges</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">edges</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">])</span>

    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mod</span><span class="p">(</span><span class="n">angles</span><span class="p">,</span> <span class="n">pi2</span><span class="p">))</span>
    <span class="n">angles</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">angles</span><span class="p">)</span>

    <span class="c1"># find rotation matrices</span>
    <span class="c1"># XXX both work</span>
    <span class="n">rotations</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">vstack</span><span class="p">([</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="o">-</span><span class="n">pi2</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="o">+</span><span class="n">pi2</span><span class="p">),</span>
        <span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">angles</span><span class="p">)])</span><span class="o">.</span><span class="n">T</span>

    <span class="n">rotations</span> <span class="o">=</span> <span class="n">rotations</span><span class="o">.</span><span class="n">reshape</span><span class="p">((</span><span class="o">-</span><span class="mi">1</span><span class="p">,</span> <span class="mi">2</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>

    <span class="c1"># apply rotations to the hull</span>
    <span class="n">rot_points</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">(</span><span class="n">rotations</span><span class="p">,</span> <span class="n">hull_points</span><span class="o">.</span><span class="n">T</span><span class="p">)</span>

    <span class="c1"># find the bounding points</span>
    <span class="n">min_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">rot_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_x</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">rot_points</span><span class="p">[:,</span> <span class="mi">0</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">min_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">rot_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
    <span class="n">max_y</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">rot_points</span><span class="p">[:,</span> <span class="mi">1</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>

    <span class="c1"># find the box with the best area</span>
    <span class="n">areas</span> <span class="o">=</span> <span class="p">(</span><span class="n">max_x</span> <span class="o">-</span> <span class="n">min_x</span><span class="p">)</span> <span class="o">*</span> <span class="p">(</span><span class="n">max_y</span> <span class="o">-</span> <span class="n">min_y</span><span class="p">)</span>
    <span class="n">best_idx</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">argmin</span><span class="p">(</span><span class="n">areas</span><span class="p">)</span>

    <span class="c1"># return the best box</span>
    <span class="n">x1</span> <span class="o">=</span> <span class="n">max_x</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
    <span class="n">x2</span> <span class="o">=</span> <span class="n">min_x</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
    <span class="n">y1</span> <span class="o">=</span> <span class="n">max_y</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
    <span class="n">y2</span> <span class="o">=</span> <span class="n">min_y</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>
    <span class="n">r</span> <span class="o">=</span> <span class="n">rotations</span><span class="p">[</span><span class="n">best_idx</span><span class="p">]</span>

    <span class="n">rval</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">4</span><span class="p">,</span> <span class="mi">2</span><span class="p">))</span>
    <span class="n">rval</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">rval</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y2</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">rval</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">x2</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>
    <span class="n">rval</span><span class="p">[</span><span class="mi">3</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">dot</span><span class="p">([</span><span class="n">x1</span><span class="p">,</span> <span class="n">y1</span><span class="p">],</span> <span class="n">r</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">rval</span></div>



<span class="c1"># ================================================================================================</span>
<span class="c1"># ================================================================================================</span>

<div class="viewcode-block" id="MultiObjectIdentification"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.MultiObjectIdentification">[docs]</a><span class="k">def</span> <span class="nf">MultiObjectIdentification</span><span class="p">(</span>
    <span class="n">DATA_all</span><span class="p">,</span>                      <span class="c1"># matrix with data on common grid in the format [time,lat,lon,variable]</span>
                                   <span class="c1"># the variables are &#39;V850&#39; [m/s], &#39;U850&#39; [m/s], &#39;T850&#39; K, &#39;Q850&#39; g/kg, </span>
                                   <span class="c1"># &#39;SLP&#39; [Pa], &#39;IVTE&#39; [kg m-1 s-1], &#39;IVTN&#39; [kg m-1 s-1], &#39;PR&#39; [mm/time], &#39;BT&#39; [K]]</span>
                                   <span class="c1"># this order must be followed</span>
    <span class="n">Lon</span><span class="p">,</span>                           <span class="c1"># 2D longitude grid centers</span>
    <span class="n">Lat</span><span class="p">,</span>                           <span class="c1"># 2D latitude grid spacing</span>
    <span class="n">Time</span><span class="p">,</span>                          <span class="c1"># datetime vector of data</span>
    <span class="n">dT</span><span class="p">,</span>                            <span class="c1"># integer - temporal frequency of data [hour]</span>
    <span class="n">Mask</span><span class="p">,</span>                          <span class="c1"># mask with dimensions [lat,lon] defining analysis region</span>
    <span class="n">DataName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                 <span class="c1"># name of the common grid</span>
    <span class="n">OutputFolder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>               <span class="c1"># string containing the output directory path. Default is local directory</span>
    <span class="c1"># minimum precip. obj.</span>
    <span class="n">SmoothSigmaP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>              <span class="c1"># Gaussion std for precipitation smoothing</span>
    <span class="n">Pthreshold</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>                <span class="c1"># precipitation threshold [mm/h]</span>
    <span class="n">MinTimePR</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>                 <span class="c1"># minimum lifetime of precip. features in hours</span>
    <span class="n">MinAreaPR</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>              <span class="c1"># minimum area of precipitation features [km2]</span>
    <span class="c1"># minimum Moisture Stream </span>
    <span class="n">MinTimeMS</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>                 <span class="c1"># minimum lifetime for moisture stream [hours]</span>
    <span class="n">MinAreaMS</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>            <span class="c1"># mimimum area of moisture stream [km2]</span>
    <span class="n">MinMSthreshold</span> <span class="o">=</span> <span class="mf">0.13</span><span class="p">,</span>         <span class="c1"># treshold for moisture stream [g*m/g*s]</span>
    <span class="c1"># cyclone tracking</span>
    <span class="n">MinTimeCY</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>                <span class="c1"># minimum livetime of cyclones [hours]</span>
    <span class="n">MaxPresAnCY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span>              <span class="c1"># preshure thershold for cyclone anomaly [hPa]</span>
    <span class="c1"># anty cyclone tracking</span>
    <span class="n">MinTimeACY</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>               <span class="c1"># minimum livetime of anticyclone [hours]</span>
    <span class="n">MinPresAnACY</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>              <span class="c1"># preshure thershold for anti cyclone anomaly [hPa]</span>
    <span class="c1"># Frontal zones</span>
    <span class="n">MinAreaFR</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>             <span class="c1"># mimimum size of frontal zones [km2]</span>
    <span class="n">front_treshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>            <span class="c1"># threshold for masking frontal zones</span>
    <span class="c1"># Cloud tracking setup</span>
    <span class="n">SmoothSigmaC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>              <span class="c1"># standard deviation of Gaussian filter for cloud tracking</span>
    <span class="n">Cthreshold</span> <span class="o">=</span> <span class="mi">241</span><span class="p">,</span>              <span class="c1"># brightness temperature threshold for cloud tracking [K]</span>
    <span class="n">MinTimeC</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>                  <span class="c1"># mimimum livetime of ice cloud shields [hours]</span>
    <span class="n">MinAreaC</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">,</span>              <span class="c1"># mimimum area of ice cloud shields [km2]</span>
    <span class="c1"># AR tracking</span>
    <span class="n">IVTtrheshold</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>            <span class="c1"># Integrated water vapor transport threshold for AR detection [kg m-1 s-1]</span>
    <span class="n">MinTimeIVT</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>                <span class="c1"># minimum livetime of ARs [hours]</span>
    <span class="n">AR_MinLen</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>              <span class="c1"># mimimum length of an AR [km]</span>
    <span class="n">AR_Lat</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>                   <span class="c1"># AR centroids have to be poeward of this latitude</span>
    <span class="n">AR_width_lenght_ratio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>     <span class="c1"># mimimum length to width ratio of AR</span>
    <span class="c1"># TC detection</span>
    <span class="n">TC_Pmin</span> <span class="o">=</span> <span class="mi">995</span><span class="p">,</span>                 <span class="c1"># mimimum pressure for TC detection [hPa]</span>
    <span class="n">TC_lat_genesis</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>           <span class="c1"># maximum latitude for TC genesis [absolute degree latitude]</span>
    <span class="n">TC_lat_max</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>               <span class="c1"># maximum latitude for TC existance [absolute degree latitude]</span>
    <span class="n">TC_deltaT_core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1"># minimum degrees difference between TC core and surrounding [K]</span>
    <span class="n">TC_T850min</span> <span class="o">=</span> <span class="mi">285</span><span class="p">,</span>              <span class="c1"># minimum temperature of TC core at 850hPa [K]</span>
    <span class="n">TC_minBT</span> <span class="o">=</span> <span class="mi">241</span><span class="p">,</span>                <span class="c1"># minimum average cloud top brightness temperature [K]</span>
    <span class="c1"># MCs detection</span>
    <span class="n">MCS_Minsize</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>            <span class="c1"># minimum size of precipitation area [km2] </span>
    <span class="n">MCS_minPR</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>                 <span class="c1"># minimum precipitation threshold [mm/h]</span>
    <span class="n">CL_MaxT</span> <span class="o">=</span> <span class="mi">215</span><span class="p">,</span>                 <span class="c1"># minimum brightness temperature in ice shield [K]</span>
    <span class="n">CL_Area</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">,</span>               <span class="c1"># minimum cloud area size [km2]</span>
    <span class="n">MCS_minTime</span> <span class="o">=</span> <span class="mi">4</span>                <span class="c1"># minimum lifetime of MCS [hours]</span>
    <span class="p">):</span>
    
    <span class="n">Variables</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;V850&#39;</span><span class="p">,</span> <span class="s1">&#39;U850&#39;</span><span class="p">,</span> <span class="s1">&#39;T850&#39;</span><span class="p">,</span> <span class="s1">&#39;Q850&#39;</span><span class="p">,</span> <span class="s1">&#39;SLP-1&#39;</span><span class="p">,</span> <span class="s1">&#39;IVTE-1&#39;</span><span class="p">,</span> <span class="s1">&#39;IVTN-1&#39;</span><span class="p">,</span><span class="s1">&#39;Z500&#39;</span><span class="p">,</span><span class="s1">&#39;V200&#39;</span><span class="p">,</span><span class="s1">&#39;U200&#39;</span><span class="p">,</span> <span class="s1">&#39;PR-1&#39;</span><span class="p">,</span> <span class="s1">&#39;BT-1&#39;</span><span class="p">]</span>
    <span class="c1"># calculate grid spacing assuming regular lat/lon grid</span>
    <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">Area</span><span class="p">,</span><span class="n">Gridspacing</span> <span class="o">=</span> <span class="n">calc_grid_distance_area</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span><span class="p">)</span>
    <span class="n">Area</span><span class="p">[</span><span class="n">Area</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    
    <span class="n">EarthCircum</span> <span class="o">=</span> <span class="mi">40075000</span> <span class="c1">#[m]</span>
    <span class="n">dLat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Lon</span><span class="p">);</span> <span class="n">dLat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">EarthCircum</span><span class="o">/</span><span class="p">(</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Lat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">dLon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Lon</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dLon</span><span class="p">[</span><span class="n">la</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">EarthCircum</span><span class="o">/</span><span class="p">(</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Lat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="n">la</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
<span class="c1">#     Gridspacing = np.abs(np.mean(np.append(dLat[:,:,None],dLon[:,:,None], axis=2)))</span>
<span class="c1">#     Area = dLat*dLon</span>
<span class="c1">#     Area[Area &lt; 0] = 0</span>
    
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">StartDay</span> <span class="o">=</span> <span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="n">SetupString</span> <span class="o">=</span> <span class="s1">&#39;_dt-&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dT</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;h_MOAAP-masks.nc&#39;</span>
    <span class="n">FrontMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Mask</span><span class="p">)</span>
    <span class="n">FrontMask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># connect over date line?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">176</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">176</span><span class="p">):</span>
        <span class="n">connectLon</span><span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">connectLon</span><span class="o">=</span> <span class="mi">0</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Derive nescessary varialbes for feature indentification&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># 11111111111111111111111111111111111111111111111111</span>
    <span class="c1"># calculate vapor transport on pressure level</span>
    <span class="n">VapTrans</span> <span class="o">=</span> <span class="p">((</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U850&#39;</span><span class="p">)]</span><span class="o">*</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Q850&#39;</span><span class="p">)])</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;V850&#39;</span><span class="p">)]</span><span class="o">*</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Q850&#39;</span><span class="p">)])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>

    <span class="c1"># 22222222222222222222222222222222222222222222222222</span>
    <span class="c1"># Frontal Detection according to https://agupubs.onlinelibrary.wiley.com/doi/full/10.1002/2017GL073662</span>
    <span class="n">UU</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U850&#39;</span><span class="p">)]</span>
    <span class="n">VV</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;V850&#39;</span><span class="p">)]</span>
    <span class="n">dx</span> <span class="o">=</span> <span class="n">dLon</span>
    <span class="n">dy</span> <span class="o">=</span> <span class="n">dLat</span>
    <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">UU</span> <span class="p">)</span>
    <span class="n">dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">VV</span> <span class="p">)</span>
    <span class="n">PV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">dv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dx</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">du</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">dy</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="p">)</span>
    <span class="n">TK</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;T850&#39;</span><span class="p">)]</span>
    <span class="n">vgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">TK</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">Tgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vgrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vgrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

    <span class="n">Fstar</span> <span class="o">=</span> <span class="n">PV</span> <span class="o">*</span> <span class="n">Tgrad</span>

    <span class="n">Tgrad_zero</span> <span class="o">=</span> <span class="mf">0.45</span> <span class="c1">#*100/(np.mean([dLon,dLat], axis=0)/1000.)  # 0.45 K/(100 km)</span>
    <span class="kn">import</span> <span class="nn">metpy.calc</span> <span class="k">as</span> <span class="nn">calc</span>
    <span class="kn">from</span> <span class="nn">metpy.units</span> <span class="kn">import</span> <span class="n">units</span>
    <span class="n">CoriolisPar</span> <span class="o">=</span> <span class="n">calc</span><span class="o">.</span><span class="n">coriolis_parameter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Lat</span><span class="p">))</span>
    <span class="n">Frontal_Diagnostic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Fstar</span><span class="o">/</span><span class="p">(</span><span class="n">CoriolisPar</span> <span class="o">*</span> <span class="n">Tgrad_zero</span><span class="p">))</span>

    <span class="c1"># # 3333333333333333333333333333333333333333333333333333</span>
    <span class="c1"># # Cyclone identification based on pressure annomaly threshold    </span>
    
    <span class="n">SLP</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SLP-1&#39;</span><span class="p">)]</span><span class="o">/</span><span class="mf">100.</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">SLP</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># remove high-frequency variabilities --&gt; smooth over 100 x 100 km (no temporal smoothing)</span>
        <span class="n">SLP_smooth</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">SLP</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="c1"># smoothign over 3000 x 3000 km and 78 hours</span>
        <span class="n">SLPsmoothAn</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">SLP</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this code takes care of the smoothing of fields that contain NaN values</span>
        <span class="c1"># from - https://stackoverflow.com/questions/18697532/gaussian-filtering-a-image-with-nan-in-python</span>
        <span class="n">U</span><span class="o">=</span><span class="n">SLP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>               <span class="c1"># random array...</span>
        <span class="n">V</span><span class="o">=</span><span class="n">SLP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
        <span class="n">W</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">U</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">W</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">WW</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
        <span class="n">SLPsmoothAn</span><span class="o">=</span><span class="n">VV</span><span class="o">/</span><span class="n">WW</span>

        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="n">WW</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="n">SLP_smooth</span> <span class="o">=</span> <span class="n">VV</span><span class="o">/</span><span class="n">WW</span>

    <span class="n">SLP_Anomaly</span> <span class="o">=</span> <span class="n">SLP_smooth</span><span class="o">-</span><span class="n">SLPsmoothAn</span>
    <span class="n">SLP_Anomaly</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="c1"># plt.contour(SLP_Anomaly[tt,:,:], levels=[-9990,-10,1100], colors=&#39;b&#39;)</span>
    <span class="n">Pressure_anomaly</span> <span class="o">=</span> <span class="n">SLP_Anomaly</span> <span class="o">&lt;</span> <span class="n">MaxPresAnCY</span> <span class="c1"># 10 hPa depression | original setting was 12</span>
    <span class="n">HighPressure_annomaly</span> <span class="o">=</span> <span class="n">SLP_Anomaly</span> <span class="o">&gt;</span> <span class="n">MinPresAnACY</span> <span class="c1">#12</span>

    <span class="c1"># from - https://stackoverflow.com/questions/18697532/gaussian-filtering-a-image-with-nan-in-python</span>
    <span class="n">sigma</span><span class="o">=</span><span class="mf">10.0</span>                  <span class="c1"># standard deviation for Gaussian kernel</span>
    <span class="n">truncate</span><span class="o">=</span><span class="mf">10.</span>                <span class="c1"># truncate filter at this many sigmas</span>

    <span class="n">U</span><span class="o">=</span><span class="n">SLP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>               <span class="c1"># random array...</span>

    <span class="n">V</span><span class="o">=</span><span class="n">SLP</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">VV</span><span class="o">=</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="p">[</span><span class="n">sigma</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">sigma</span><span class="p">],</span><span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">)</span>

    <span class="n">W</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">U</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
    <span class="n">W</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">WW</span><span class="o">=</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span><span class="n">sigma</span><span class="o">=</span><span class="p">[</span><span class="n">sigma</span><span class="p">,</span><span class="n">sigma</span><span class="p">,</span><span class="n">sigma</span><span class="p">],</span><span class="n">truncate</span><span class="o">=</span><span class="n">truncate</span><span class="p">)</span>

    <span class="n">Z</span><span class="o">=</span><span class="n">VV</span><span class="o">/</span><span class="n">WW</span>


    <span class="c1"># 4444444444444444444444444444444444444444444444444444444</span>
    <span class="c1"># calculate IVT</span>
    <span class="n">IVT</span> <span class="o">=</span> <span class="p">((</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IVTE-1&#39;</span><span class="p">)])</span><span class="o">**</span><span class="mi">2</span><span class="o">+</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;IVTN-1&#39;</span><span class="p">)])</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>

    <span class="c1"># Mask data outside of Focus domain</span>
    <span class="n">DATA_all</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">Pressure_anomaly</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">HighPressure_annomaly</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">Frontal_Diagnostic</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">VapTrans</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="n">SLP</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
    <span class="c1"># 5555555555555555555555555555555555555555555555555555555</span>
    <span class="c1"># Detect jet stream features</span>
    <span class="n">uv200</span> <span class="o">=</span> <span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U200&#39;</span><span class="p">)]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U200&#39;</span><span class="p">)]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span>
    
    <span class="c1"># 666666666666666666666666666666666666666666666666666666</span>
    <span class="c1"># Cyclone and cutoff low detection from 500 hPa Geopotential Heigth (Z500)</span>
    <span class="n">z500</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Z500&#39;</span><span class="p">)]</span><span class="o">/</span><span class="mf">9.81</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">z500</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="c1"># remove high-frequency variabilities --&gt; smooth over 100 x 100 km (no temporal smoothing)</span>
        <span class="n">z500_smooth</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">z500</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="c1"># smoothign over 3000 x 3000 km and 78 hours</span>
        <span class="n">z500smoothAn</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">z500</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this code takes care of the smoothing of fields that contain NaN values</span>
        <span class="c1"># from - https://stackoverflow.com/questions/18697532/gaussian-filtering-a-image-with-nan-in-python</span>
        <span class="n">U</span><span class="o">=</span><span class="n">z500</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>               <span class="c1"># random array...</span>
        <span class="n">V</span><span class="o">=</span><span class="n">z500</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
        <span class="n">W</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">U</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">W</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">WW</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
        <span class="n">z500smoothAn</span><span class="o">=</span><span class="n">VV</span><span class="o">/</span><span class="n">WW</span>

        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="n">WW</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="n">z500_smooth</span> <span class="o">=</span> <span class="n">VV</span><span class="o">/</span><span class="n">WW</span>
    
    <span class="n">z500_Anomaly</span> <span class="o">=</span> <span class="n">z500_smooth</span> <span class="o">-</span> <span class="n">z500smoothAn</span>
    <span class="n">z500_Anomaly</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    
<span class="c1">#     # remove high-frequency variabilities --&gt; smooth over 100 x 100 km (no temporal smoothing)</span>
<span class="c1">#     z500_smooth = ndimage.uniform_filter(z500, size=[1,int(100/(Gridspacing/1000.)),int(100/(Gridspacing/1000.))])</span>
<span class="c1">#     # smoothign over 3000 x 3000 km and 78 hours</span>
<span class="c1">#     z500smoothAn = ndimage.uniform_filter(z500, size=[int(78/dT),int(int(3000/(Gridspacing/1000.))),int(int(3000/(Gridspacing/1000.)))])</span>
<span class="c1">#     z500_Anomaly = z500_smooth - z500smoothAn</span>
<span class="c1">#     z500_Anomaly[:,Mask == 0] = np.nan</span>

    <span class="n">z_low</span> <span class="o">=</span> <span class="n">z500_Anomaly</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">80</span>
    <span class="n">z_high</span> <span class="o">=</span> <span class="n">z500_Anomaly</span> <span class="o">&gt;</span> <span class="mi">70</span>
    
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track  moisture streams in extratropics&#39;</span><span class="p">)</span>
    <span class="n">potARs</span> <span class="o">=</span> <span class="p">(</span><span class="n">VapTrans</span> <span class="o">&gt;</span> <span class="n">MinMSthreshold</span><span class="p">)</span>
    <span class="n">rgiObjectsAR</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">potARs</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="c1"># sort the objects according to their size</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsAR</span><span class="p">)</span>

    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">:]][</span><span class="n">rgiObjectsAR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgiObjectsAR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>

    <span class="c1"># create final object array</span>
    <span class="n">MS_objectsTMP</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsAR</span><span class="p">);</span> <span class="n">MS_objectsTMP</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">)):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MinAreaMS</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">)):</span>
            <span class="n">MS_objectsTMP</span><span class="p">[</span><span class="n">rgiObjectsAR</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># lable the objects from 1 to N</span>
    <span class="c1"># MS_objects=np.copy(rgiObjectsAR); MS_objects[:]=0</span>
    <span class="c1"># Unique = np.unique(MS_objectsTMP)[1:]</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(Unique)):</span>
    <span class="c1">#     MS_objects[MS_objectsTMP == Unique[ob]] = ii</span>
    <span class="c1">#     ii = ii + 1</span>

    <span class="n">MS_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">MS_objectsTMP</span><span class="p">,</span>
                                  <span class="n">dT</span><span class="p">,</span>
                               <span class="n">min_tsteps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living MS objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">MS_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect MS objects over date line&#39;</span><span class="p">)</span>
        <span class="n">MS_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">)</span>


    <span class="n">grMSs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">VapTrans</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;MS850_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>


    <span class="c1">#### ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track  IVT&#39;</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

    <span class="n">potIVTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">IVT</span> <span class="o">&gt;</span> <span class="n">IVTtrheshold</span><span class="p">)</span>
    <span class="n">rgiObjectsIVT</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">potIVTs</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="c1"># # sort the objects according to their size</span>
    <span class="c1"># Objects=ndimage.find_objects(rgiObjectsIVT)</span>
    <span class="c1"># # rgiVolObj=np.array([np.sum(rgiObjectsIVT[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>
    <span class="c1"># TT_CY = np.array([Objects[ob][0].stop - Objects[ob][0].start for ob in range(nr_objectsUD)])</span>

    <span class="c1"># # create final object array</span>
    <span class="c1"># IVT_objectsTMP=np.copy(rgiObjectsIVT); IVT_objectsTMP[:]=0</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(TT_CY)):</span>
    <span class="c1">#     if TT_CY[ob] &gt;= int(MinTimeIVT/dT):</span>
    <span class="c1">#         IVT_objectsTMP[rgiObjectsIVT == (ob+1)] = ii</span>
    <span class="c1">#         ii = ii + 1</span>
    <span class="c1"># # lable the objects from 1 to N</span>
    <span class="c1"># IVT_objects=np.copy(rgiObjectsIVT); IVT_objects[:]=0</span>
    <span class="c1"># Unique = np.unique(IVT_objectsTMP)[1:]</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(Unique)):</span>
    <span class="c1">#     IVT_objects[IVT_objectsTMP == Unique[ob]] = ii</span>
    <span class="c1">#     ii = ii + 1</span>

    <span class="n">IVT_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsIVT</span><span class="p">,</span>
                                   <span class="n">dT</span><span class="p">,</span>
                            <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living IVT objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">IVT_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect IVT objects over date line&#39;</span><span class="p">)</span>
        <span class="n">IVT_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">)</span>

    <span class="n">grIVTs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">IVT</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;IVT_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    check if MSs quallify as ARs&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="k">if</span> <span class="n">IVT_objects</span><span class="o">.</span><span class="n">max</span><span class="p">()</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">AR_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">);</span> <span class="n">AR_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">IVT_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">AR_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">);</span> <span class="n">AR_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
        <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">MS_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">IVT_objects</span> <span class="o">=</span> <span class="n">MS_objects</span>
    <span class="n">aa</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">IVT_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="c1"># check if object crosses the date line</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">OBJ_max_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">PointsObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LonObj</span><span class="p">[</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">LatObj</span><span class="p">[</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Hull</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">ConvexHull</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PointsObj</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">XX</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">YY</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">simplex</span> <span class="ow">in</span> <span class="n">Hull</span><span class="o">.</span><span class="n">simplices</span><span class="p">:</span>
    <span class="c1">#                 plt.plot(PointsObj[simplex, 0], PointsObj[simplex, 1], &#39;k-&#39;)</span>
                <span class="n">XX</span> <span class="o">=</span> <span class="n">XX</span> <span class="o">+</span> <span class="p">[</span><span class="n">PointsObj</span><span class="p">[</span><span class="n">simplex</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> 
                <span class="n">YY</span> <span class="o">=</span> <span class="n">YY</span> <span class="o">+</span> <span class="p">[</span><span class="n">PointsObj</span><span class="p">[</span><span class="n">simplex</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">[[</span><span class="n">XX</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">YY</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">YY</span><span class="p">))]</span>
            <span class="n">BOX</span> <span class="o">=</span> <span class="n">minimum_bounding_rectangle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PointsObj</span><span class="p">))</span>

            <span class="n">DIST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">DIST</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span> <span class="o">=</span> <span class="n">DistanceCoord</span><span class="p">(</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">OBJ_max_len</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">DIST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">OBJ_max_len</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">AR_MinLen</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rgiCenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">LatCent</span> <span class="o">=</span> <span class="n">LatObj</span><span class="p">[</span><span class="n">rgiCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rgiCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LatCent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">AR_Lat</span><span class="p">:</span>
                    <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># check width to lenght ratio</span>
            <span class="k">if</span> <span class="n">DIST</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">DIST</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">AR_width_lenght_ratio</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span> <span class="o">+</span> <span class="n">AR_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="n">AR_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ObjACT</span>
        <span class="n">aa</span><span class="o">=</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span>

    <span class="n">grACs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">AR_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                         <span class="n">IVT</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                         <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;ARs_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                         <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                         <span class="n">Gridspacing</span><span class="p">,</span>
                         <span class="n">Area</span><span class="p">)</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track cyclones&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1">#     Pressure_anomaly[np.isnan(Pressure_anomaly)] = 0</span>
    <span class="n">Pressure_anomaly</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Pressure_anomaly</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="c1"># # sort the objects according to their size</span>
    <span class="c1"># Objects=ndimage.find_objects(rgiObjectsUD)</span>
    <span class="c1"># rgiVolObj=np.array([np.sum(rgiObjectsUD[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>
    <span class="c1"># TT_CY = np.array([Objects[ob][0].stop - Objects[ob][0].start for ob in range(nr_objectsUD)])</span>

    <span class="c1"># # create final object array</span>
    <span class="c1"># CY_objectsTMP=np.copy(rgiObjectsUD); CY_objectsTMP[:]=0</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(rgiVolObj)):</span>
    <span class="c1">#     if TT_CY[ob] &gt;= int(MinTimeCY/dT):</span>
    <span class="c1">#         CY_objectsTMP[rgiObjectsUD == (ob+1)] = ii</span>
    <span class="c1">#         ii = ii + 1</span>

    <span class="c1"># # lable the objects from 1 to N</span>
    <span class="c1"># CY_objects=np.copy(rgiObjectsUD); CY_objects[:]=0</span>
    <span class="c1"># Unique = np.unique(CY_objectsTMP)[1:]</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(Unique)):</span>
    <span class="c1">#     CY_objects[CY_objectsTMP == Unique[ob]] = ii</span>
    <span class="c1">#     ii = ii + 1</span>

    <span class="n">CY_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                  <span class="n">dT</span><span class="p">,</span>
                            <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">CY_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">CY_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">)</span>


    <span class="n">grCyclonesPT</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">SLP</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;CY_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>



    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track anti-cyclones&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">HighPressure_annomaly</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">HighPressure_annomaly</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="c1"># # sort the objects according to their size</span>
    <span class="c1"># Objects=ndimage.find_objects(rgiObjectsUD)</span>
    <span class="c1"># rgiVolObj=np.array([np.sum(rgiObjectsUD[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>
    <span class="c1"># TT_ACY = np.array([Objects[ob][0].stop - Objects[ob][0].start for ob in range(nr_objectsUD)])</span>

    <span class="c1"># # create final object array</span>
    <span class="c1"># ACY_objectsTMP=np.copy(rgiObjectsUD); ACY_objectsTMP[:]=0</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(rgiVolObj)):</span>
    <span class="c1">#     if TT_ACY[ob] &gt;= MinTimeACY:</span>
    <span class="c1"># #     if rgiVolObj[ob] &gt;= MinVol:</span>
    <span class="c1">#         ACY_objectsTMP[rgiObjectsUD == (ob+1)] = ii</span>
    <span class="c1">#         ii = ii + 1</span>

    <span class="c1"># # lable the objects from 1 to N</span>
    <span class="c1"># ACY_objects=np.copy(rgiObjectsUD); ACY_objects[:]=0</span>
    <span class="c1"># Unique = np.unique(ACY_objectsTMP)[1:]</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(Unique)):</span>
    <span class="c1">#     ACY_objects[ACY_objectsTMP == Unique[ob]] = ii</span>
    <span class="c1">#     ii = ii + 1</span>

    <span class="n">ACY_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                   <span class="n">dT</span><span class="p">,</span>
                            <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeACY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living ACY objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">ACY_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">ACY_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># connect objects over date line</span>
        <span class="n">ACY_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">ACY_objects</span><span class="p">)</span>

    <span class="n">grACyclonesPT</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">ACY_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">SLP</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;ACY_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track 500 hPa anticyclones&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1">#     Pressure_anomaly[np.isnan(Pressure_anomaly)] = 0</span>
    <span class="n">z_high</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">z_high</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="n">acy_z500_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">acy_z500_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">acy_z500_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">acy_z500_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">acy_z500_objects</span><span class="p">)</span>


    <span class="n">acy_z500_objects_characteristics</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">acy_z500_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">z500</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;CY-z500_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
    
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track 500 hPa cyclones&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1">#     Pressure_anomaly[np.isnan(Pressure_anomaly)] = 0</span>
    <span class="n">z_low</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">z_low</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="n">cy_z500_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">cy_z500_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">cy_z500_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">)</span>


    <span class="n">cy_z500_objects_characteristics</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">z500</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;CY-z500_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
    
    <span class="c1"># Check if cyclones are cutoff lows</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Check if cyclones qualify as Cut Off Low (COL)&#39;</span><span class="p">)</span>
    <span class="c1">### COL detection is similar to https://journals.ametsoc.org/view/journals/clim/33/6/jcli-d-19-0497.1.xml</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">col_Tracks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">col_Time</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">aa</span><span class="o">=</span><span class="mi">1</span>
    <span class="c1"># area arround cyclone</span>
    <span class="n">col_buffer</span> <span class="o">=</span> <span class="mi">500000</span> <span class="c1"># m</span>

    <span class="c1"># check if cyclone is COL</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">col_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">);</span> <span class="n">col_obj</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">u200</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;U200&#39;</span><span class="p">)]</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">cy_z500_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MinTimeC</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">dxObj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]))</span>
        <span class="n">dyObj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dy</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]))</span>
        <span class="n">col_buffer_obj_lo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_buffer</span><span class="o">/</span><span class="n">dxObj</span><span class="p">)</span>
        <span class="n">col_buffer_obj_la</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_buffer</span><span class="o">/</span><span class="n">dyObj</span><span class="p">)</span>

        <span class="c1"># add buffer to object slice</span>
        <span class="n">tt_start</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
        <span class="n">tt_stop</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">lo_start</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">col_buffer_obj_lo</span> 
        <span class="n">lo_stop</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span>
        <span class="n">la_start</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">col_buffer_obj_la</span> 
        <span class="n">la_stop</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span>
        <span class="k">if</span> <span class="n">lo_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lo_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">lo_stop</span> <span class="o">&gt;=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">lo_stop</span> <span class="o">=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">la_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">la_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">la_stop</span> <span class="o">&gt;=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">la_stop</span> <span class="o">=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>

        <span class="n">z500_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z500</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">])</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">cy_z500_objects</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">u200_ob</span> <span class="o">=</span> <span class="n">u200</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="n">front_ob</span> <span class="o">=</span> <span class="n">Frontal_Diagnostic</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">LonObj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">358</span><span class="p">:</span>
            <span class="n">sift_lo</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
            <span class="c1"># object crosses the date line</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">LonObj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">LonObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">LonObj</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">LatObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">LatObj</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z500_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">z500_ACT</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">u200_ob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">u200_ob</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">front_ob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">front_ob</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sift_lo</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>

        <span class="c1"># find location of z500 minimum</span>
        <span class="n">z500_ACT_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z500_ACT</span><span class="p">)</span>
        <span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">999999999999.</span>

        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">min_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">]))</span>
            <span class="n">min_la</span> <span class="o">=</span> <span class="n">min_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">min_lo</span> <span class="o">=</span> <span class="n">min_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">la_0</span> <span class="o">=</span> <span class="n">min_la</span> <span class="o">-</span> <span class="n">col_buffer_obj_la</span>
            <span class="k">if</span> <span class="n">la_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">la_0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lo_0</span> <span class="o">=</span> <span class="n">min_lo</span> <span class="o">-</span> <span class="n">col_buffer_obj_lo</span>
            <span class="k">if</span> <span class="n">lo_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo_0</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">lat_reg</span> <span class="o">=</span> <span class="n">LatObj</span><span class="p">[</span><span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lon_reg</span> <span class="o">=</span> <span class="n">LonObj</span><span class="p">[</span><span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">col_region</span> <span class="o">=</span> <span class="n">z500_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obj_col_region</span> <span class="o">=</span> <span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">min_z500_obj</span> <span class="o">=</span> <span class="n">z500_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">min_la</span><span class="p">,</span><span class="n">min_lo</span><span class="p">]</span>
            <span class="n">u200_ob_region</span> <span class="o">=</span> <span class="n">u200_ob</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">front_ob_region</span> <span class="o">=</span> <span class="n">front_ob</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


            <span class="c1"># check if 350 km radius arround center has higher Z</span>
            <span class="n">min_loc_tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obj_col_region</span><span class="p">[:,:]</span> <span class="o">==</span> 
                                  <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">]))</span>
            <span class="n">min_la_tt</span> <span class="o">=</span> <span class="n">min_loc_tt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">min_lo_tt</span> <span class="o">=</span> <span class="n">min_loc_tt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">rdist</span> <span class="o">=</span> <span class="n">radialdistance</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">],</span>
                                   <span class="n">lon_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">],</span>
                                   <span class="n">lat_reg</span><span class="p">,</span>
                                   <span class="n">lon_reg</span><span class="p">)</span>

            <span class="c1"># COL should only occure between 20 and 70 degrees</span>
            <span class="c1"># https://journals.ametsoc.org/view/journals/clim/33/6/jcli-d-19-0497.1.xml</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">):</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># remove cyclones that are close to the poles</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">88</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
                <span class="c1"># there is no object to process</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># CRITERIA 1) at least 75 % of grid cells in ring have have 10 m higher Z than center</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdist</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">350</span> <span class="o">-</span> <span class="p">(</span><span class="n">dxObj</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>  <span class="o">&amp;</span> <span class="p">(</span><span class="n">rdist</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">350</span> <span class="o">+</span> <span class="p">(</span><span class="n">dxObj</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">min_z500_obj</span> <span class="o">-</span> <span class="n">col_region</span><span class="p">[</span><span class="n">ring</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">*</span><span class="mf">0.75</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># CRITERIA 2) check if 200 hPa wind speed is eastward in the poleward direction of the cyclone</span>
            <span class="k">if</span> <span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">east_flow</span> <span class="o">=</span> <span class="n">u200_ob_region</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">min_la_tt</span><span class="p">,</span>
                                    <span class="n">min_lo_tt</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">east_flow</span> <span class="o">=</span> <span class="n">u200_ob_region</span><span class="p">[</span><span class="n">min_la_tt</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">min_lo_tt</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">east_flow</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># Criteria 3) frontal zone in eastern flank of COL</span>
            <span class="n">front_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">front_ob_region</span><span class="p">[:,</span> <span class="n">min_lo_tt</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">front_test</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">sift_lo</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span> <span class="o">+</span> <span class="n">col_obj</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="n">col_obj</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjACT</span>

    <span class="n">col_stats</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">col_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                         <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Z500&#39;</span><span class="p">)],</span>         <span class="c1"># original file used for feature detection</span>
                         <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;COL_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                         <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                         <span class="n">Gridspacing</span><span class="p">,</span>
                         <span class="n">Area</span><span class="p">,</span>
                         <span class="n">min_tsteps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      <span class="c1"># minimum livetime in hours</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="c1"># ---------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track jetstream&#39;</span><span class="p">)</span>

    <span class="n">MinTimeJS</span> <span class="o">=</span> <span class="mi">24</span> <span class="c1"># hours</span>
    <span class="n">js_min_anomaly</span> <span class="o">=</span> <span class="mi">22</span>

    
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">uv200</span><span class="p">))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">uv200_smooth</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">uv200</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="c1"># smoothign over 3000 x 3000 km and 78 hours</span>
        <span class="n">uv200smoothAn</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">uv200</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># this code takes care of the smoothing of fields that contain NaN values</span>
        <span class="c1"># from - https://stackoverflow.com/questions/18697532/gaussian-filtering-a-image-with-nan-in-python</span>
        <span class="n">U</span><span class="o">=</span><span class="n">uv200</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>               <span class="c1"># random array...</span>
        <span class="n">V</span><span class="o">=</span><span class="n">uv200</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
        <span class="n">W</span><span class="o">=</span><span class="mi">0</span><span class="o">*</span><span class="n">U</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">W</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span><span class="o">=</span><span class="mi">0</span>
        <span class="n">WW</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))),</span><span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))])</span>
        <span class="n">uv200smoothAn</span><span class="o">=</span><span class="n">VV</span><span class="o">/</span><span class="n">WW</span>

        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="n">WW</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)),</span><span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))])</span>
        <span class="n">uv200_smooth</span> <span class="o">=</span> <span class="n">VV</span><span class="o">/</span><span class="n">WW</span>
    
    <span class="n">uv200_Anomaly</span> <span class="o">=</span> <span class="n">uv200_smooth</span> <span class="o">-</span> <span class="n">uv200smoothAn</span>
    <span class="n">jet</span> <span class="o">=</span> <span class="n">uv200_Anomaly</span><span class="p">[:,:,:]</span> <span class="o">&gt;=</span> <span class="n">js_min_anomaly</span>


    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1">#     Pressure_anomaly[np.isnan(Pressure_anomaly)] = 0</span>
    <span class="n">jet</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="n">jet_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeJS</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">jet_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">jet_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">jet_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">jet_objects</span><span class="p">)</span>


    <span class="n">jet_objects_characteristics</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">jet_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">uv200</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;jet_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
    
    <span class="c1">### Identify Frontal regions</span>
    <span class="c1"># ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    identify frontal zones&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">rgiObj_Struct_Fronts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct_Fronts</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">Frontal_Diagnostic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Frontal_Diagnostic</span><span class="p">)</span>
    <span class="n">Frontal_Diagnostic</span><span class="p">[:,</span><span class="n">FrontMask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">Fmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Frontal_Diagnostic</span> <span class="o">&gt;</span> <span class="n">front_treshold</span><span class="p">)</span>

    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Fmask</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct_Fronts</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="c1"># # calculate object size</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">)</span>
    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">:]][</span><span class="n">rgiObjectsUD</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>

    <span class="c1"># rgiAreaObj=np.array([np.sum(rgiObjectsUD[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>
    <span class="c1"># create final object array</span>
    <span class="n">FR_objects</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">)</span>
    <span class="n">TooSmall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rgiAreaObj</span> <span class="o">&lt;</span> <span class="n">MinAreaFR</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
    <span class="n">FR_objects</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">FR_objects</span><span class="p">,</span> <span class="n">TooSmall</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#     FR_objects=np.copy(rgiObjectsUD); FR_objects[:]=0</span>
    <span class="c1">#     ii = 1</span>
    <span class="c1">#     for ob in range(len(rgiAreaObj)):</span>
    <span class="c1">#         if rgiAreaObj[ob] &gt;= MinAreaFR*1000**2:</span>
    <span class="c1">#             FR_objects[rgiObjectsUD == (ob+1)] = ii</span>
    <span class="c1">#             ii = ii + 1</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


    <span class="c1"># ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track  precipitation&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">PRsmooth</span><span class="o">=</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)],</span> <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SmoothSigmaP</span><span class="p">,</span><span class="n">SmoothSigmaP</span><span class="p">))</span>
    <span class="n">PRmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRsmooth</span> <span class="o">&gt;=</span> <span class="n">Pthreshold</span><span class="o">*</span><span class="n">dT</span><span class="p">)</span>
    <span class="n">rgiObjectsPR</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">PRmask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; precipitation object found&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># connect objects over date line</span>
        <span class="n">rgiObjectsPR</span> <span class="o">=</span> <span class="n">ConnectLon</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">)</span>

    <span class="c1"># remove None objects</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">)</span>
    <span class="n">rgiVolObj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>
    <span class="n">ZERO_V</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rgiVolObj</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZERO_V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Dummy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">Objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">ZERO_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">Objects</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dummy</span>

    <span class="c1"># Remove objects that are too small or short lived</span>
    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">2</span><span class="p">]][</span><span class="n">rgiObjectsPR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>
    <span class="c1"># create final object array</span>
    <span class="n">PR_objects</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">);</span> <span class="n">PR_objects</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">)):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MinAreaPR</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">)):</span>
            <span class="n">PR_objects</span><span class="p">[</span><span class="n">rgiObjectsPR</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living precipitation objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">PR_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect precipitation objects over date line&#39;</span><span class="p">)</span>
        <span class="n">PR_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">)</span>

    <span class="n">grPRs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)],</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;PR_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


    <span class="c1"># ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track  clouds&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">Csmooth</span><span class="o">=</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BT-1&#39;</span><span class="p">)],</span> <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SmoothSigmaC</span><span class="p">,</span><span class="n">SmoothSigmaC</span><span class="p">))</span>
    <span class="n">Cmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Csmooth</span> <span class="o">&lt;=</span> <span class="n">Cthreshold</span><span class="p">)</span>
    <span class="n">rgiObjectsC</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Cmask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cloud object found&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># connect objects over date line</span>
        <span class="n">rgiObjectsC</span> <span class="o">=</span> <span class="n">ConnectLon</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">)</span>

    <span class="c1"># minimum cloud volume</span>
    <span class="c1"># sort the objects according to their size</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">)</span>

    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">2</span><span class="p">]][</span><span class="n">rgiObjectsC</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>

    <span class="c1"># rgiVolObjC=np.array([np.sum(rgiObjectsC[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>

    <span class="c1"># create final object array</span>
    <span class="n">C_objects</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">);</span> <span class="n">C_objects</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">)):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MinAreaC</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">)):</span>
        <span class="c1"># if rgiVolObjC[ob] &gt;= MinAreaC:</span>
            <span class="n">C_objects</span><span class="p">[</span><span class="n">rgiObjectsC</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living cloud shield objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">C_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">C_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cloud objects over date line&#39;</span><span class="p">)</span>
        <span class="n">C_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">C_objects</span><span class="p">)</span>

    <span class="n">grCs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">C_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BT-1&#39;</span><span class="p">)],</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;Clouds_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    
    

    <span class="c1"># ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    check if pr objects quallify as MCS&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># check if precipitation object is from an MCS</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">PR_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">MCS_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">);</span> <span class="n">MCS_obj</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">PR_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">window_length</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">Cloud_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">C_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>   
        <span class="n">Area_ACT</span> <span class="o">=</span> <span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">PR_ACT</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)][</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>

        <span class="n">PR_Size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area_ACT</span><span class="p">[</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="n">PR_MAX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PR_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PR_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="c1"># Get cloud shield</span>
        <span class="n">rgiCL_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Cloud_ACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgiCL_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no deep cloud shield is over the precipitation</span>
            <span class="k">continue</span>
        <span class="n">CL_OB_TMP</span> <span class="o">=</span> <span class="n">C_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">CLOUD_obj_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">CL_OB_TMP</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">rgiCL_obj</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">CL_OB_TMP</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">Cloud_Size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">CLOUD_obj_act</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">CLOUD_obj_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="c1"># min temperatur must be taken over precip area</span>
    <span class="c1">#     CL_ob_pr = C_objects[Objects[ii]]</span>
        <span class="n">CL_BT_pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BT-1&#39;</span><span class="p">)][</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">CL_BT_pr</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">Cloud_MinT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">CL_BT_pr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1">#     Cloud_MinT = np.array([np.min(CL_BT_pr[tt,CL_ob_pr[tt,:,:] &gt;0]) if len(CL_ob_pr[tt,CL_ob_pr[tt,:,:] &gt;0]) &gt; 0 else 0 for tt in range(CL_ob_pr.shape[0])])</span>
        <span class="n">Cloud_MinT</span><span class="p">[</span><span class="n">Cloud_MinT</span> <span class="o">&lt;</span> <span class="mi">150</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># is precipitation associated with AR?</span>
        <span class="n">AR_ob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">AR_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">AR_ob</span><span class="p">[:,</span><span class="n">LatObj</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># only consider ARs in mid- and hight latitudes</span>
        <span class="n">AR_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">AR_ob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>            

        <span class="n">MCS_max_residence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="c1"># MCS criterion must be meet within this time window</span>
                               <span class="c1"># or MCS is discontinued</span>
        <span class="c1"># minimum lifetime peak precipitation</span>
        <span class="n">is_pr_peak_intense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                                        <span class="n">PR_MAX</span> <span class="o">&gt;=</span> <span class="n">MCS_minPR</span><span class="o">*</span><span class="n">dT</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c1"># minimum precipitation area threshold</span>
        <span class="n">is_pr_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">PR_Size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">MCS_Minsize</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">window_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c1"># Tb size and time threshold</span>
        <span class="n">is_Tb_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">Cloud_Size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">CL_Area</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">window_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c1"># Tb overshoot</span>
        <span class="n">is_Tb_overshoot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                            <span class="n">Cloud_MinT</span>  <span class="o">&lt;=</span> <span class="n">CL_MaxT</span><span class="p">,</span> 
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MCS_test</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">is_pr_peak_intense</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_pr_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_Tb_area</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_Tb_overshoot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">MCS_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">MCS_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>

        

        <span class="c1"># assign unique object numbers</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1">#         # remove all precip that is associated with ARs</span>
    <span class="c1">#         ObjACT[AR_test &gt; 0] = 0</span>

    <span class="c1">#     # PR area defines MCS area and precipitation</span>
    <span class="c1">#     window_length = int(MCS_minTime/dT)</span>
    <span class="c1">#     cumulative_sum = np.cumsum(np.insert(MCS_TEST, 0, 0))</span>
    <span class="c1">#     moving_averages = (cumulative_sum[window_length:] - cumulative_sum[:-window_length]) / window_length</span>
    <span class="c1">#     if ob == 16:</span>
    <span class="c1">#         stop()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">MCS_test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MCS_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">TMP</span> <span class="o">+</span> <span class="n">ObjACT</span>
            <span class="n">MCS_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">TMP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
    
    <span class="n">MCS_obj</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">MCS_obj</span><span class="p">,</span>
                                   <span class="n">dT</span><span class="p">,</span>
                            <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>        
    
    <span class="n">grMCSs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">MCS_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                             <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)],</span>         <span class="c1"># original file used for feature detection</span>
                             <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;MCSs_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                             <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                             <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                             <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                             <span class="n">Gridspacing</span><span class="p">,</span>
                             <span class="n">Area</span><span class="p">)</span>
    
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
    
    <span class="c1">###########################################################</span>
    <span class="c1">###########################################################</span>
    <span class="c1"># TRACK MCSs AS TB SHIELDS</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; check if Tb objects quallify as MCS (or selected storm type)&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="n">bt_data</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BT-1&#39;</span><span class="p">)]</span>
    <span class="c1"># check if precipitation object is from an MCS</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">)</span>
    <span class="n">MCS_objects_Tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span> <span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>
    
    

    <span class="k">for</span> <span class="n">iobj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">object_indices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">time_slice</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lon_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">tb_object_slice</span><span class="o">=</span> <span class="n">rgiObjectsC</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">tb_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tb_object_slice</span><span class="o">==</span><span class="n">iobj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb_object_act</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MCS_minTime</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">tb_slice</span> <span class="o">=</span>  <span class="n">bt_data</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">tb_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tb_slice</span><span class="p">)</span>
        <span class="n">tb_act</span><span class="p">[</span><span class="o">~</span><span class="n">tb_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">bt_object_slice</span> <span class="o">=</span> <span class="n">rgiObjectsC</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">bt_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bt_object_slice</span><span class="p">)</span>
        <span class="n">bt_object_act</span><span class="p">[</span><span class="o">~</span><span class="n">tb_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">area_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">lat_slice</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">],</span> <span class="p">(</span><span class="n">tb_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">area_act</span><span class="p">[</span><span class="o">~</span><span class="n">tb_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">### Calculate cloud properties</span>
        <span class="n">tb_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">area_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">tb_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">tb_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1">### Calculate precipitation properties</span>
        <span class="n">pr_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)][</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>
        <span class="n">pr_act</span><span class="p">[</span><span class="n">tb_object_act</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">pr_peak_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">pr_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

        <span class="n">pr_region_act</span> <span class="o">=</span> <span class="n">pr_act</span> <span class="o">&gt;=</span> <span class="n">Pthreshold</span><span class="o">*</span><span class="n">dT</span>
        <span class="n">area_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">lat_slice</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">],</span> <span class="p">(</span><span class="n">tb_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">area_act</span><span class="p">[</span><span class="o">~</span><span class="n">pr_region_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pr_under_cloud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">area_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> 


        <span class="c1"># Test if object classifies as MCS</span>
        <span class="n">tb_size_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">tb_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">CL_Area</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">MCS_minTime</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">tb_overshoot_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">tb_min</span>  <span class="o">&lt;=</span> <span class="n">CL_MaxT</span> <span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">pr_peak_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">pr_peak_act</span> <span class="o">&gt;=</span> <span class="n">MCS_minPR</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">MCS_minTime</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span>
        <span class="n">pr_area_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">pr_under_cloud</span> <span class="o">&gt;=</span> <span class="n">MCS_Minsize</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">MCS_test</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">tb_size_test</span>
                    <span class="o">&amp;</span> <span class="n">tb_overshoot_test</span>
                    <span class="o">&amp;</span> <span class="n">pr_peak_test</span>
                    <span class="o">&amp;</span> <span class="n">pr_area_test</span>
        <span class="p">)</span>

        <span class="c1"># assign unique object numbers</span>
        <span class="n">tb_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tb_object_act</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">tb_object_act</span><span class="p">[</span><span class="n">tb_object_act</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iobj</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1">#         window_length = int(MCS_minTime / dT)</span>
<span class="c1">#         moving_averages = np.convolve(MCS_test, np.ones(window_length), &#39;valid&#39;) / window_length</span>

    <span class="c1">#     if iobj+1 == 19:</span>
    <span class="c1">#         stop()</span>
        <span class="k">if</span> <span class="n">MCS_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MCS_objects_Tb</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">TMP</span> <span class="o">+</span> <span class="n">tb_object_act</span>
            <span class="n">MCS_objects_Tb</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span> <span class="o">=</span> <span class="n">TMP</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Calculate cloud characteristics: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">MCS_objects_Tb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">MCS_objects_Tb</span><span class="p">,</span>
                                       <span class="n">dT</span><span class="p">,</span>
                                       <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>  


    <span class="c1">#if len(objects_overlap)&gt;1: import pdb; pdb.set_trace()</span>
    <span class="c1"># objects_id_MCS, num_objects = ndimage.label(MCS_objects_Tb, structure=obj_structure_3D)</span>
    <span class="n">grMCSs_Tb</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span>
        <span class="n">MCS_objects_Tb</span><span class="p">,</span>  <span class="c1"># feature object file</span>
        <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)],</span>  <span class="c1"># original file used for feature detection</span>
        <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;MCSs_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="o">+</span><span class="s1">&#39;_Tb.pkl&#39;</span><span class="p">,</span>
        <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
        <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
        <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
        <span class="n">Gridspacing</span><span class="p">,</span>
        <span class="n">Area</span><span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;MCS Tb tracking: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>


    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="c1"># ------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Check if cyclones qualify as TCs&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">TC_Tracks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">TC_Time</span> <span class="o">=</span> <span class="p">{}</span>
<span class="c1">#     aa=1</span>
    <span class="c1"># check if cyclone is tropical</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">CY_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">TC_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">);</span> <span class="n">TC_obj</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">CY_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">T_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">TK</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">SLP_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">SLP</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="c1"># check if object crosses the date line</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">SLP_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">SLP_ACT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Calculate low pressure center track</span>
        <span class="n">SLP_ACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">999999999.</span>
        <span class="n">Track_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">SLP_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">SLP_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="n">LatLonTrackAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">LatObj</span><span class="p">[</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span><span class="n">LonObj</span><span class="p">[</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">TC_lat_genesis</span><span class="p">:</span>
            <span class="n">ObjACT</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># has the cyclone a warm core?</span>
            <span class="n">DeltaTCore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="n">DeltaTCore</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">T850_core</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DeltaTCore</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">T_cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">T850_core</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_cent</span>
                <span class="n">T_Cyclone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1">#                     T_Cyclone = np.mean(T_ACT[tt,MassC[0]-5:MassC[0]+6,MassC[1]-5:MassC[1]+6])</span>
                <span class="n">DeltaTCore</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_cent</span><span class="o">-</span><span class="n">T_Cyclone</span>
            <span class="c1"># smooth the data</span>
            <span class="n">DeltaTCore</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">DeltaTCore</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">WarmCore</span> <span class="o">=</span> <span class="n">DeltaTCore</span> <span class="o">&gt;</span> <span class="n">TC_deltaT_core</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WarmCore</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">WarmCore</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># is the core temperature warm enough</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">T850_core</span> <span class="o">&lt;</span> <span class="n">TC_T850min</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>


            <span class="c1"># TC must have pressure of less 980 hPa</span>
            <span class="n">MinPress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">SLP_ACT</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">MinPress</span> <span class="o">&lt;</span> <span class="n">TC_Pmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># is the cloud shield cold enough?</span>
            <span class="n">PR_objACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
            <span class="n">BT_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BT-1&#39;</span><span class="p">)][</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
            <span class="n">BT_objMean</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">BT_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="n">BT_objMean</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">BT_objMean</span><span class="p">)):</span>
                <span class="k">try</span><span class="p">:</span>
                    <span class="n">BT_objMean</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmean</span><span class="p">(</span><span class="n">BT_act</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">PR_objACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
                <span class="k">except</span><span class="p">:</span>
                    <span class="k">continue</span>

            <span class="c1"># is cloud shild overlapping with TC?</span>
            <span class="n">BT_objACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">C_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
            <span class="n">bt_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">BT_objACT</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">kk</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span><span class="o">/</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">[</span><span class="mi">10</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="kc">True</span><span class="p">)</span> <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span> <span class="o">&gt;</span> <span class="mf">0.4</span>

        <span class="c1"># remove pieces of the track that are not TCs</span>
        <span class="n">TCcheck</span> <span class="o">=</span> <span class="p">(</span><span class="n">T850_core</span> <span class="o">&gt;</span> <span class="n">TC_T850min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WarmCore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MinPress</span> <span class="o">&lt;</span> <span class="n">TC_Pmin</span><span class="p">)</span> <span class="c1">#&amp; (bt_overlap == 1) #(BT_objMean &lt; TC_minBT)</span>
        <span class="n">LatLonTrackAct</span><span class="p">[</span><span class="n">TCcheck</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">Max_LAT</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span>  <span class="n">TC_lat_max</span><span class="p">)</span>
        <span class="n">LatLonTrackAct</span><span class="p">[</span><span class="n">Max_LAT</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># check if cyclone genesis is over water; each re-emergence of TC is a new genesis</span>
        <span class="n">resultLAT</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">g</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">resultLON</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">g</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">LS_genesis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">resultLAT</span><span class="p">)));</span> <span class="n">LS_genesis</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resultLAT</span><span class="p">)):</span>
            <span class="n">LS_genesis</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_land</span><span class="p">(</span><span class="n">resultLON</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">resultLAT</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LS_genesis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">LS_genesis</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">LS_genesis</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">SetNAN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">resultLAT</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                    <span class="n">LatLonTrackAct</span><span class="p">[</span><span class="n">SetNAN</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># make sure that only TC time slizes are considered</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),:,:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span> <span class="o">+</span> <span class="n">TC_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="n">TC_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ObjACT</span>
        <span class="n">TC_Tracks</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">LatLonTrackAct</span>
<span class="c1">#         aa=aa+1</span>
        
<span class="c1">#     TC_obj, _ = clean_up_objects(TC_obj,</span>
<span class="c1">#                                    dT)   </span>
    
    <span class="n">grTCs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">TC_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                             <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;SLP-1&#39;</span><span class="p">)],</span>         <span class="c1"># original file used for feature detection</span>
                             <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;TC_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                             <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                             <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                             <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                             <span class="n">Gridspacing</span><span class="p">,</span>
                             <span class="n">Area</span><span class="p">,</span>
                             <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Save the object masks into a joint netCDF&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># ============================</span>
    <span class="c1"># Write NetCDF</span>
    <span class="n">iTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">((</span><span class="n">Time</span> <span class="o">-</span> <span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">())</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">NCfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span> <span class="n">Lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;xc&#39;</span><span class="p">,</span> <span class="n">Lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">,))</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">,))</span>
    <span class="n">PR_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;PR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">PR_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;PR_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">MCSs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MCS_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">MCSs_Tb</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MCS_Tb_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Cloud_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;BT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Cloud_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;BT_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">FR_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;FR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">FR_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;FR_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">CY_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CY&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">CY_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CY_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">TCs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;TC_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ACY_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ACY_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">MS_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MS&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">MS_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MS_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">IVT_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;IVT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">IVT_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;IVT_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ARs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;AR_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">SLP_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;SLP&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">T_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;T850&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">CY_z500_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CY_z500&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">CY_z500_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CY_z500_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">ACY_z500_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ACY_z500_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">Z500_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Z500&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">COL</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;COL_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="n">JET</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;JET_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>

    <span class="n">times</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>
    <span class="n">times</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;seconds since &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:00&quot;</span>
    <span class="n">times</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    <span class="n">times</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>

    <span class="n">lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span> <span class="p">;</span>
    <span class="n">lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_north&quot;</span> <span class="p">;</span>
    <span class="n">lat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;latitude&quot;</span> <span class="p">;</span>

    <span class="n">lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span> <span class="p">;</span>
    <span class="n">lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_east&quot;</span> <span class="p">;</span>
    <span class="n">lon</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;longitude&quot;</span> <span class="p">;</span>

    <span class="n">PR_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">PR_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">MCSs</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">MCSs_Tb</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">FR_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">FR_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">CY_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">CY_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">ACY_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">SLP_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">T_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">Cloud_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">Cloud_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">MS_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">MS_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">IVT_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">IVT_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">ARs</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">TCs</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">CY_z500_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">CY_z500_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">ACY_z500_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">COL</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">Z500_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
    <span class="n">JET</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>

    <span class="n">lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Lat</span>
    <span class="n">lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Lon</span>
    <span class="n">PR_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;PR-1&#39;</span><span class="p">)]</span>
    <span class="n">PR_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">PR_objects</span>
    <span class="n">MCSs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MCS_obj</span>
    <span class="n">MCSs_Tb</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MCS_objects_Tb</span>
    <span class="n">FR_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Frontal_Diagnostic</span>
    <span class="n">FR_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">FR_objects</span>
    <span class="n">CY_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">SLP_Anomaly</span>
    <span class="n">CY_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">CY_objects</span>
    <span class="n">TCs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">TC_obj</span>
    <span class="n">ACY_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ACY_objects</span>
    <span class="n">SLP_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">SLP</span>
    <span class="n">T_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">TK</span>
    <span class="n">MS_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">VapTrans</span>
    <span class="n">MS_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MS_objects</span>
    <span class="n">IVT_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">IVT</span>
    <span class="n">IVT_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">IVT_objects</span>
    <span class="n">ARs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">AR_obj</span>
    <span class="n">Cloud_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;BT-1&#39;</span><span class="p">)]</span>
    <span class="n">Cloud_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">C_objects</span>
    <span class="n">CY_z500_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">z500</span>
    <span class="n">CY_z500_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">cy_z500_objects</span>
    <span class="n">ACY_z500_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">acy_z500_objects</span>
    <span class="n">COL</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">col_obj</span>
    <span class="n">Z500_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">DATA_all</span><span class="p">[:,:,:,</span><span class="n">Variables</span><span class="o">.</span><span class="n">index</span><span class="p">(</span><span class="s1">&#39;Z500&#39;</span><span class="p">)]</span>
    <span class="n">JET</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">jet_objects</span>
    <span class="n">times</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">iTime</span>

    <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved: &#39;</span><span class="o">+</span><span class="n">NCfile</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="c1">### SAVE THE TC TRACKS TO PICKL FILE</span>
    <span class="c1"># ============================</span>
    <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">OutputFolder</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_TCs_tracks.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
    <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">TC_Tracks</span><span class="p">,</span> <span class="n">a_file</span><span class="p">)</span>
    <span class="n">a_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span></div>
    <span class="c1"># CYCLONES[YYYY+MM] = TC_Tracks</span>
    

    
    
    
    
<span class="c1">############################################################</span>
<span class="c1">###########################################################</span>
<span class="c1">#### ======================================================</span>
<div class="viewcode-block" id="MCStracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.MCStracking">[docs]</a><span class="k">def</span> <span class="nf">MCStracking</span><span class="p">(</span>
    <span class="n">pr_data</span><span class="p">,</span>
    <span class="n">bt_data</span><span class="p">,</span>
    <span class="n">times</span><span class="p">,</span>
    <span class="n">Lon</span><span class="p">,</span>
    <span class="n">Lat</span><span class="p">,</span>
    <span class="n">nc_file</span><span class="p">,</span>
    <span class="n">DataOutDir</span><span class="p">,</span>
    <span class="n">DataName</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Function to track MCS from precipitation and brightness temperature</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="kn">import</span> <span class="nn">mcs_config</span> <span class="k">as</span> <span class="nn">cfg</span>
    <span class="kn">from</span> <span class="nn">skimage.measure</span> <span class="kn">import</span> <span class="n">regionprops</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1">#Reading tracking parameters</span>

    <span class="n">DT</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">DT</span>

    <span class="c1">#Precipitation tracking setup</span>
    <span class="n">smooth_sigma_pr</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">smooth_sigma_pr</span>   <span class="c1"># [0] Gaussion std for precipitation smoothing</span>
    <span class="n">thres_pr</span>        <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">thres_pr</span>     <span class="c1"># [2] precipitation threshold [mm/h]</span>
    <span class="n">min_time_pr</span>     <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">min_time_pr</span>     <span class="c1"># [3] minum lifetime of PR feature in hours</span>
    <span class="n">min_area_pr</span>     <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">min_area_pr</span>      <span class="c1"># [5000] minimum area of precipitation feature in km2</span>
    <span class="c1"># Brightness temperature (Tb) tracking setup</span>
    <span class="n">smooth_sigma_bt</span> <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">smooth_sigma_bt</span>   <span class="c1">#  [0] Gaussion std for Tb smoothing</span>
    <span class="n">thres_bt</span>        <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">thres_bt</span>     <span class="c1"># [241] minimum Tb of cloud shield</span>
    <span class="n">min_time_bt</span>     <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">min_time_bt</span>       <span class="c1"># [9] minium lifetime of cloud shield in hours</span>
    <span class="n">min_area_bt</span>     <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">min_area_bt</span>       <span class="c1"># [40000] minimum area of cloud shield in km2</span>
    <span class="c1"># MCs detection</span>
    <span class="n">MCS_min_pr_MajorAxLen</span>  <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MCS_min_pr_MajorAxLen</span>    <span class="c1"># [100] km | minimum length of major axis of precipitation object</span>
    <span class="n">MCS_thres_pr</span>       <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MCS_thres_pr</span>      <span class="c1"># [10] minimum max precipitation in mm/h</span>
    <span class="n">MCS_thres_peak_pr</span>   <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MCS_thres_peak_pr</span>  <span class="c1"># [10] Minimum lifetime peak of MCS precipitation</span>
    <span class="n">MCS_thres_bt</span>     <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MCS_thres_bt</span>        <span class="c1"># [225] minimum brightness temperature</span>
    <span class="n">MCS_min_area_bt</span>         <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MCS_min_area_bt</span>        <span class="c1"># [40000] min cloud area size in km2</span>
    <span class="n">MCS_min_time</span>     <span class="o">=</span> <span class="n">cfg</span><span class="o">.</span><span class="n">MCS_min_time</span>    <span class="c1"># [4] minimum time step</span>


    <span class="c1">#     DT = 1                    # temporal resolution of data for tracking in hours</span>

    <span class="c1">#     # MINIMUM REQUIREMENTS FOR FEATURE DETECTION</span>
    <span class="c1">#     # precipitation tracking options</span>
    <span class="c1">#     smooth_sigma_pr = 0          # Gaussion std for precipitation smoothing</span>
    <span class="c1">#     thres_pr = 2            # precipitation threshold [mm/h]</span>
    <span class="c1">#     min_time_pr = 3             # minum lifetime of PR feature in hours</span>
    <span class="c1">#     min_area_pr = 5000          # minimum area of precipitation feature in km2</span>

    <span class="c1">#     # Brightness temperature (Tb) tracking setup</span>
    <span class="c1">#     smooth_sigma_bt = 0          # Gaussion std for Tb smoothing</span>
    <span class="c1">#     thres_bt = 241          # minimum Tb of cloud shield</span>
    <span class="c1">#     min_time_bt = 9              # minium lifetime of cloud shield in hours</span>
    <span class="c1">#     min_area_bt = 40000          # minimum area of cloud shield in km2</span>

    <span class="c1">#     # MCs detection</span>
    <span class="c1">#     MCS_min_area = min_area_pr   # minimum area of MCS precipitation object in km2</span>
    <span class="c1">#     MCS_thres_pr = 10            # minimum max precipitation in mm/h</span>
    <span class="c1">#     MCS_thres_peak_pr = 10        # Minimum lifetime peak of MCS precipitation</span>
    <span class="c1">#     MCS_thres_bt = 225             # minimum brightness temperature</span>
    <span class="c1">#     MCS_min_area_bt = MinAreaC        # min cloud area size in km2</span>
    <span class="c1">#     MCS_min_time = 4           # minimum lifetime of MCS</span>

    <span class="c1">#Calculating grid distances and areas</span>

    <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">grid_cell_area</span><span class="p">,</span><span class="n">grid_spacing</span> <span class="o">=</span> <span class="n">calc_grid_distance_area</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span><span class="p">)</span>
    <span class="n">grid_cell_area</span><span class="p">[</span><span class="n">grid_cell_area</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="n">obj_structure_3D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>

    <span class="n">start_day</span> <span class="o">=</span> <span class="n">times</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>


    <span class="c1"># connect over date line?</span>
    <span class="n">crosses_dateline</span> <span class="o">=</span> <span class="kc">False</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">176</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span> <span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">176</span><span class="p">):</span>
        <span class="n">crosses_dateline</span> <span class="o">=</span> <span class="kc">True</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Initialize MCS tracking function: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># --------------------------------------------------------</span>
    <span class="c1"># TRACKING PRECIP OBJECTS</span>
    <span class="c1"># --------------------------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;        track  precipitation&quot;</span><span class="p">)</span>

    <span class="n">pr_smooth</span><span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span>
        <span class="n">pr_data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">smooth_sigma_pr</span><span class="p">,</span> <span class="n">smooth_sigma_pr</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">pr_mask</span> <span class="o">=</span> <span class="n">pr_smooth</span> <span class="o">&gt;=</span> <span class="n">thres_pr</span> <span class="o">*</span> <span class="n">DT</span>
    <span class="n">objects_id_pr</span><span class="p">,</span> <span class="n">num_objects</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">pr_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">obj_structure_3D</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_objects</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; precipitation object found&quot;</span><span class="p">)</span>

    <span class="c1"># connect objects over date line</span>
    <span class="k">if</span> <span class="n">crosses_dateline</span><span class="p">:</span>
        <span class="n">objects_id_pr</span> <span class="o">=</span> <span class="n">ConnectLon</span><span class="p">(</span><span class="n">objects_id_pr</span><span class="p">)</span>

    <span class="c1"># get indices of object to reduce memory requirements during manipulation</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">objects_id_pr</span><span class="p">)</span>


    <span class="c1">#Calcualte area of objects</span>
    <span class="n">area_objects</span> <span class="o">=</span> <span class="n">calculate_area_objects</span><span class="p">(</span><span class="n">objects_id_pr</span><span class="p">,</span><span class="n">object_indices</span><span class="p">,</span><span class="n">grid_cell_area</span><span class="p">)</span>

    <span class="c1"># Keep only large and long enough objects</span>
    <span class="c1"># Remove objects that are too small or short lived</span>
    <span class="n">pr_objects</span> <span class="o">=</span> <span class="n">remove_small_short_objects</span><span class="p">(</span><span class="n">objects_id_pr</span><span class="p">,</span><span class="n">area_objects</span><span class="p">,</span><span class="n">min_area_pr</span><span class="p">,</span><span class="n">min_time_pr</span><span class="p">,</span><span class="n">DT</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">)</span>

    <span class="n">grPRs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span>
        <span class="n">pr_objects</span><span class="p">,</span>  <span class="c1"># feature object file</span>
        <span class="n">pr_data</span><span class="p">,</span>  <span class="c1"># original file used for feature detection</span>
        <span class="n">DataOutDir</span><span class="o">+</span><span class="n">DataName</span><span class="o">+</span><span class="s2">&quot;_PR_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_day</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_day</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span>
        <span class="n">times</span><span class="p">,</span>  <span class="c1"># timesteps of the data</span>
        <span class="n">Lat</span><span class="p">,</span>  <span class="c1"># 2D latidudes</span>
        <span class="n">Lon</span><span class="p">,</span>  <span class="c1"># 2D Longitudes</span>
        <span class="n">grid_spacing</span><span class="p">,</span>
        <span class="n">grid_cell_area</span><span class="p">,</span>
        <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">min_time_pr</span><span class="o">/</span> <span class="n">DT</span><span class="p">),</span> <span class="c1"># minimum lifetime in data timesteps</span>
    <span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Tracking precip: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># --------------------------------------------------------</span>
    <span class="c1"># TRACKING CLOUD (BT) OBJECTS</span>
    <span class="c1"># --------------------------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            track  clouds&quot;</span><span class="p">)</span>
    <span class="n">bt_smooth</span> <span class="o">=</span> <span class="n">filters</span><span class="o">.</span><span class="n">gaussian_filter</span><span class="p">(</span>
        <span class="n">bt_data</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="n">smooth_sigma_bt</span><span class="p">,</span> <span class="n">smooth_sigma_bt</span><span class="p">)</span>
    <span class="p">)</span>
    <span class="n">bt_mask</span> <span class="o">=</span> <span class="n">bt_smooth</span> <span class="o">&lt;=</span> <span class="n">thres_bt</span>
    <span class="n">objects_id_bt</span><span class="p">,</span> <span class="n">num_objects</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">bt_mask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">obj_structure_3D</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            &quot;</span> <span class="o">+</span> <span class="nb">str</span><span class="p">(</span><span class="n">num_objects</span><span class="p">)</span> <span class="o">+</span> <span class="s2">&quot; cloud object found&quot;</span><span class="p">)</span>

    <span class="c1"># connect objects over date line</span>
    <span class="k">if</span> <span class="n">crosses_dateline</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            connect cloud objects over date line&quot;</span><span class="p">)</span>
        <span class="n">objects_id_bt</span> <span class="o">=</span> <span class="n">ConnectLon</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">)</span>

    <span class="c1"># get indices of object to reduce memory requirements during manipulation</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">)</span>

    <span class="c1">#Calcualte area of objects</span>
    <span class="n">area_objects</span> <span class="o">=</span> <span class="n">calculate_area_objects</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">,</span><span class="n">object_indices</span><span class="p">,</span><span class="n">grid_cell_area</span><span class="p">)</span>

    <span class="c1"># Keep only large and long enough objects</span>
    <span class="c1"># Remove objects that are too small or short lived</span>
    <span class="n">objects_id_bt</span> <span class="o">=</span> <span class="n">remove_small_short_objects</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">,</span><span class="n">area_objects</span><span class="p">,</span><span class="n">min_area_bt</span><span class="p">,</span><span class="n">min_time_bt</span><span class="p">,</span><span class="n">DT</span><span class="p">,</span> <span class="n">objects</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Tracking clouds: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            break up long living cloud shield objects that have many elements&quot;</span><span class="p">)</span>
    <span class="n">objects_id_bt</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">min_time_bt</span> <span class="o">/</span> <span class="n">DT</span><span class="p">),</span> <span class="n">DT</span><span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Breaking up cloud objects: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>

    <span class="n">grCs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span>
        <span class="n">objects_id_bt</span><span class="p">,</span>  <span class="c1"># feature object file</span>
        <span class="n">bt_data</span><span class="p">,</span>  <span class="c1"># original file used for feature detection</span>
        <span class="n">DataOutDir</span><span class="o">+</span><span class="n">DataName</span><span class="o">+</span><span class="s2">&quot;_BT_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_day</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_day</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span>
        <span class="n">times</span><span class="p">,</span>  <span class="c1"># timesteps of the data</span>
        <span class="n">Lat</span><span class="p">,</span>  <span class="c1"># 2D latidudes</span>
        <span class="n">Lon</span><span class="p">,</span>  <span class="c1"># 2D Longitudes</span>
        <span class="n">grid_spacing</span><span class="p">,</span>
        <span class="n">grid_cell_area</span><span class="p">,</span>
        <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">min_time_bt</span> <span class="o">/</span> <span class="n">DT</span><span class="p">),</span> <span class="c1"># minimum lifetime in data timesteps</span>
    <span class="p">)</span>
    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Calculate cloud characteristics: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="c1"># --------------------------------------------------------</span>
    <span class="c1"># CHECK IF PR OBJECTS QUALIFY AS MCS</span>
    <span class="c1"># (or selected strom type according to msc_config.py)</span>
    <span class="c1"># --------------------------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;            check if pr objects quallify as MCS (or selected storm type)&quot;</span><span class="p">)</span>
    <span class="c1"># check if precipitation object is from an MCS</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">pr_objects</span><span class="p">)</span>
    <span class="n">MCS_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">pr_objects</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iobj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="nb">enumerate</span><span class="p">(</span><span class="n">object_indices</span><span class="p">):</span>
        <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">time_slice</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lon_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>


        <span class="n">pr_object_slice</span><span class="o">=</span> <span class="n">pr_objects</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">pr_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">pr_object_slice</span><span class="o">==</span><span class="n">iobj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">pr_object_act</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">pr_slice</span> <span class="o">=</span>  <span class="n">pr_data</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">pr_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr_slice</span><span class="p">)</span>
        <span class="n">pr_act</span><span class="p">[</span><span class="o">~</span><span class="n">pr_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">bt_slice</span>  <span class="o">=</span> <span class="n">bt_data</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">bt_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bt_slice</span><span class="p">)</span>
        <span class="n">bt_act</span><span class="p">[</span><span class="o">~</span><span class="n">pr_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">bt_object_slice</span> <span class="o">=</span> <span class="n">objects_id_bt</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">bt_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bt_object_slice</span><span class="p">)</span>
        <span class="n">bt_object_act</span><span class="p">[</span><span class="o">~</span><span class="n">pr_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">area_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">grid_cell_area</span><span class="p">[</span><span class="n">lat_slice</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">],</span> <span class="p">(</span><span class="n">pr_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">area_act</span><span class="p">[</span><span class="o">~</span><span class="n">pr_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1">#     pr_size = np.array(np.sum(area_act,axis=(1,2)))</span>
        <span class="n">pr_max</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pr_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1"># calculate major axis length of PR object</span>
        <span class="n">pr_object_majoraxislen</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span>
                <span class="n">regionprops</span><span class="p">(</span><span class="n">pr_object_act</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">major_axis_length</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">area_act</span><span class="p">[</span><span class="n">tt</span><span class="p">,(</span><span class="n">pr_object_act</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)]</span><span class="o">/</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="mf">0.5</span> 
                <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">pr_object_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">])</span>

        <span class="c1">#Check overlaps between clouds (bt) and precip objects</span>
        <span class="n">objects_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">bt_object_act</span><span class="p">[</span><span class="n">pr_object_act</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>

        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">objects_overlap</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no deep cloud shield is over the precipitation</span>
            <span class="k">continue</span>

        <span class="c1">## Keep bt objects (entire) that partially overlap with pr object</span>

        <span class="n">bt_object_overlap</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">[</span><span class="n">time_slice</span><span class="p">]</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">objects_overlap</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">objects_id_bt</span><span class="p">[</span><span class="n">time_slice</span><span class="p">]</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>

        <span class="c1"># Get size of all cloud (bt) objects together</span>
        <span class="c1"># We get size of all cloud objects that overlap partially with pr object</span>
        <span class="c1"># DO WE REALLY NEED THIS?</span>

        <span class="n">bt_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span>
            <span class="p">[</span>
            <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">grid_cell_area</span><span class="p">[</span><span class="n">bt_object_overlap</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span> <span class="p">:,</span> <span class="p">:]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">bt_object_overlap</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
            <span class="p">]</span>
        <span class="p">)</span>

        <span class="c1">#Check if BT is below threshold over precip areas</span>
        <span class="n">bt_min_temp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">bt_object_slice</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">,</span><span class="n">bt_slice</span><span class="p">,</span><span class="mi">999</span><span class="p">),</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>

        <span class="c1"># minimum lifetime peak precipitation</span>
        <span class="n">is_pr_peak_intense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">pr_max</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="n">MCS_thres_peak_pr</span> <span class="o">*</span> <span class="n">DT</span>
        <span class="n">MCS_test</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="p">(</span><span class="n">bt_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">MCS_min_area_bt</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">bt_min_temp</span>  <span class="o">&lt;=</span> <span class="n">MCS_thres_bt</span> <span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pr_object_majoraxislen</span> <span class="o">&gt;=</span> <span class="n">MCS_min_pr_MajorAxLen</span> <span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">pr_max</span> <span class="o">&gt;=</span> <span class="n">MCS_thres_pr</span> <span class="o">*</span> <span class="n">DT</span><span class="p">)</span>
                    <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_pr_peak_intense</span><span class="p">)</span>
        <span class="p">)</span>

        <span class="c1"># assign unique object numbers</span>

        <span class="n">pr_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pr_object_act</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">pr_object_act</span><span class="p">[</span><span class="n">pr_object_act</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iobj</span> <span class="o">+</span> <span class="mi">1</span>

        <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCS_min_time</span> <span class="o">/</span> <span class="n">DT</span><span class="p">)</span>
        <span class="n">moving_averages</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">MCS_test</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">window_length</span>

    <span class="c1">#     if iobj+1 == 19:</span>
    <span class="c1">#         stop()</span>

        <span class="k">if</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">moving_averages</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">moving_averages</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">):</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MCS_objects</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">TMP</span> <span class="o">+</span> <span class="n">pr_object_act</span>
            <span class="n">MCS_objects</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span> <span class="o">=</span> <span class="n">TMP</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="c1">#if len(objects_overlap)&gt;1: import pdb; pdb.set_trace()</span>
    <span class="c1"># objects_id_MCS, num_objects = ndimage.label(MCS_objects, structure=obj_structure_3D)</span>
    <span class="n">grMCSs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span>
        <span class="n">MCS_objects</span><span class="p">,</span>  <span class="c1"># feature object file</span>
        <span class="n">pr_data</span><span class="p">,</span>  <span class="c1"># original file used for feature detection</span>
        <span class="n">DataOutDir</span><span class="o">+</span><span class="n">DataName</span><span class="o">+</span><span class="s2">&quot;_MCS_&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_day</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">start_day</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;.pkl&#39;</span><span class="p">,</span>
        <span class="n">times</span><span class="p">,</span>  <span class="c1"># timesteps of the data</span>
        <span class="n">Lat</span><span class="p">,</span>  <span class="c1"># 2D latidudes</span>
        <span class="n">Lon</span><span class="p">,</span>  <span class="c1"># 2D Longitudes</span>
        <span class="n">grid_spacing</span><span class="p">,</span>
        <span class="n">grid_cell_area</span><span class="p">,</span>
        <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MCS_min_time</span> <span class="o">/</span> <span class="n">DT</span><span class="p">),</span> <span class="c1"># minimum lifetime in data timesteps</span>
    <span class="p">)</span>

    <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;MCS tracking: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
    <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    

    <span class="c1">###########################################################</span>
    <span class="c1">###########################################################</span>
    <span class="c1">## WRite netCDF with xarray</span>
    <span class="k">if</span> <span class="n">nc_file</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="nb">print</span> <span class="p">(</span><span class="s1">&#39;Save objects into a netCDF&#39;</span><span class="p">)</span>

        <span class="n">fino</span><span class="o">=</span><span class="n">xr</span><span class="o">.</span><span class="n">Dataset</span><span class="p">({</span><span class="s1">&#39;MCS_objects&#39;</span><span class="p">:([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">MCS_objects</span><span class="p">),</span>
                         <span class="s1">&#39;PR&#39;</span><span class="p">:([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">pr_data</span><span class="p">),</span>
                         <span class="s1">&#39;PR_objects&#39;</span><span class="p">:([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">objects_id_pr</span><span class="p">),</span>
                         <span class="s1">&#39;BT&#39;</span><span class="p">:([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">bt_data</span><span class="p">),</span>
                         <span class="s1">&#39;BT_objects&#39;</span><span class="p">:([</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">objects_id_bt</span><span class="p">),</span>
                         <span class="s1">&#39;lat&#39;</span><span class="p">:([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">Lat</span><span class="p">),</span>
                         <span class="s1">&#39;lon&#39;</span><span class="p">:([</span><span class="s1">&#39;y&#39;</span><span class="p">,</span><span class="s1">&#39;x&#39;</span><span class="p">],</span><span class="n">Lon</span><span class="p">)},</span>
                         <span class="n">coords</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;time&#39;</span><span class="p">:</span><span class="n">times</span><span class="o">.</span><span class="n">values</span><span class="p">})</span>

        <span class="n">fino</span><span class="o">.</span><span class="n">to_netcdf</span><span class="p">(</span><span class="n">nc_file</span><span class="p">,</span><span class="n">mode</span><span class="o">=</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="n">encoding</span><span class="o">=</span><span class="p">{</span><span class="s1">&#39;PR&#39;</span><span class="p">:{</span><span class="s1">&#39;zlib&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;complevel&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                                                 <span class="s1">&#39;PR_objects&#39;</span><span class="p">:{</span><span class="s1">&#39;zlib&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;complevel&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                                                 <span class="s1">&#39;BT&#39;</span><span class="p">:{</span><span class="s1">&#39;zlib&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;complevel&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                                                 <span class="s1">&#39;BT_objects&#39;</span><span class="p">:{</span><span class="s1">&#39;zlib&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;complevel&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">},</span>
                                                 <span class="s1">&#39;MCS_objects&#39;</span><span class="p">:{</span><span class="s1">&#39;zlib&#39;</span><span class="p">:</span> <span class="kc">True</span><span class="p">,</span><span class="s1">&#39;complevel&#39;</span><span class="p">:</span> <span class="mi">5</span><span class="p">}})</span>


    <span class="c1"># fino = xr.Dataset({</span>
    <span class="c1"># &#39;MCS_objects&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = objects_id_MCS,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;time&#39;,&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &#39;Mesoscale Convective System objects&#39;,</span>
    <span class="c1">#                 &#39;units&#39;     : &#39;&#39;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1"># &#39;PR_objects&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = objects_id_pr,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;time&#39;,&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &#39;Precipitation objects&#39;,</span>
    <span class="c1">#                 &#39;units&#39;     : &#39;&#39;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1"># &#39;BT_objects&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = objects_id_bt,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;time&#39;,&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &#39;Cloud (brightness temperature) objects&#39;,</span>
    <span class="c1">#                 &#39;units&#39;     : &#39;&#39;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1"># &#39;PR&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = pr_data,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;time&#39;,&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &#39;Precipitation&#39;,</span>
    <span class="c1">#                 &#39;standard_name&#39;: &#39;precipitation&#39;,</span>
    <span class="c1">#                 &#39;units&#39;     : &#39;mm h-1&#39;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1"># &#39;BT&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = bt_data,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;time&#39;,&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &#39;Brightness temperature&#39;,</span>
    <span class="c1">#                 &#39;standard_name&#39;: &#39;brightness_temperature&#39;,</span>
    <span class="c1">#                 &#39;units&#39;     : &#39;K&#39;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1"># &#39;lat&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = Lat,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &quot;latitude&quot;,</span>
    <span class="c1">#                 &#39;standard_name&#39;: &quot;latitude&quot;,</span>
    <span class="c1">#                 &#39;units&#39;     : &quot;degrees_north&quot;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1"># &#39;lon&#39;: xr.DataArray(</span>
    <span class="c1">#             data   = Lon,   # enter data here</span>
    <span class="c1">#             dims   = [&#39;y&#39;,&#39;x&#39;],</span>
    <span class="c1">#             attrs  = {</span>
    <span class="c1">#                 &#39;_FillValue&#39;: const.missingval,</span>
    <span class="c1">#                 &#39;long_name&#39;: &quot;longitude&quot;,</span>
    <span class="c1">#                 &#39;standard_name&#39;: &quot;longitude&quot;,</span>
    <span class="c1">#                 &#39;units&#39;     : &quot;degrees_east&quot;,</span>
    <span class="c1">#                 }</span>
    <span class="c1">#             ),</span>
    <span class="c1">#         },</span>
    <span class="c1">#     attrs = {&#39;date&#39;:datetime.date.today().strftime(&#39;%Y-%m-%d&#39;),</span>
    <span class="c1">#              &quot;comments&quot;: &quot;File created with MCS_tracking&quot;},</span>
    <span class="c1">#     coords={&#39;time&#39;:times.values}</span>
    <span class="c1"># )</span>


    <span class="c1"># fino.to_netcdf(nc_file,mode=&#39;w&#39;,format = &quot;NETCDF4&quot;,</span>
    <span class="c1">#                encoding={&#39;PR&#39;:{&#39;zlib&#39;: True,&#39;complevel&#39;: 5},</span>
    <span class="c1">#                          &#39;PR_objects&#39;:{&#39;zlib&#39;: True,&#39;complevel&#39;: 5},</span>
    <span class="c1">#                          &#39;BT&#39;:{&#39;zlib&#39;: True,&#39;complevel&#39;: 5},</span>
    <span class="c1">#                          &#39;BT_objects&#39;:{&#39;zlib&#39;: True,&#39;complevel&#39;: 5}})</span>


        <span class="n">end_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;======&gt; &#39;Writing files: </span><span class="si">{</span><span class="p">(</span><span class="n">end_time</span><span class="o">-</span><span class="n">start_time</span><span class="p">)</span><span class="si">:</span><span class="s2">.2f</span><span class="si">}</span><span class="s2"> seconds </span><span class="se">\n</span><span class="s2">&quot;</span><span class="p">)</span>
        <span class="n">start_time</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">time</span><span class="p">()</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="sa">f</span><span class="s2">&quot;No writing files required, output file name is empty&quot;</span><span class="p">)</span>
    <span class="c1">###########################################################</span>
    <span class="c1">###########################################################</span>
    <span class="c1"># ============================</span>
    <span class="c1"># Write NetCDF</span>
    <span class="k">return</span> <span class="n">grMCSs</span><span class="p">,</span> <span class="n">MCS_objects</span></div>



<div class="viewcode-block" id="clean_up_objects"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.clean_up_objects">[docs]</a><span class="k">def</span> <span class="nf">clean_up_objects</span><span class="p">(</span><span class="n">DATA</span><span class="p">,</span>
                     <span class="n">dT</span><span class="p">,</span>
                     <span class="n">min_tsteps</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>
                     <span class="n">obj_splitmerge</span> <span class="o">=</span> <span class="kc">None</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Function to remove objects that are too short lived</span>
<span class="sd">        and to numerrate the object from 1...N</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
    <span class="n">MaxOb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
    <span class="n">MinLif</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="mi">24</span> <span class="o">/</span> <span class="n">dT</span><span class="p">)</span>  <span class="c1"># min lifetime of object to be split</span>
    <span class="n">AVmax</span> <span class="o">=</span> <span class="mf">1.5</span>

    <span class="n">id_translate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">object_indices</span><span class="p">),</span><span class="mi">2</span><span class="p">))</span>
    <span class="n">objectsTMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DATA</span><span class="p">)</span>
    <span class="n">objectsTMP</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">object_indices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">-</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">&gt;=</span> <span class="n">min_tsteps</span> <span class="o">/</span> <span class="n">dT</span><span class="p">:</span>
                <span class="n">Obj_tmp</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">objectsTMP</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]])</span>
                <span class="n">Obj_tmp</span><span class="p">[</span><span class="n">DATA</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span> <span class="o">==</span> <span class="n">obj</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>
                <span class="n">objectsTMP</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span> <span class="o">=</span> <span class="n">Obj_tmp</span>
                <span class="n">id_translate</span><span class="p">[</span><span class="n">obj</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">id_translate</span><span class="p">[</span><span class="n">obj</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span>
                <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">id_translate</span><span class="p">[</span><span class="n">obj</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">+</span><span class="mi">1</span>
                <span class="n">id_translate</span><span class="p">[</span><span class="n">obj</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">id_translate</span><span class="p">[</span><span class="n">obj</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">obj</span><span class="o">+</span><span class="mi">1</span>
            <span class="n">id_translate</span><span class="p">[</span><span class="n">obj</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="o">-</span><span class="mi">1</span>

    <span class="c1"># adjust the directory strucutre accordingly</span>
    <span class="n">obj_splitmerge_clean</span> <span class="o">=</span> <span class="p">{}</span>

    <span class="k">if</span> <span class="n">obj_splitmerge</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">id_translate</span> <span class="o">=</span> <span class="n">id_translate</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>  
        <span class="n">keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">obj_splitmerge</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)):</span>
            <span class="n">obj_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)[</span><span class="n">jj</span><span class="p">])</span> <span class="o">==</span> <span class="n">id_translate</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="k">if</span> <span class="n">id_translate</span><span class="p">[</span><span class="n">obj_loc</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span> <span class="o">==</span> <span class="o">-</span><span class="mi">1</span><span class="p">:</span>
                <span class="k">del</span> <span class="n">obj_splitmerge</span><span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)[</span><span class="n">jj</span><span class="p">]]</span>

        <span class="c1"># loop over objects and relable their indices if nescessary</span>
        <span class="n">obj_splitmerge_clean</span> <span class="o">=</span> <span class="p">{}</span>
        <span class="n">keys</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">obj_splitmerge</span><span class="o">.</span><span class="n">keys</span><span class="p">()))</span>
        <span class="n">core_translate</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">id_translate</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">keys</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
        <span class="n">id_translate</span> <span class="o">=</span> <span class="n">id_translate</span><span class="p">[</span><span class="n">core_translate</span><span class="p">,:]</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">keys</span><span class="p">)):</span>
            <span class="n">obj_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="nb">list</span><span class="p">(</span><span class="n">keys</span><span class="p">)[</span><span class="n">jj</span><span class="p">])</span> <span class="o">==</span> <span class="n">id_translate</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">mergsplit</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">obj_splitmerge</span><span class="p">[</span><span class="n">keys</span><span class="p">[</span><span class="n">jj</span><span class="p">]])</span>
            <span class="k">for</span> <span class="n">kk</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">id_translate</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">mergsplit</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">mergsplit</span><span class="p">,</span> <span class="n">id_translate</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="mi">0</span><span class="p">])]</span> <span class="o">=</span> <span class="n">id_translate</span><span class="p">[</span><span class="n">kk</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obj_splitmerge_clean</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">id_translate</span><span class="p">[</span><span class="n">obj_loc</span><span class="p">,</span><span class="mi">1</span><span class="p">]))]</span> <span class="o">=</span> <span class="n">mergsplit</span>
        
    <span class="k">return</span> <span class="n">objectsTMP</span><span class="p">,</span> <span class="n">obj_splitmerge_clean</span></div>


<div class="viewcode-block" id="overlapping_objects"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.overlapping_objects">[docs]</a><span class="k">def</span> <span class="nf">overlapping_objects</span><span class="p">(</span><span class="n">Object1</span><span class="p">,</span>
                     <span class="n">Object2</span><span class="p">,</span>
                     <span class="n">Data_to_mask</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Function that finds all Objects1 that overlap with </span>
<span class="sd">        objects in Object2</span>
<span class="sd">    &quot;&quot;&quot;</span>

    <span class="n">obj_structure_2D</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">))</span>
    <span class="n">obj_structure_2D</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="n">objects_id_1</span><span class="p">,</span> <span class="n">num_objects1</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Object1</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">),</span> <span class="n">structure</span><span class="o">=</span><span class="n">obj_structure_2D</span><span class="p">)</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">objects_id_1</span><span class="p">)</span>

    <span class="n">MaskedData</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Object1</span><span class="p">)</span>
    <span class="n">MaskedData</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="k">for</span> <span class="n">obj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">object_indices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]</span> <span class="o">!=</span> <span class="kc">None</span><span class="p">:</span>
            <span class="n">Obj1_tmp</span> <span class="o">=</span> <span class="n">Object1</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span>
            <span class="n">Obj2_tmp</span> <span class="o">=</span> <span class="n">Object2</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Obj1_tmp</span><span class="p">[</span><span class="n">Obj2_tmp</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">MaskedDataTMP</span> <span class="o">=</span> <span class="n">Data_to_mask</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span>
                <span class="n">MaskedDataTMP</span><span class="p">[</span><span class="n">Obj1_tmp</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="n">MaskedData</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">obj</span><span class="p">]]</span> <span class="o">=</span> <span class="n">MaskedDataTMP</span>
            
    <span class="k">return</span> <span class="n">MaskedData</span></div>


<div class="viewcode-block" id="smooth_uniform"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.smooth_uniform">[docs]</a><span class="k">def</span> <span class="nf">smooth_uniform</span><span class="p">(</span>
            <span class="n">data</span><span class="p">,</span>       <span class="c1"># matrix to smooth [time, lat, lon]</span>
            <span class="n">t_smoot</span><span class="p">,</span>    <span class="c1"># temporal window length [time steps]</span>
            <span class="n">xy_smooth</span><span class="p">,</span>  <span class="c1"># spatial window [grid cells]</span>
            <span class="p">):</span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    Function to spatiotemporal smooth atmospheric fiels even </span>
<span class="sd">    if they contain missing data</span>
<span class="sd">    &#39;&#39;&#39;</span>
    <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">data</span><span class="p">)</span><span class="o">.</span><span class="n">any</span><span class="p">()</span> <span class="o">==</span> <span class="kc">False</span><span class="p">:</span>
        <span class="n">smooth_data</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">data</span><span class="p">,</span> 
                                      <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t_smoot</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">xy_smooth</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">xy_smooth</span><span class="p">)])</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="c1"># smoothing with missing values</span>
        <span class="n">U</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V</span> <span class="o">=</span> <span class="n">data</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">V</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">VV</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">V</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t_smoot</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">xy_smooth</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">xy_smooth</span><span class="p">)])</span>
        <span class="n">W</span> <span class="o">=</span> <span class="mi">0</span><span class="o">*</span><span class="n">U</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">W</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">U</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">WW</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">uniform_filter</span><span class="p">(</span><span class="n">W</span><span class="p">,</span> <span class="n">size</span><span class="o">=</span><span class="p">[</span><span class="nb">int</span><span class="p">(</span><span class="n">t_smoot</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">xy_smooth</span><span class="p">),</span>
                                            <span class="nb">int</span><span class="p">(</span><span class="n">xy_smooth</span><span class="p">)])</span>
        <span class="n">smooth_data</span> <span class="o">=</span> <span class="n">VV</span><span class="o">/</span><span class="n">WW</span>
    <span class="k">return</span> <span class="n">smooth_data</span></div>



<div class="viewcode-block" id="jetstream_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.jetstream_tracking">[docs]</a><span class="k">def</span> <span class="nf">jetstream_tracking</span><span class="p">(</span>
                      <span class="n">uv200</span><span class="p">,</span>            <span class="c1"># wind speed at 200 hPa [m/s] - [time,lat,lon]</span>
                      <span class="n">js_min_anomaly</span><span class="p">,</span>   <span class="c1"># minimum anomaly to indeitify jet objects [m/s]</span>
                      <span class="n">MinTimeJS</span><span class="p">,</span>        <span class="c1"># minimum lifetime of jet objects [h]</span>
                      <span class="n">dT</span><span class="p">,</span>               <span class="c1"># data time step [h]</span>
                      <span class="n">Gridspacing</span><span class="p">,</span>
                      <span class="n">connectLon</span>
                      <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    function to track jetstream objects</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">uv200_smooth</span> <span class="o">=</span> <span class="n">smooth_uniform</span><span class="p">(</span><span class="n">uv200</span><span class="p">,</span>
                             <span class="mi">1</span><span class="p">,</span>
                             <span class="nb">int</span><span class="p">(</span><span class="mi">500</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))</span>
    <span class="n">uv200smoothAn</span> <span class="o">=</span> <span class="n">smooth_uniform</span><span class="p">(</span><span class="n">uv200</span><span class="p">,</span>
                                 <span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">5000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))))</span>

    <span class="n">uv200_Anomaly</span> <span class="o">=</span> <span class="n">uv200_smooth</span> <span class="o">-</span> <span class="n">uv200smoothAn</span>
    <span class="n">jet</span> <span class="o">=</span> <span class="n">uv200_Anomaly</span><span class="p">[:,:,:]</span> <span class="o">&gt;=</span> <span class="n">js_min_anomaly</span>


    <span class="c1">#     Pressure_anomaly[np.isnan(Pressure_anomaly)] = 0</span>
    <span class="c1">#     jet[:,Mask == 0] = 0</span>
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">jet</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="n">jet_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeJS</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">jet_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">jet_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeJS</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

<span class="c1">#     jet_objects, object_split = clean_up_objects(rgiObjectsUD,</span>
<span class="c1">#                                 min_tsteps=int(MinTimeJS/dT),</span>
<span class="c1">#                                 dT = dT,</span>
<span class="c1">#                                 obj_splitmerge = object_split)</span>
    
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">jet_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">jet_objects</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">jet_objects</span><span class="p">,</span> <span class="n">object_split</span></div>




<div class="viewcode-block" id="ar_850hpa_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ar_850hpa_tracking">[docs]</a><span class="k">def</span> <span class="nf">ar_850hpa_tracking</span><span class="p">(</span>
                    <span class="n">VapTrans</span><span class="p">,</span>        <span class="c1"># 850 hPa moisture flux [g/g m/s] - [time,lat,lon]</span>
                    <span class="n">MinMSthreshold</span><span class="p">,</span>
                    <span class="n">MinTimeMS</span><span class="p">,</span>
                    <span class="n">MinAreaMS</span><span class="p">,</span>
                    <span class="n">Area</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">connectLon</span>
                <span class="p">):</span>
<span class="w">    </span>
<span class="w">    </span><span class="sd">&#39;&#39;&#39;</span>
<span class="sd">    function to track mosture streams and ARS according to 850 hPa moisture flux</span>
<span class="sd">    &#39;&#39;&#39;</span>

    <span class="n">potARs</span> <span class="o">=</span> <span class="p">(</span><span class="n">VapTrans</span> <span class="o">&gt;</span> <span class="n">MinMSthreshold</span><span class="p">)</span>
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">rgiObjectsAR</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">potARs</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="c1"># sort the objects according to their size</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsAR</span><span class="p">)</span>

    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">:]][</span><span class="n">rgiObjectsAR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgiObjectsAR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>

    <span class="c1"># create final object array</span>
    <span class="n">MS_objectsTMP</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsAR</span><span class="p">);</span> <span class="n">MS_objectsTMP</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">)):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MinAreaMS</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">)):</span>
            <span class="n">MS_objectsTMP</span><span class="p">[</span><span class="n">rgiObjectsAR</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>
    <span class="c1"># lable the objects from 1 to N</span>
    <span class="c1"># MS_objects=np.copy(rgiObjectsAR); MS_objects[:]=0</span>
    <span class="c1"># Unique = np.unique(MS_objectsTMP)[1:]</span>
    <span class="c1"># ii = 1</span>
    <span class="c1"># for ob in range(len(Unique)):</span>
    <span class="c1">#     MS_objects[MS_objectsTMP == Unique[ob]] = ii</span>
    <span class="c1">#     ii = ii + 1</span>

    <span class="n">MS_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">MS_objectsTMP</span><span class="p">,</span>
                                  <span class="n">dT</span><span class="p">,</span>
                                  <span class="n">min_tsteps</span><span class="o">=</span><span class="mi">0</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living MS objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">MS_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect MS objects over date line&#39;</span><span class="p">)</span>
        <span class="n">MS_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">MS_objects</span></div>



<div class="viewcode-block" id="ar_ivt_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ar_ivt_tracking">[docs]</a><span class="k">def</span> <span class="nf">ar_ivt_tracking</span><span class="p">(</span><span class="n">IVT</span><span class="p">,</span>
                    <span class="n">IVTtrheshold</span><span class="p">,</span>
                    <span class="n">MinTimeIVT</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">connectLon</span><span class="p">,</span>
                    <span class="n">Time</span><span class="p">):</span> <span class="c1"># JLa, added Time</span>
            
            <span class="c1">### JLa -&gt;</span>
            <span class="c1">#potIVTs = (IVT &gt; IVTtrheshold)</span>
            <span class="c1"># potIVTs = (IVT &gt; IVTtrheshold) &amp; (IVT &gt; 100) # JLa: threshold wrt percentile and absolute value</span>
            <span class="n">potIVTs</span> <span class="o">=</span> <span class="p">(</span><span class="n">IVT</span> <span class="o">&gt;</span> <span class="n">IVTtrheshold</span><span class="p">[</span><span class="mi">0</span><span class="p">,:,:])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IVT</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span> <span class="c1"># JLa: threshold wrt percentile and absolute value</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Time</span><span class="p">)):</span>
                <span class="n">month</span><span class="o">=</span><span class="n">Time</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span><span class="o">.</span><span class="n">month</span>
                <span class="n">potIVTs</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="p">(</span><span class="n">IVT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="n">IVTtrheshold</span><span class="p">[</span><span class="n">month</span><span class="o">-</span><span class="mi">1</span><span class="p">,:,:])</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">IVT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span> <span class="mi">100</span><span class="p">)</span>
            <span class="c1"># ### JLa &lt;-</span>
            

            <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">rgiObjectsIVT</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">potIVTs</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

            <span class="n">IVT_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsIVT</span><span class="p">,</span>
                                           <span class="n">dT</span><span class="p">,</span>
                                    <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living IVT objects that have many elements&#39;</span><span class="p">)</span>
            <span class="n">IVT_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">,</span>
                                         <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                        <span class="n">dT</span><span class="p">)</span>

            <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect IVT objects over date line&#39;</span><span class="p">)</span>
                <span class="n">IVT_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">)</span>
            <span class="nb">print</span> <span class="p">(</span><span class="n">object_split</span><span class="p">)</span>

            <span class="k">return</span> <span class="n">IVT_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="c1">#JRie added return object_split</span></div>
        

        
<div class="viewcode-block" id="ar_check"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.ar_check">[docs]</a><span class="k">def</span> <span class="nf">ar_check</span><span class="p">(</span><span class="n">objects_mask</span><span class="p">,</span>
             <span class="n">AR_Lat</span><span class="p">,</span>
             <span class="n">AR_width_lenght_ratio</span><span class="p">,</span>
             <span class="n">AR_MinLen</span><span class="p">,</span>
             <span class="n">Lon</span><span class="p">,</span>
             <span class="n">Lat</span><span class="p">):</span>

    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">AR_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">objects_mask</span><span class="p">);</span> <span class="n">AR_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="mf">0.</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">objects_mask</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>

    <span class="n">aa</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">objects_mask</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]])</span>
        <span class="c1"># check if object crosses the date line</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">OBJ_max_len</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span>
        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">PointsObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">append</span><span class="p">(</span><span class="n">LonObj</span><span class="p">[</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">LatObj</span><span class="p">[</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">==</span><span class="mi">1</span><span class="p">][:,</span><span class="kc">None</span><span class="p">],</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="k">try</span><span class="p">:</span>
                <span class="n">Hull</span> <span class="o">=</span> <span class="n">scipy</span><span class="o">.</span><span class="n">spatial</span><span class="o">.</span><span class="n">ConvexHull</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PointsObj</span><span class="p">))</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">XX</span> <span class="o">=</span> <span class="p">[];</span> <span class="n">YY</span><span class="o">=</span><span class="p">[]</span>
            <span class="k">for</span> <span class="n">simplex</span> <span class="ow">in</span> <span class="n">Hull</span><span class="o">.</span><span class="n">simplices</span><span class="p">:</span>
    <span class="c1">#                 plt.plot(PointsObj[simplex, 0], PointsObj[simplex, 1], &#39;k-&#39;)</span>
                <span class="n">XX</span> <span class="o">=</span> <span class="n">XX</span> <span class="o">+</span> <span class="p">[</span><span class="n">PointsObj</span><span class="p">[</span><span class="n">simplex</span><span class="p">,</span> <span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span> 
                <span class="n">YY</span> <span class="o">=</span> <span class="n">YY</span> <span class="o">+</span> <span class="p">[</span><span class="n">PointsObj</span><span class="p">[</span><span class="n">simplex</span><span class="p">,</span> <span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>

            <span class="n">points</span> <span class="o">=</span> <span class="p">[[</span><span class="n">XX</span><span class="p">[</span><span class="n">ii</span><span class="p">],</span><span class="n">YY</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">YY</span><span class="p">))]</span>
            <span class="n">BOX</span> <span class="o">=</span> <span class="n">minimum_bounding_rectangle</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">PointsObj</span><span class="p">))</span>

            <span class="n">DIST</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">))</span>
            <span class="k">for</span> <span class="n">rr</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">3</span><span class="p">):</span>
                <span class="n">DIST</span><span class="p">[</span><span class="n">rr</span><span class="p">]</span> <span class="o">=</span> <span class="n">DistanceCoord</span><span class="p">(</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">BOX</span><span class="p">[</span><span class="n">rr</span><span class="o">+</span><span class="mi">1</span><span class="p">][</span><span class="mi">1</span><span class="p">])</span>
            <span class="n">OBJ_max_len</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">DIST</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">OBJ_max_len</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">&lt;=</span> <span class="n">AR_MinLen</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">rgiCenter</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">round</span><span class="p">(</span><span class="n">ndimage</span><span class="o">.</span><span class="n">measurements</span><span class="o">.</span><span class="n">center_of_mass</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]))</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
                <span class="n">LatCent</span> <span class="o">=</span> <span class="n">LatObj</span><span class="p">[</span><span class="n">rgiCenter</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span><span class="n">rgiCenter</span><span class="p">[</span><span class="mi">1</span><span class="p">]]</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LatCent</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">AR_Lat</span><span class="p">:</span>
                    <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># check width to lenght ratio</span>
            <span class="k">if</span> <span class="n">DIST</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">/</span><span class="n">DIST</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&lt;</span> <span class="n">AR_width_lenght_ratio</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">aa</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span> <span class="o">+</span> <span class="n">AR_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="n">AR_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ObjACT</span>
        <span class="n">aa</span><span class="o">=</span><span class="n">aa</span><span class="o">+</span><span class="mi">1</span>

    <span class="k">return</span> <span class="n">AR_obj</span>

    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span></div>
    

    
<div class="viewcode-block" id="frontal_identification"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.frontal_identification">[docs]</a><span class="k">def</span> <span class="nf">frontal_identification</span><span class="p">(</span><span class="n">Frontal_Diagnostic</span><span class="p">,</span>
                                  <span class="n">front_treshold</span><span class="p">,</span>
                                  <span class="n">MinAreaFR</span><span class="p">,</span>
                                  <span class="n">Area</span><span class="p">):</span>
            
            <span class="n">rgiObj_Struct_Fronts</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct_Fronts</span><span class="p">[</span><span class="mi">1</span><span class="p">,:,:]</span><span class="o">=</span><span class="mi">1</span>
            <span class="n">Fmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Frontal_Diagnostic</span> <span class="o">&gt;</span> <span class="n">front_treshold</span><span class="p">)</span>

            <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Fmask</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct_Fronts</span><span class="p">)</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

            <span class="c1"># # calculate object size</span>
            <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">)</span>
            <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">:]][</span><span class="n">rgiObjectsUD</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="mi">0</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>

            <span class="c1"># rgiAreaObj=np.array([np.sum(rgiObjectsUD[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>
            <span class="c1"># create final object array</span>
            <span class="n">FR_objects</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">)</span>
            <span class="n">TooSmall</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rgiAreaObj</span> <span class="o">&lt;</span> <span class="n">MinAreaFR</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">FR_objects</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">FR_objects</span><span class="p">,</span> <span class="n">TooSmall</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="mi">0</span>
            
            <span class="k">return</span> <span class="n">FR_objects</span></div>
        
        
        
<div class="viewcode-block" id="cy_acy_psl_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.cy_acy_psl_tracking">[docs]</a><span class="k">def</span> <span class="nf">cy_acy_psl_tracking</span><span class="p">(</span>
                    <span class="n">slp</span><span class="p">,</span>
                    <span class="n">MaxPresAnCY</span><span class="p">,</span>
                    <span class="n">MinTimeCY</span><span class="p">,</span>
                    <span class="n">MinPresAnACY</span><span class="p">,</span>
                    <span class="n">MinTimeACY</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">Gridspacing</span><span class="p">,</span>
                    <span class="n">connectLon</span>
                    <span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        track cyclones&#39;</span><span class="p">)</span>
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>

    <span class="n">slp</span> <span class="o">=</span> <span class="n">slp</span><span class="o">/</span><span class="mf">100.</span>
    <span class="n">slp_smooth</span> <span class="o">=</span> <span class="n">smooth_uniform</span><span class="p">(</span><span class="n">slp</span><span class="p">,</span>
                               <span class="mi">1</span><span class="p">,</span>
                               <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))</span>
    <span class="n">slpsmoothAn</span> <span class="o">=</span> <span class="n">smooth_uniform</span><span class="p">(</span><span class="n">slp</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))))</span>

    <span class="n">slp_Anomaly</span> <span class="o">=</span> <span class="n">slp_smooth</span><span class="o">-</span><span class="n">slpsmoothAn</span>
<span class="c1">#     slp_Anomaly[:,Mask == 0] = np.nan</span>
    <span class="c1"># plt.contour(slp_Anomaly[tt,:,:], levels=[-9990,-10,1100], colors=&#39;b&#39;)</span>
    <span class="n">Pressure_anomaly</span> <span class="o">=</span> <span class="n">slp_Anomaly</span> <span class="o">&lt;</span> <span class="n">MaxPresAnCY</span> <span class="c1"># 10 hPa depression | original setting was 12</span>

    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Pressure_anomaly</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="n">CY_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                          <span class="n">dT</span><span class="p">,</span>
                    <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">CY_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">CY_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">)</span>
        
    
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        track anti-cyclones&#39;</span><span class="p">)</span>
    <span class="n">HighPressure_annomaly</span> <span class="o">=</span> <span class="n">slp_Anomaly</span> <span class="o">&gt;</span> <span class="n">MinPresAnACY</span> <span class="c1"># 12</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">HighPressure_annomaly</span><span class="p">,</span><span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>
    
    <span class="n">ACY_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                   <span class="n">dT</span><span class="p">,</span>
                            <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeACY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            break up long living ACY objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">ACY_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">ACY_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># connect objects over date line</span>
        <span class="n">ACY_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">ACY_objects</span><span class="p">)</span>
    
    <span class="k">return</span> <span class="n">CY_objects</span><span class="p">,</span> <span class="n">ACY_objects</span></div>



<div class="viewcode-block" id="cy_acy_z500_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.cy_acy_z500_tracking">[docs]</a><span class="k">def</span> <span class="nf">cy_acy_z500_tracking</span><span class="p">(</span>
                    <span class="n">z500</span><span class="p">,</span>
                    <span class="n">MinTimeCY</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">Gridspacing</span><span class="p">,</span>
                    <span class="n">connectLon</span>
                    <span class="p">):</span>

    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">z500</span> <span class="o">=</span> <span class="n">z500</span> <span class="o">/</span> <span class="mf">9.81</span>
    <span class="n">z500_smooth</span> <span class="o">=</span> <span class="n">smooth_uniform</span><span class="p">(</span><span class="n">z500</span><span class="p">,</span>
                                <span class="mi">1</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="mi">100</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)))</span>
    <span class="n">z500smoothAn</span> <span class="o">=</span> <span class="n">smooth_uniform</span><span class="p">(</span><span class="n">z500</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="mi">78</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="nb">int</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="mi">3000</span><span class="o">/</span><span class="p">(</span><span class="n">Gridspacing</span><span class="o">/</span><span class="mf">1000.</span><span class="p">))))</span>
    <span class="n">z500_Anomaly</span> <span class="o">=</span> <span class="n">z500_smooth</span> <span class="o">-</span> <span class="n">z500smoothAn</span>
<span class="c1">#     z500_Anomaly[:,Mask == 0] = np.nan</span>

    <span class="n">z_low</span> <span class="o">=</span> <span class="n">z500_Anomaly</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">80</span>
    <span class="n">z_high</span> <span class="o">=</span> <span class="n">z500_Anomaly</span> <span class="o">&gt;</span> <span class="mi">70</span>

    <span class="c1"># -------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track 500 hPa cyclones&#39;</span><span class="p">)</span>
<span class="c1">#             z_low[:,Mask == 0] = 0</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">z_low</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

    <span class="n">cy_z500_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span><span class="p">)</span>


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">cy_z500_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">cy_z500_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">)</span>


    <span class="c1"># -------------------------------------</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    track 500 hPa anticyclones&#39;</span><span class="p">)</span>
    <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">z_high</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>
    <span class="n">acy_z500_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                                <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                 <span class="n">dT</span> <span class="o">=</span> <span class="n">dT</span><span class="p">)</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living CY objects that heve many elements&#39;</span><span class="p">)</span>
    <span class="n">acy_z500_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">acy_z500_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cyclones objects over date line&#39;</span><span class="p">)</span>
        <span class="n">acy_z500_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">acy_z500_objects</span><span class="p">)</span>

    <span class="k">return</span> <span class="n">cy_z500_objects</span><span class="p">,</span> <span class="n">acy_z500_objects</span></div>






<div class="viewcode-block" id="col_identification"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.col_identification">[docs]</a><span class="k">def</span> <span class="nf">col_identification</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">,</span>
                       <span class="n">z500</span><span class="p">,</span>
                       <span class="n">u200</span><span class="p">,</span>
                       <span class="n">Frontal_Diagnostic</span><span class="p">,</span>
                       <span class="n">MinTimeC</span><span class="p">,</span>
                       <span class="n">dx</span><span class="p">,</span>
                       <span class="n">dy</span><span class="p">,</span>
                       <span class="n">Lon</span><span class="p">,</span>
                       <span class="n">Lat</span>
                      <span class="p">):</span>

    <span class="c1"># area arround cyclone</span>
    <span class="n">col_buffer</span> <span class="o">=</span> <span class="mi">500000</span> <span class="c1"># m</span>

    <span class="c1"># check if cyclone is COL</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">col_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">);</span> <span class="n">col_obj</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">cy_z500_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">MinTimeC</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">dxObj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dx</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]))</span>
        <span class="n">dyObj</span> <span class="o">=</span> <span class="nb">abs</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">dy</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]))</span>
        <span class="n">col_buffer_obj_lo</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_buffer</span><span class="o">/</span><span class="n">dxObj</span><span class="p">)</span>
        <span class="n">col_buffer_obj_la</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">col_buffer</span><span class="o">/</span><span class="n">dyObj</span><span class="p">)</span>

        <span class="c1"># add buffer to object slice</span>
        <span class="n">tt_start</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">start</span>
        <span class="n">tt_stop</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span>
        <span class="n">lo_start</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">col_buffer_obj_lo</span> 
        <span class="n">lo_stop</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span>
        <span class="n">la_start</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">start</span> <span class="o">-</span> <span class="n">col_buffer_obj_la</span> 
        <span class="n">la_stop</span> <span class="o">=</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span><span class="o">.</span><span class="n">stop</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span>
        <span class="k">if</span> <span class="n">lo_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">lo_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">lo_stop</span> <span class="o">&gt;=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]:</span>
            <span class="n">lo_stop</span> <span class="o">=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">la_start</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">la_start</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">if</span> <span class="n">la_stop</span> <span class="o">&gt;=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">la_stop</span> <span class="o">=</span> <span class="n">Lon</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span>

        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>

        <span class="n">z500_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z500</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">])</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">cy_z500_objects</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">u200_ob</span> <span class="o">=</span> <span class="n">u200</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="n">front_ob</span> <span class="o">=</span> <span class="n">Frontal_Diagnostic</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">-</span> <span class="n">LonObj</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">358</span><span class="p">:</span>
            <span class="n">sift_lo</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
            <span class="c1"># object crosses the date line</span>
            <span class="n">shift</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">LonObj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">LonObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">LonObj</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">LatObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">LatObj</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">z500_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">z500_ACT</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">u200_ob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">u200_ob</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">front_ob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">front_ob</span><span class="p">,</span> <span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="n">sift_lo</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>

        <span class="c1"># find location of z500 minimum</span>
        <span class="n">z500_ACT_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">z500_ACT</span><span class="p">)</span>
        <span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">999999999999.</span>

        <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
            <span class="n">min_loc</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">]))</span>
            <span class="n">min_la</span> <span class="o">=</span> <span class="n">min_loc</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">min_lo</span> <span class="o">=</span> <span class="n">min_loc</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">la_0</span> <span class="o">=</span> <span class="n">min_la</span> <span class="o">-</span> <span class="n">col_buffer_obj_la</span>
            <span class="k">if</span> <span class="n">la_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">la_0</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="n">lo_0</span> <span class="o">=</span> <span class="n">min_lo</span> <span class="o">-</span> <span class="n">col_buffer_obj_lo</span>
            <span class="k">if</span> <span class="n">lo_0</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">lo_0</span> <span class="o">=</span> <span class="mi">0</span>

            <span class="n">lat_reg</span> <span class="o">=</span> <span class="n">LatObj</span><span class="p">[</span><span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">lon_reg</span> <span class="o">=</span> <span class="n">LonObj</span><span class="p">[</span><span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                             <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>

            <span class="n">col_region</span> <span class="o">=</span> <span class="n">z500_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">obj_col_region</span> <span class="o">=</span> <span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">min_z500_obj</span> <span class="o">=</span> <span class="n">z500_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">min_la</span><span class="p">,</span><span class="n">min_lo</span><span class="p">]</span>
            <span class="n">u200_ob_region</span> <span class="o">=</span> <span class="n">u200_ob</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>
            <span class="n">front_ob_region</span> <span class="o">=</span> <span class="n">front_ob</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span>
                                  <span class="n">la_0</span><span class="p">:</span><span class="n">min_la</span> <span class="o">+</span> <span class="n">col_buffer_obj_la</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span>
                                  <span class="n">lo_0</span><span class="p">:</span><span class="n">min_lo</span> <span class="o">+</span> <span class="n">col_buffer_obj_lo</span><span class="o">+</span><span class="mi">1</span><span class="p">]</span>


            <span class="c1"># check if 350 km radius arround center has higher Z</span>
            <span class="n">min_loc_tt</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">obj_col_region</span><span class="p">[:,:]</span> <span class="o">==</span> 
                                  <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">]))</span>
            <span class="n">min_la_tt</span> <span class="o">=</span> <span class="n">min_loc_tt</span><span class="p">[</span><span class="mi">0</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
            <span class="n">min_lo_tt</span> <span class="o">=</span> <span class="n">min_loc_tt</span><span class="p">[</span><span class="mi">1</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>

            <span class="n">rdist</span> <span class="o">=</span> <span class="n">radialdistance</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">],</span>
                                   <span class="n">lon_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">],</span>
                                   <span class="n">lat_reg</span><span class="p">,</span>
                                   <span class="n">lon_reg</span><span class="p">)</span>

            <span class="c1"># COL should only occure between 20 and 70 degrees</span>
            <span class="c1"># https://journals.ametsoc.org/view/journals/clim/33/6/jcli-d-19-0497.1.xml</span>
            <span class="k">if</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">])</span> <span class="o">&lt;</span> <span class="mi">20</span><span class="p">)</span> <span class="o">|</span> <span class="p">(</span><span class="nb">abs</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">70</span><span class="p">):</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># remove cyclones that are close to the poles</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">lat_reg</span><span class="p">))</span> <span class="o">&gt;</span> <span class="mi">88</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">z500_ACT_obj</span><span class="p">[</span><span class="n">tt</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">100000</span><span class="p">:</span>
                <span class="c1"># there is no object to process</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># CRITERIA 1) at least 75 % of grid cells in ring have have 10 m higher Z than center</span>
            <span class="n">ring</span> <span class="o">=</span> <span class="p">(</span><span class="n">rdist</span> <span class="o">&gt;=</span> <span class="p">(</span><span class="mi">350</span> <span class="o">-</span> <span class="p">(</span><span class="n">dxObj</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>  <span class="o">&amp;</span> <span class="p">(</span><span class="n">rdist</span> <span class="o">&lt;=</span> <span class="p">(</span><span class="mi">350</span> <span class="o">+</span> <span class="p">(</span><span class="n">dxObj</span><span class="o">/</span><span class="mf">1000.</span><span class="p">)</span><span class="o">*</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">((</span><span class="n">min_z500_obj</span> <span class="o">-</span> <span class="n">col_region</span><span class="p">[</span><span class="n">ring</span><span class="p">])</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">10</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">ring</span><span class="p">)</span><span class="o">*</span><span class="mf">0.75</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># CRITERIA 2) check if 200 hPa wind speed is eastward in the poleward direction of the cyclone</span>
            <span class="k">if</span> <span class="n">lat_reg</span><span class="p">[</span><span class="n">min_la_tt</span><span class="p">,</span><span class="n">min_lo_tt</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                <span class="n">east_flow</span> <span class="o">=</span> <span class="n">u200_ob_region</span><span class="p">[</span><span class="mi">0</span> <span class="p">:</span> <span class="n">min_la_tt</span><span class="p">,</span>
                                    <span class="n">min_lo_tt</span><span class="p">]</span>
            <span class="k">else</span><span class="p">:</span>
                <span class="n">east_flow</span> <span class="o">=</span> <span class="n">u200_ob_region</span><span class="p">[</span><span class="n">min_la_tt</span> <span class="p">:</span> <span class="o">-</span><span class="mi">1</span><span class="p">,</span>
                                    <span class="n">min_lo_tt</span><span class="p">]</span>

            <span class="k">try</span><span class="p">:</span>
                <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">east_flow</span><span class="p">)</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
                    <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                    <span class="k">continue</span>
            <span class="k">except</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

            <span class="c1"># Criteria 3) frontal zone in eastern flank of COL</span>
            <span class="n">front_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">front_ob_region</span><span class="p">[:,</span> <span class="n">min_lo_tt</span><span class="p">:])</span> <span class="o">&gt;</span> <span class="mi">1</span><span class="p">)</span>
            <span class="k">if</span> <span class="n">front_test</span> <span class="o">&lt;</span> <span class="mi">1</span><span class="p">:</span>
                <span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
                <span class="k">continue</span>

        <span class="k">if</span> <span class="n">sift_lo</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="o">-</span><span class="n">shift</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span> <span class="o">+</span> <span class="n">col_obj</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span>
        <span class="n">col_obj</span><span class="p">[</span><span class="n">tt_start</span><span class="p">:</span><span class="n">tt_stop</span><span class="p">,</span> <span class="n">la_start</span><span class="p">:</span><span class="n">la_stop</span><span class="p">,</span> <span class="n">lo_start</span><span class="p">:</span><span class="n">lo_stop</span><span class="p">]</span> <span class="o">=</span> <span class="n">ObjACT</span>

    <span class="k">return</span> <span class="n">col_obj</span></div>





<div class="viewcode-block" id="mcs_tb_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.mcs_tb_tracking">[docs]</a><span class="k">def</span> <span class="nf">mcs_tb_tracking</span><span class="p">(</span>
                    <span class="n">tb</span><span class="p">,</span>
                    <span class="n">pr</span><span class="p">,</span>
                    <span class="n">SmoothSigmaC</span><span class="p">,</span>
                    <span class="n">Pthreshold</span><span class="p">,</span>
                    <span class="n">CL_Area</span><span class="p">,</span>
                    <span class="n">CL_MaxT</span><span class="p">,</span>
                    <span class="n">Cthreshold</span><span class="p">,</span>
                    <span class="n">MinAreaC</span><span class="p">,</span>
                    <span class="n">MinTimeC</span><span class="p">,</span>
                    <span class="n">MCS_minPR</span><span class="p">,</span>
                    <span class="n">MCS_minTime</span><span class="p">,</span>
                    <span class="n">MCS_Minsize</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">Area</span><span class="p">,</span>
                    <span class="n">connectLon</span><span class="p">,</span>
                   <span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        track  clouds&#39;</span><span class="p">)</span>
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">Csmooth</span><span class="o">=</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SmoothSigmaC</span><span class="p">,</span><span class="n">SmoothSigmaC</span><span class="p">))</span>
    <span class="n">Cmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">Csmooth</span> <span class="o">&lt;=</span> <span class="n">Cthreshold</span><span class="p">)</span>
    <span class="n">rgiObjectsC</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">Cmask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; cloud object found&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># connect objects over date line</span>
        <span class="n">rgiObjectsC</span> <span class="o">=</span> <span class="n">ConnectLon</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">)</span>
        
    <span class="c1"># minimum cloud volume</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">)</span>
    
    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">2</span><span class="p">]][</span><span class="n">rgiObjectsC</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>

    <span class="c1"># rgiVolObjC=np.array([np.sum(rgiObjectsC[Objects[ob]] == ob+1) for ob in range(nr_objectsUD)])</span>

    <span class="c1"># create final object array</span>
    <span class="n">C_objects</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsC</span><span class="p">);</span> <span class="n">C_objects</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">)):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MinAreaC</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">)):</span>
        <span class="c1"># if rgiVolObjC[ob] &gt;= MinAreaC:</span>
            <span class="n">C_objects</span><span class="p">[</span><span class="n">rgiObjectsC</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        break up long living cloud shield objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">C_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">C_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        connect cloud objects over date line&#39;</span><span class="p">)</span>
        <span class="n">C_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">C_objects</span><span class="p">)</span>



    <span class="c1"># check if precipitation object is from an MCS</span>
    <span class="n">object_indices</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">C_objects</span><span class="p">)</span>
    <span class="n">MCS_objects_Tb</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">(</span><span class="n">C_objects</span><span class="o">.</span><span class="n">shape</span><span class="p">,</span><span class="n">dtype</span><span class="o">=</span><span class="nb">int</span><span class="p">)</span>

    <span class="k">for</span> <span class="n">iobj</span><span class="p">,</span><span class="n">_</span> <span class="ow">in</span> <span class="n">tqdm</span><span class="p">(</span><span class="nb">enumerate</span><span class="p">(</span><span class="n">object_indices</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]</span> <span class="ow">is</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">time_slice</span> <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">0</span><span class="p">]</span>
        <span class="n">lat_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">1</span><span class="p">]</span>
        <span class="n">lon_slice</span>  <span class="o">=</span> <span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">][</span><span class="mi">2</span><span class="p">]</span>

        <span class="n">tb_object_slice</span><span class="o">=</span> <span class="n">C_objects</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">tb_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">tb_object_slice</span><span class="o">==</span><span class="n">iobj</span><span class="o">+</span><span class="mi">1</span><span class="p">,</span><span class="kc">True</span><span class="p">,</span><span class="kc">False</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">tb_object_act</span><span class="p">)</span> <span class="o">&lt;</span> <span class="n">MCS_minTime</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="n">tb_slice</span> <span class="o">=</span>  <span class="n">tb</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">tb_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tb_slice</span><span class="p">)</span>
        <span class="n">tb_act</span><span class="p">[</span><span class="o">~</span><span class="n">tb_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">bt_object_slice</span> <span class="o">=</span> <span class="n">C_objects</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span>
        <span class="n">bt_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">bt_object_slice</span><span class="p">)</span>
        <span class="n">bt_object_act</span><span class="p">[</span><span class="o">~</span><span class="n">tb_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="n">area_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">lat_slice</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">],</span> <span class="p">(</span><span class="n">tb_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">area_act</span><span class="p">[</span><span class="o">~</span><span class="n">tb_object_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="c1">### Calculate cloud properties</span>
        <span class="n">tb_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">area_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>
        <span class="n">tb_min</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">tb_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

        <span class="c1">### Calculate precipitation properties</span>
        <span class="n">pr_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">pr</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>
        <span class="n">pr_act</span><span class="p">[</span><span class="n">tb_object_act</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">pr_peak_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">nanmax</span><span class="p">(</span><span class="n">pr_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span>

        <span class="n">pr_region_act</span> <span class="o">=</span> <span class="n">pr_act</span> <span class="o">&gt;=</span> <span class="n">Pthreshold</span><span class="o">*</span><span class="n">dT</span>
        <span class="n">area_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">tile</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">lat_slice</span><span class="p">,</span> <span class="n">lon_slice</span><span class="p">],</span> <span class="p">(</span><span class="n">tb_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">],</span> <span class="mi">1</span><span class="p">,</span> <span class="mi">1</span><span class="p">))</span>
        <span class="n">area_act</span><span class="p">[</span><span class="o">~</span><span class="n">pr_region_act</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="n">pr_under_cloud</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">area_act</span><span class="p">,</span><span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">)))</span><span class="o">/</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> 


        <span class="c1"># Test if object classifies as MCS</span>
        <span class="n">tb_size_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">tb_size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">CL_Area</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">MCS_minTime</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">tb_overshoot_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">tb_min</span>  <span class="o">&lt;=</span> <span class="n">CL_MaxT</span> <span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">pr_peak_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">pr_peak_act</span> <span class="o">&gt;=</span> <span class="n">MCS_minPR</span> <span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="p">),</span> <span class="s1">&#39;valid&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">MCS_minTime</span><span class="p">)</span> <span class="o">==</span><span class="mi">1</span>
        <span class="n">pr_area_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">((</span><span class="n">pr_under_cloud</span> <span class="o">&gt;=</span> <span class="n">MCS_Minsize</span><span class="p">))</span> <span class="o">==</span> <span class="mi">1</span>
        <span class="n">MCS_test</span> <span class="o">=</span> <span class="p">(</span>
                    <span class="n">tb_size_test</span>
                    <span class="o">&amp;</span> <span class="n">tb_overshoot_test</span>
                    <span class="o">&amp;</span> <span class="n">pr_peak_test</span>
                    <span class="o">&amp;</span> <span class="n">pr_area_test</span>
        <span class="p">)</span>

        <span class="c1"># assign unique object numbers</span>
        <span class="n">tb_object_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">tb_object_act</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">tb_object_act</span><span class="p">[</span><span class="n">tb_object_act</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">iobj</span> <span class="o">+</span> <span class="mi">1</span>

<span class="c1">#         window_length = int(MCS_minTime / dT)</span>
<span class="c1">#         moving_averages = np.convolve(MCS_test, np.ones(window_length), &#39;valid&#39;) / window_length</span>

    <span class="c1">#     if iobj+1 == 19:</span>
    <span class="c1">#         stop()</span>
        <span class="k">if</span> <span class="n">MCS_test</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MCS_objects_Tb</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]])</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">TMP</span> <span class="o">+</span> <span class="n">tb_object_act</span>
            <span class="n">MCS_objects_Tb</span><span class="p">[</span><span class="n">object_indices</span><span class="p">[</span><span class="n">iobj</span><span class="p">]]</span> <span class="o">=</span> <span class="n">TMP</span>

        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="n">MCS_objects_Tb</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">MCS_objects_Tb</span><span class="p">,</span>
                                       <span class="n">dT</span><span class="p">,</span>
                                       <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>  

    <span class="k">return</span> <span class="n">MCS_objects_Tb</span><span class="p">,</span> <span class="n">C_objects</span></div>



<div class="viewcode-block" id="tc_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.tc_tracking">[docs]</a><span class="k">def</span> <span class="nf">tc_tracking</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">,</span>
                <span class="n">t850</span><span class="p">,</span>
                <span class="n">slp</span><span class="p">,</span>
                <span class="n">tb</span><span class="p">,</span>
                <span class="n">C_objects</span><span class="p">,</span>
                <span class="n">Lon</span><span class="p">,</span>
                <span class="n">Lat</span><span class="p">,</span>
                <span class="n">TC_lat_genesis</span><span class="p">,</span>
                <span class="n">TC_deltaT_core</span><span class="p">,</span>
                <span class="n">TC_T850min</span><span class="p">,</span>
                <span class="n">TC_Pmin</span><span class="p">,</span>
                <span class="n">TC_lat_max</span>
               <span class="p">):</span>
    <span class="n">TC_Tracks</span> <span class="o">=</span> <span class="p">{}</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">CY_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">TC_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">);</span> <span class="n">TC_obj</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">CY_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="o">*</span><span class="mi">8</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">T_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">t850</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">slp_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">slp</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span><span class="o">/</span><span class="mf">100.</span>
        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="c1"># check if object crosses the date line</span>
        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
            <span class="n">slp_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">slp_ACT</span><span class="p">,</span> <span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="c1"># Calculate low pressure center track</span>
        <span class="n">slp_ACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mf">999999999.</span>
        <span class="n">Track_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">argwhere</span><span class="p">(</span><span class="n">slp_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">slp_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]))[</span><span class="mi">0</span><span class="p">]</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="n">LatLonTrackAct</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([(</span><span class="n">LatObj</span><span class="p">[</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">1</span><span class="p">]],</span><span class="n">LonObj</span><span class="p">[</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">][</span><span class="mi">1</span><span class="p">]])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span> <span class="o">&gt;</span> <span class="n">TC_lat_genesis</span><span class="p">:</span>
            <span class="n">ObjACT</span><span class="p">[:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="k">continue</span>
        <span class="k">else</span><span class="p">:</span>

            <span class="c1"># has the cyclone a warm core?</span>
            <span class="n">DeltaTCore</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]));</span> <span class="n">DeltaTCore</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
            <span class="n">T850_core</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">DeltaTCore</span><span class="p">)</span>
            <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
                <span class="n">T_cent</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">,</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">-</span><span class="mi">1</span><span class="p">:</span><span class="n">Track_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="mi">1</span><span class="p">]</span><span class="o">+</span><span class="mi">2</span><span class="p">])</span>
                <span class="n">T850_core</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_cent</span>
                <span class="n">T_Cyclone</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">mean</span><span class="p">(</span><span class="n">T_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">!=</span> <span class="mi">0</span><span class="p">])</span>
    <span class="c1">#                     T_Cyclone = np.mean(T_ACT[tt,MassC[0]-5:MassC[0]+6,MassC[1]-5:MassC[1]+6])</span>
                <span class="n">DeltaTCore</span><span class="p">[</span><span class="n">tt</span><span class="p">]</span> <span class="o">=</span> <span class="n">T_cent</span><span class="o">-</span><span class="n">T_Cyclone</span>
            <span class="c1"># smooth the data</span>
            <span class="n">DeltaTCore</span> <span class="o">=</span> <span class="n">gaussian_filter</span><span class="p">(</span><span class="n">DeltaTCore</span><span class="p">,</span><span class="mi">1</span><span class="p">)</span>
            <span class="n">WarmCore</span> <span class="o">=</span> <span class="n">DeltaTCore</span> <span class="o">&gt;</span> <span class="n">TC_deltaT_core</span>

            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">WarmCore</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">continue</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">WarmCore</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
            <span class="c1"># is the core temperature warm enough</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">T850_core</span> <span class="o">&lt;</span> <span class="n">TC_T850min</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>


            <span class="c1"># TC must have pressure of less 980 hPa</span>
            <span class="n">MinPress</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">(</span><span class="n">slp_ACT</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
            <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">MinPress</span> <span class="o">&lt;</span> <span class="n">TC_Pmin</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">8</span><span class="p">:</span>
                <span class="k">continue</span>

            <span class="c1"># # is the cloud shield cold enough?</span>
            <span class="c1"># BT_act = np.copy(tb[Objects[ii]])</span>
            <span class="c1"># # BT_objMean = np.zeros((BT_act.shape[0])); BT_objMean[:] = np.nan</span>
            <span class="c1"># # PR_objACT = np.copy(PR_objects[Objects[ii]])</span>
            <span class="c1"># # for tt in range(len(BT_objMean)):</span>
            <span class="c1"># #     try:</span>
            <span class="c1"># #         BT_objMean[tt] = np.nanmean(BT_act[tt,PR_objACT[tt,:,:] != 0])</span>
            <span class="c1"># #     except:</span>
            <span class="c1"># #         continue</span>
            <span class="c1"># BT_objMean = np.nanmean(BT_act[:,:,:], axis=(1,2))</span>

            <span class="c1"># # is cloud shild overlapping with TC?</span>
            <span class="c1"># BT_objACT = np.copy(C_objects[Objects[ii]])</span>
            <span class="c1"># bt_overlap = np.array([np.sum((BT_objACT[kk,ObjACT[kk,:,:] == True] &gt; 0) == True)/np.sum(ObjACT[10,:,:] == True) for kk in range(ObjACT.shape[0])]) &gt; 0.4</span>

        <span class="c1"># remove pieces of the track that are not TCs</span>
        <span class="n">TCcheck</span> <span class="o">=</span> <span class="p">(</span><span class="n">T850_core</span> <span class="o">&gt;</span> <span class="n">TC_T850min</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">WarmCore</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">MinPress</span> <span class="o">&lt;</span> <span class="n">TC_Pmin</span><span class="p">)</span> <span class="c1">#&amp; (bt_overlap == 1) #(BT_objMean &lt; TC_minBT)</span>
        <span class="n">LatLonTrackAct</span><span class="p">[</span><span class="n">TCcheck</span> <span class="o">==</span> <span class="kc">False</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="n">Max_LAT</span> <span class="o">=</span> <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span>  <span class="n">TC_lat_max</span><span class="p">)</span>
        <span class="n">LatLonTrackAct</span><span class="p">[</span><span class="n">Max_LAT</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="o">~</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]))</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="k">continue</span>

        <span class="c1"># check if cyclone genesis is over water; each re-emergence of TC is a new genesis</span>
        <span class="n">resultLAT</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">g</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">resultLON</span> <span class="o">=</span> <span class="p">[</span><span class="nb">list</span><span class="p">(</span><span class="nb">map</span><span class="p">(</span><span class="nb">float</span><span class="p">,</span><span class="n">g</span><span class="p">))</span> <span class="k">for</span> <span class="n">k</span><span class="p">,</span><span class="n">g</span> <span class="ow">in</span> <span class="n">groupby</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">1</span><span class="p">],</span> <span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">)</span> <span class="k">if</span> <span class="ow">not</span> <span class="n">k</span><span class="p">]</span>
        <span class="n">LS_genesis</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="nb">len</span><span class="p">(</span><span class="n">resultLAT</span><span class="p">)));</span> <span class="n">LS_genesis</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">resultLAT</span><span class="p">)):</span>
            <span class="n">LS_genesis</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">is_land</span><span class="p">(</span><span class="n">resultLON</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">],</span><span class="n">resultLAT</span><span class="p">[</span><span class="n">jj</span><span class="p">][</span><span class="mi">0</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">LS_genesis</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">LS_genesis</span><span class="p">)):</span>
                <span class="k">if</span> <span class="n">LS_genesis</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
                    <span class="n">SetNAN</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">isin</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">],</span><span class="n">resultLAT</span><span class="p">[</span><span class="n">jj</span><span class="p">])</span>
                    <span class="n">LatLonTrackAct</span><span class="p">[</span><span class="n">SetNAN</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>

        <span class="c1"># make sure that only TC time slizes are considered</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">isnan</span><span class="p">(</span><span class="n">LatLonTrackAct</span><span class="p">[:,</span><span class="mi">0</span><span class="p">]),:,:]</span> <span class="o">=</span> <span class="mi">0</span>

        <span class="k">if</span> <span class="n">LonObj</span><span class="o">.</span><span class="n">max</span><span class="p">()</span><span class="o">-</span><span class="n">LonObj</span><span class="o">.</span><span class="n">min</span><span class="p">()</span> <span class="o">&gt;</span> <span class="mi">359</span><span class="p">:</span>
            <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">roll</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">,</span> <span class="o">-</span><span class="nb">int</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="mi">2</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="mi">2</span><span class="p">)</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span><span class="o">!=</span><span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>

        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">ObjACT</span> <span class="o">+</span> <span class="n">TC_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>
        <span class="n">TC_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">ObjACT</span>
        <span class="n">TC_Tracks</span><span class="p">[</span><span class="nb">str</span><span class="p">(</span><span class="n">ii</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">LatLonTrackAct</span>

    <span class="k">return</span> <span class="n">TC_obj</span><span class="p">,</span> <span class="n">TC_Tracks</span></div>



<div class="viewcode-block" id="mcs_pr_tracking"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.mcs_pr_tracking">[docs]</a><span class="k">def</span> <span class="nf">mcs_pr_tracking</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span>
                    <span class="n">tb</span><span class="p">,</span>
                    <span class="n">C_objects</span><span class="p">,</span>
                    <span class="n">AR_obj</span><span class="p">,</span>
                    <span class="n">Area</span><span class="p">,</span>
                    <span class="n">Lon</span><span class="p">,</span>
                    <span class="n">Lat</span><span class="p">,</span>
                    <span class="n">SmoothSigmaP</span><span class="p">,</span>
                    <span class="n">Pthreshold</span><span class="p">,</span>
                    <span class="n">MinTimePR</span><span class="p">,</span>
                    <span class="n">MCS_minPR</span><span class="p">,</span>
                    <span class="n">MCS_Minsize</span><span class="p">,</span>
                    <span class="n">CL_Area</span><span class="p">,</span>
                    <span class="n">CL_MaxT</span><span class="p">,</span>
                    <span class="n">MCS_minTime</span><span class="p">,</span>
                    <span class="n">MinAreaPR</span><span class="p">,</span>
                    <span class="n">dT</span><span class="p">,</span>
                    <span class="n">connectLon</span><span class="p">):</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        track  precipitation&#39;</span><span class="p">)</span>
    
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="n">PRsmooth</span><span class="o">=</span><span class="n">gaussian_filter</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span> <span class="n">sigma</span><span class="o">=</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span><span class="n">SmoothSigmaP</span><span class="p">,</span><span class="n">SmoothSigmaP</span><span class="p">))</span>
    <span class="n">PRmask</span> <span class="o">=</span> <span class="p">(</span><span class="n">PRsmooth</span> <span class="o">&gt;=</span> <span class="n">Pthreshold</span><span class="o">*</span><span class="n">dT</span><span class="p">)</span>
    
    <span class="n">rgiObjectsPR</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">PRmask</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; precipitation object found&#39;</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="c1"># connect objects over date line</span>
        <span class="n">rgiObjectsPR</span> <span class="o">=</span> <span class="n">ConnectLon</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">)</span>

    <span class="n">stop</span><span class="p">()</span>    
    
    <span class="c1"># remove None objects</span>
    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">)</span>
    <span class="n">rgiVolObj</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>
    <span class="n">ZERO_V</span> <span class="o">=</span>  <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">rgiVolObj</span> <span class="o">==</span> <span class="mi">0</span><span class="p">)</span>
    <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">ZERO_V</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">:</span>
        <span class="n">Dummy</span> <span class="o">=</span> <span class="p">(</span><span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">),</span> <span class="nb">slice</span><span class="p">(</span><span class="mi">0</span><span class="p">,</span> <span class="mi">1</span><span class="p">,</span> <span class="kc">None</span><span class="p">))</span>
        <span class="n">Objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Objects</span><span class="p">)</span>
        <span class="k">for</span> <span class="n">jj</span> <span class="ow">in</span> <span class="n">ZERO_V</span><span class="p">[</span><span class="mi">0</span><span class="p">]:</span>
            <span class="n">Objects</span><span class="p">[</span><span class="n">jj</span><span class="p">]</span> <span class="o">=</span> <span class="n">Dummy</span>

    <span class="n">stop</span><span class="p">()</span>
    <span class="c1"># Remove objects that are too small or short lived</span>
    <span class="n">rgiAreaObj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([[</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">][</span><span class="mi">2</span><span class="p">]][</span><span class="n">rgiObjectsPR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]][</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">==</span> <span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ob</span><span class="p">]]</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])]</span> <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)])</span>
    <span class="c1"># create final object array</span>
    <span class="n">PR_objects</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">rgiObjectsPR</span><span class="p">);</span> <span class="n">PR_objects</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">ii</span> <span class="o">=</span> <span class="mi">1</span>
    <span class="k">for</span> <span class="n">ob</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">)):</span>
        <span class="n">AreaTest</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="n">MinAreaPR</span><span class="o">*</span><span class="mi">1000</span><span class="o">**</span><span class="mi">2</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">)),</span> <span class="n">mode</span><span class="o">=</span><span class="s1">&#39;valid&#39;</span><span class="p">))</span>
        <span class="k">if</span> <span class="p">(</span><span class="n">AreaTest</span> <span class="o">==</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> <span class="o">&amp;</span> <span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">rgiAreaObj</span><span class="p">[</span><span class="n">ob</span><span class="p">])</span> <span class="o">&gt;=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">)):</span>
            <span class="n">PR_objects</span><span class="p">[</span><span class="n">rgiObjectsPR</span> <span class="o">==</span> <span class="p">(</span><span class="n">ob</span><span class="o">+</span><span class="mi">1</span><span class="p">)]</span> <span class="o">=</span> <span class="n">ii</span>
            <span class="n">ii</span> <span class="o">=</span> <span class="n">ii</span> <span class="o">+</span> <span class="mi">1</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            break up long living precipitation objects that have many elements&#39;</span><span class="p">)</span>
    <span class="n">PR_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">,</span>
                                <span class="nb">int</span><span class="p">(</span><span class="n">MinTimePR</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                <span class="n">dT</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            connect precipitation objects over date line&#39;</span><span class="p">)</span>
        <span class="n">PR_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">)</span>

    <span class="c1"># ===================</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    check if pr objects quallify as MCS&#39;</span><span class="p">)</span>

    <span class="n">Objects</span><span class="o">=</span><span class="n">ndimage</span><span class="o">.</span><span class="n">find_objects</span><span class="p">(</span><span class="n">PR_objects</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">))</span>
    <span class="n">MCS_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">PR_objects</span><span class="p">);</span> <span class="n">MCS_obj</span><span class="p">[:]</span><span class="o">=</span><span class="mi">0</span>
    <span class="n">window_length</span> <span class="o">=</span> <span class="nb">int</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">ii</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="nb">len</span><span class="p">(</span><span class="n">Objects</span><span class="p">)):</span>
        <span class="k">if</span> <span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]</span> <span class="o">==</span> <span class="kc">None</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">PR_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">==</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="mi">2</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="k">if</span> <span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="n">window_length</span><span class="p">:</span>
            <span class="k">continue</span>
        <span class="n">Cloud_ACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">C_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">LonObj</span> <span class="o">=</span> <span class="n">Lon</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">LatObj</span> <span class="o">=</span> <span class="n">Lat</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>   
        <span class="n">Area_ACT</span> <span class="o">=</span> <span class="n">Area</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">1</span><span class="p">],</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">2</span><span class="p">]]</span>
        <span class="n">PR_ACT</span> <span class="o">=</span> <span class="n">pr</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span>

        <span class="n">PR_Size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area_ACT</span><span class="p">[</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="n">PR_MAX</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">PR_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">PR_ACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,</span><span class="n">ObjACT</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span><span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">0</span> <span class="k">else</span> <span class="mi">0</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="c1"># Get cloud shield</span>
        <span class="n">rgiCL_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">delete</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">unique</span><span class="p">(</span><span class="n">Cloud_ACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">]),</span><span class="mi">0</span><span class="p">)</span>
        <span class="k">if</span> <span class="nb">len</span><span class="p">(</span><span class="n">rgiCL_obj</span><span class="p">)</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="c1"># no deep cloud shield is over the precipitation</span>
            <span class="k">continue</span>
        <span class="n">CL_OB_TMP</span> <span class="o">=</span> <span class="n">C_objects</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">][</span><span class="mi">0</span><span class="p">]]</span>
        <span class="n">CLOUD_obj_act</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">in1d</span><span class="p">(</span><span class="n">CL_OB_TMP</span><span class="o">.</span><span class="n">flatten</span><span class="p">(),</span> <span class="n">rgiCL_obj</span><span class="p">)</span><span class="o">.</span><span class="n">reshape</span><span class="p">(</span><span class="n">CL_OB_TMP</span><span class="o">.</span><span class="n">shape</span><span class="p">)</span>
        <span class="n">Cloud_Size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">([</span><span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">Area</span><span class="p">[</span><span class="n">CLOUD_obj_act</span><span class="p">[</span><span class="n">tt</span><span class="p">,:,:]</span> <span class="o">&gt;</span><span class="mi">0</span><span class="p">])</span> <span class="k">for</span> <span class="n">tt</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">CLOUD_obj_act</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])])</span>
        <span class="c1"># min temperatur must be taken over precip area</span>
    <span class="c1">#     CL_ob_pr = C_objects[Objects[ii]]</span>
        <span class="n">CL_BT_pr</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">tb</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">CL_BT_pr</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="n">Cloud_MinT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nanmin</span><span class="p">(</span><span class="n">CL_BT_pr</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
    <span class="c1">#     Cloud_MinT = np.array([np.min(CL_BT_pr[tt,CL_ob_pr[tt,:,:] &gt;0]) if len(CL_ob_pr[tt,CL_ob_pr[tt,:,:] &gt;0]) &gt; 0 else 0 for tt in range(CL_ob_pr.shape[0])])</span>
        <span class="n">Cloud_MinT</span><span class="p">[</span><span class="n">Cloud_MinT</span> <span class="o">&lt;</span> <span class="mi">150</span> <span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
        <span class="c1"># is precipitation associated with AR?</span>
        <span class="n">AR_ob</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">AR_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
        <span class="n">AR_ob</span><span class="p">[:,</span><span class="n">LatObj</span> <span class="o">&lt;</span> <span class="mi">25</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span> <span class="c1"># only consider ARs in mid- and hight latitudes</span>
        <span class="n">AR_test</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sum</span><span class="p">(</span><span class="n">AR_ob</span> <span class="o">&gt;</span> <span class="mi">0</span><span class="p">,</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>            

        <span class="n">MCS_max_residence</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">min</span><span class="p">([</span><span class="nb">int</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span><span class="n">ObjACT</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]])</span> <span class="c1"># MCS criterion must be meet within this time window</span>
                               <span class="c1"># or MCS is discontinued</span>
        <span class="c1"># minimum lifetime peak precipitation</span>
        <span class="n">is_pr_peak_intense</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                                        <span class="n">PR_MAX</span> <span class="o">&gt;=</span> <span class="n">MCS_minPR</span><span class="o">*</span><span class="n">dT</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c1"># minimum precipitation area threshold</span>
        <span class="n">is_pr_size</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">PR_Size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">MCS_Minsize</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">window_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c1"># Tb size and time threshold</span>
        <span class="n">is_Tb_area</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                        <span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">((</span><span class="n">Cloud_Size</span> <span class="o">/</span> <span class="mi">1000</span><span class="o">**</span><span class="mi">2</span> <span class="o">&gt;=</span> <span class="n">CL_Area</span><span class="p">),</span> <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">window_length</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">/</span> <span class="n">window_length</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">,</span> 
                                        <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="c1"># Tb overshoot</span>
        <span class="n">is_Tb_overshoot</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">convolve</span><span class="p">(</span>
                            <span class="n">Cloud_MinT</span>  <span class="o">&lt;=</span> <span class="n">CL_MaxT</span><span class="p">,</span> 
                            <span class="n">np</span><span class="o">.</span><span class="n">ones</span><span class="p">(</span><span class="n">MCS_max_residence</span><span class="p">),</span> <span class="s1">&#39;same&#39;</span><span class="p">)</span> <span class="o">&gt;=</span> <span class="mi">1</span>
        <span class="k">try</span><span class="p">:</span>
            <span class="n">MCS_test</span> <span class="o">=</span> <span class="p">(</span>
                        <span class="p">(</span><span class="n">is_pr_peak_intense</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_pr_size</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_Tb_area</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                        <span class="o">&amp;</span> <span class="p">(</span><span class="n">is_Tb_overshoot</span> <span class="o">==</span> <span class="mi">1</span><span class="p">)</span>
                <span class="p">)</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">MCS_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="k">except</span><span class="p">:</span>
            <span class="n">ObjACT</span><span class="p">[</span><span class="n">MCS_test</span> <span class="o">==</span> <span class="mi">0</span><span class="p">,:,:]</span> <span class="o">=</span> <span class="mi">0</span>



        <span class="c1"># assign unique object numbers</span>
        <span class="n">ObjACT</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">ObjACT</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="nb">int</span><span class="p">)</span>
        <span class="n">ObjACT</span><span class="p">[</span><span class="n">ObjACT</span> <span class="o">==</span> <span class="mi">1</span><span class="p">]</span> <span class="o">=</span> <span class="n">ii</span><span class="o">+</span><span class="mi">1</span>

    <span class="c1">#         # remove all precip that is associated with ARs</span>
    <span class="c1">#         ObjACT[AR_test &gt; 0] = 0</span>

    <span class="c1">#     # PR area defines MCS area and precipitation</span>
    <span class="c1">#     window_length = int(MCS_minTime/dT)</span>
    <span class="c1">#     cumulative_sum = np.cumsum(np.insert(MCS_TEST, 0, 0))</span>
    <span class="c1">#     moving_averages = (cumulative_sum[window_length:] - cumulative_sum[:-window_length]) / window_length</span>
    <span class="c1">#     if ob == 16:</span>
    <span class="c1">#         stop()</span>
        <span class="k">if</span> <span class="n">np</span><span class="o">.</span><span class="n">max</span><span class="p">(</span><span class="n">MCS_test</span><span class="p">)</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">MCS_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]])</span>
            <span class="n">TMP</span> <span class="o">=</span> <span class="n">TMP</span> <span class="o">+</span> <span class="n">ObjACT</span>
            <span class="n">MCS_obj</span><span class="p">[</span><span class="n">Objects</span><span class="p">[</span><span class="n">ii</span><span class="p">]]</span> <span class="o">=</span> <span class="n">TMP</span>
        <span class="k">else</span><span class="p">:</span>
            <span class="k">continue</span>

    <span class="n">MCS_obj</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">MCS_obj</span><span class="p">,</span>
                                   <span class="n">dT</span><span class="p">,</span>
                            <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MCS_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>  

    <span class="k">return</span> <span class="n">PR_objects</span><span class="p">,</span> <span class="n">MCS_obj</span></div>


<div class="viewcode-block" id="track_tropwaves"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.track_tropwaves">[docs]</a><span class="k">def</span> <span class="nf">track_tropwaves</span><span class="p">(</span><span class="n">pr</span><span class="p">,</span>
                   <span class="n">Lat</span><span class="p">,</span>
                   <span class="n">connectLon</span><span class="p">,</span>
                   <span class="n">dT</span><span class="p">):</span>
<span class="w">    </span><span class="sd">&quot;&quot;&quot; Identifies and tracks four types of tropical waves from</span>
<span class="sd">        hourly precipitation data:</span>
<span class="sd">        Mixed Rossby Gravity Waves</span>
<span class="sd">        n&gt;=0 Eastward Inertio Gravirt Wave</span>
<span class="sd">        Kelvin Waves</span>
<span class="sd">        and n&gt;=1 Inertio Gravirt Wave</span>
<span class="sd">    &quot;&quot;&quot;</span>
    
    
    <span class="kn">from</span> <span class="nn">Tracking_Functions</span> <span class="kn">import</span> <span class="n">interpolate_numba</span>
    <span class="kn">from</span> <span class="nn">Tracking_Functions</span> <span class="kn">import</span> <span class="n">KFfilter</span>
    <span class="kn">from</span> <span class="nn">Tracking_Functions</span> <span class="kn">import</span> <span class="n">clean_up_objects</span>
    <span class="kn">from</span> <span class="nn">Tracking_Functions</span> <span class="kn">import</span> <span class="n">BreakupObjects</span>
    <span class="kn">from</span> <span class="nn">Tracking_Functions</span> <span class="kn">import</span> <span class="n">ConnectLon_on_timestep</span>

    <span class="n">pr_eq</span> <span class="o">=</span> <span class="n">pr</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
    <span class="n">pr_eq</span><span class="p">[:,</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">[:,</span><span class="mi">0</span><span class="p">])</span> <span class="o">&gt;</span> <span class="mi">20</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    
    <span class="n">pr_eq</span> <span class="o">=</span> <span class="n">interpolate_numba</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pr_eq</span><span class="p">))</span>
    <span class="n">tropical_waves</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="p">(</span><span class="n">pr_eq</span><span class="p">,</span>
                     <span class="nb">int</span><span class="p">(</span><span class="mi">24</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

    <span class="n">er</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">erfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">,</span> <span class="n">fmin</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">fmax</span><span class="o">=</span><span class="kc">None</span><span class="p">,</span> <span class="n">kmin</span><span class="o">=-</span><span class="mi">10</span><span class="p">,</span> <span class="n">kmax</span><span class="o">=-</span><span class="mi">1</span><span class="p">,</span> <span class="n">hmin</span><span class="o">=</span><span class="mi">0</span><span class="p">,</span> <span class="n">hmax</span><span class="o">=</span><span class="mi">90</span><span class="p">,</span> <span class="n">n</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span> <span class="c1"># had to set hmin from 8 to 0</span>
    <span class="n">eig0</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">eig0filter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
    <span class="n">kelvin</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">kelvinfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
    <span class="n">igw</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">igfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>
    <span class="n">mrg</span> <span class="o">=</span> <span class="n">KFfilter</span><span class="o">.</span><span class="n">mrgfilter</span><span class="p">(</span><span class="n">tropical_waves</span><span class="p">)</span>

    <span class="n">er_mask</span> <span class="o">=</span> <span class="n">er</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
    <span class="n">mrg_mask</span> <span class="o">=</span> <span class="n">mrg</span> <span class="o">&gt;</span> <span class="mf">0.05</span>
    <span class="n">igw_mask</span> <span class="o">=</span> <span class="n">igw</span> <span class="o">&gt;</span> <span class="mf">0.2</span>
    <span class="n">kelvin_mask</span> <span class="o">=</span> <span class="n">kelvin</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
    <span class="n">eig0_mask</span> <span class="o">=</span> <span class="n">eig0</span> <span class="o">&gt;</span> <span class="mf">0.1</span>
    <span class="n">wave_names</span> <span class="o">=</span> <span class="p">[</span><span class="s1">&#39;ER&#39;</span><span class="p">,</span><span class="s1">&#39;MRG&#39;</span><span class="p">,</span><span class="s1">&#39;IGW&#39;</span><span class="p">,</span><span class="s1">&#39;Kelvin&#39;</span><span class="p">,</span><span class="s1">&#39;Eig0&#39;</span><span class="p">]</span>

    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        track tropical waves&#39;</span><span class="p">)</span>
    <span class="n">rgiObj_Struct</span><span class="o">=</span><span class="n">np</span><span class="o">.</span><span class="n">zeros</span><span class="p">((</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">,</span><span class="mi">3</span><span class="p">));</span> <span class="n">rgiObj_Struct</span><span class="p">[:,:,:]</span><span class="o">=</span><span class="mi">1</span>
    <span class="k">for</span> <span class="n">wa</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="mi">5</span><span class="p">):</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;            work on &#39;</span><span class="o">+</span><span class="n">wave_names</span><span class="p">[</span><span class="n">wa</span><span class="p">])</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">er_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">mrg_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">igw_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">kelvin_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">elif</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">wave</span> <span class="o">=</span> <span class="n">eig0_mask</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="n">rgiObjectsUD</span><span class="p">,</span> <span class="n">nr_objectsUD</span> <span class="o">=</span> <span class="n">ndimage</span><span class="o">.</span><span class="n">label</span><span class="p">(</span><span class="n">wave</span><span class="p">,</span> <span class="n">structure</span><span class="o">=</span><span class="n">rgiObj_Struct</span><span class="p">)</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                &#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">nr_objectsUD</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39; object found&#39;</span><span class="p">)</span>

        <span class="n">wave_objects</span><span class="p">,</span> <span class="n">_</span> <span class="o">=</span> <span class="n">clean_up_objects</span><span class="p">(</span><span class="n">rgiObjectsUD</span><span class="p">,</span>
                              <span class="n">dT</span><span class="p">,</span>
                              <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                break up long tropical waves that heve many elements&#39;</span><span class="p">)</span>
        <span class="n">wave_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">BreakupObjects</span><span class="p">(</span><span class="n">wave_objects</span><span class="p">,</span>
                                    <span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                    <span class="n">dT</span><span class="p">)</span>
        <span class="k">if</span> <span class="n">connectLon</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;                connect waves objects over date line&#39;</span><span class="p">)</span>
            <span class="n">wave_objects</span> <span class="o">=</span> <span class="n">ConnectLon_on_timestep</span><span class="p">(</span><span class="n">wave_objects</span><span class="p">)</span>

        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">0</span><span class="p">:</span>
            <span class="n">er_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">1</span><span class="p">:</span>
            <span class="n">mrg_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">2</span><span class="p">:</span>
            <span class="n">igw_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">3</span><span class="p">:</span>
            <span class="n">kelvin_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>
        <span class="k">if</span> <span class="n">wa</span> <span class="o">==</span> <span class="mi">4</span><span class="p">:</span>
            <span class="n">eig0_objects</span> <span class="o">=</span> <span class="n">wave_objects</span><span class="o">.</span><span class="n">copy</span><span class="p">()</span>

    <span class="k">del</span> <span class="n">wave</span>
    <span class="k">del</span> <span class="n">wave_objects</span>
    <span class="k">del</span> <span class="n">pr_eq</span>

    <span class="k">return</span> <span class="n">mrg_objects</span><span class="p">,</span> <span class="n">igw_objects</span><span class="p">,</span> <span class="n">kelvin_objects</span><span class="p">,</span> <span class="n">eig0_objects</span><span class="p">,</span> <span class="n">er_objects</span></div>





<div class="viewcode-block" id="moaap"><a class="viewcode-back" href="../../src.html#src.Tracking_Functions.moaap">[docs]</a><span class="k">def</span> <span class="nf">moaap</span><span class="p">(</span>
    <span class="n">Lon</span><span class="p">,</span>                           <span class="c1"># 2D longitude grid centers</span>
    <span class="n">Lat</span><span class="p">,</span>                           <span class="c1"># 2D latitude grid spacing</span>
    <span class="n">Time</span><span class="p">,</span>                          <span class="c1"># datetime vector of data</span>
    <span class="n">dT</span><span class="p">,</span>                            <span class="c1"># integer - temporal frequency of data [hour]</span>
    <span class="n">Mask</span><span class="p">,</span>                          <span class="c1"># mask with dimensions [lat,lon] defining analysis region</span>
    <span class="n">v850</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># 850 hPa zonal wind speed [m/s]</span>
    <span class="n">u850</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># 850 hPa meridional wind speed [m/s]</span>
    <span class="n">t850</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># 850 hPa air temperature [K]</span>
    <span class="n">q850</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># 850 hPa mixing ratio [g/kg]</span>
    <span class="n">slp</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>  <span class="c1"># sea level pressure [Pa]</span>
    <span class="n">ivte</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># zonal integrated vapor transport [kg m-1 s-1]</span>
    <span class="n">ivtn</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># meridional integrated vapor transport [kg m-1 s-1]</span>
    <span class="n">z500</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># geopotential height [gpm]</span>
    <span class="n">v200</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># 200 hPa zonal wind speed [m/s]</span>
    <span class="n">u200</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># 200 hPa meridional wind speed [m/s]</span>
    <span class="n">pr</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># accumulated surface precipitation [mm/time]</span>
    <span class="n">tb</span>   <span class="o">=</span> <span class="kc">None</span><span class="p">,</span> <span class="c1"># brightness temperature [K]</span>
    <span class="n">DataName</span> <span class="o">=</span> <span class="s1">&#39;&#39;</span><span class="p">,</span>                 <span class="c1"># name of the common grid</span>
    <span class="n">OutputFolder</span><span class="o">=</span><span class="s1">&#39;&#39;</span><span class="p">,</span>               <span class="c1"># string containing the output directory path. Default is local directory</span>
    <span class="n">regular_Lat</span> <span class="o">=</span> <span class="kc">None</span><span class="p">,</span>
    <span class="n">regular_Lon</span> <span class="o">=</span><span class="kc">None</span><span class="p">,</span>
    <span class="c1"># minimum precip. obj.</span>
    <span class="n">SmoothSigmaP</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>              <span class="c1"># Gaussion std for precipitation smoothing</span>
    <span class="n">Pthreshold</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>                <span class="c1"># precipitation threshold [mm/h]</span>
    <span class="n">MinTimePR</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>                 <span class="c1"># minimum lifetime of precip. features in hours</span>
    <span class="n">MinAreaPR</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>              <span class="c1"># minimum area of precipitation features [km2]</span>
    <span class="c1"># minimum Moisture Stream </span>
    <span class="n">MinTimeMS</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>                 <span class="c1"># minimum lifetime for moisture stream [hours]</span>
    <span class="n">MinAreaMS</span> <span class="o">=</span> <span class="mi">100000</span><span class="p">,</span>            <span class="c1"># mimimum area of moisture stream [km2]</span>
    <span class="n">MinMSthreshold</span> <span class="o">=</span> <span class="mf">0.13</span><span class="p">,</span>         <span class="c1"># treshold for moisture stream [g*m/g*s]</span>
    <span class="c1"># cyclone tracking</span>
    <span class="n">MinTimeCY</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>                <span class="c1"># minimum livetime of cyclones [hours]</span>
    <span class="n">MaxPresAnCY</span> <span class="o">=</span> <span class="o">-</span><span class="mi">8</span><span class="p">,</span>              <span class="c1"># preshure thershold for cyclone anomaly [hPa]</span>
    <span class="c1"># anty cyclone tracking</span>
    <span class="n">MinTimeACY</span> <span class="o">=</span> <span class="mi">12</span><span class="p">,</span>               <span class="c1"># minimum livetime of anticyclone [hours]</span>
    <span class="n">MinPresAnACY</span> <span class="o">=</span> <span class="mi">6</span><span class="p">,</span>              <span class="c1"># preshure thershold for anti cyclone anomaly [hPa]</span>
    <span class="c1"># Frontal zones</span>
    <span class="n">MinAreaFR</span> <span class="o">=</span> <span class="mi">50000</span><span class="p">,</span>             <span class="c1"># mimimum size of frontal zones [km2]</span>
    <span class="n">front_treshold</span> <span class="o">=</span> <span class="mi">1</span><span class="p">,</span>            <span class="c1"># threshold for masking frontal zones</span>
    <span class="c1"># Cloud tracking setup</span>
    <span class="n">SmoothSigmaC</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>              <span class="c1"># standard deviation of Gaussian filter for cloud tracking</span>
    <span class="n">Cthreshold</span> <span class="o">=</span> <span class="mi">241</span><span class="p">,</span>              <span class="c1"># brightness temperature threshold for cloud tracking [K]</span>
    <span class="n">MinTimeC</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>                  <span class="c1"># mimimum livetime of ice cloud shields [hours]</span>
    <span class="n">MinAreaC</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">,</span>              <span class="c1"># mimimum area of ice cloud shields [km2]</span>
    <span class="c1"># AR tracking</span>
    <span class="n">IVTtrheshold</span> <span class="o">=</span> <span class="mi">500</span><span class="p">,</span>            <span class="c1"># Integrated water vapor transport threshold for AR detection [kg m-1 s-1]</span>
    <span class="n">MinTimeIVT</span> <span class="o">=</span> <span class="mi">9</span><span class="p">,</span>                <span class="c1"># minimum livetime of ARs [hours]</span>
    <span class="n">AR_MinLen</span> <span class="o">=</span> <span class="mi">2000</span><span class="p">,</span>              <span class="c1"># mimimum length of an AR [km]</span>
    <span class="n">AR_Lat</span> <span class="o">=</span> <span class="mi">20</span><span class="p">,</span>                   <span class="c1"># AR centroids have to be poeward of this latitude</span>
    <span class="n">AR_width_lenght_ratio</span> <span class="o">=</span> <span class="mi">2</span><span class="p">,</span>     <span class="c1"># mimimum length to width ratio of AR</span>
    <span class="c1"># TC detection</span>
    <span class="n">TC_Pmin</span> <span class="o">=</span> <span class="mi">995</span><span class="p">,</span>                 <span class="c1"># mimimum pressure for TC detection [hPa]</span>
    <span class="n">TC_lat_genesis</span> <span class="o">=</span> <span class="mi">35</span><span class="p">,</span>           <span class="c1"># maximum latitude for TC genesis [absolute degree latitude]</span>
    <span class="n">TC_lat_max</span> <span class="o">=</span> <span class="mi">60</span><span class="p">,</span>               <span class="c1"># maximum latitude for TC existance [absolute degree latitude]</span>
    <span class="n">TC_deltaT_core</span> <span class="o">=</span> <span class="mi">0</span><span class="p">,</span>            <span class="c1"># minimum degrees difference between TC core and surrounding [K]</span>
    <span class="n">TC_T850min</span> <span class="o">=</span> <span class="mi">285</span><span class="p">,</span>              <span class="c1"># minimum temperature of TC core at 850hPa [K]</span>
    <span class="n">TC_minBT</span> <span class="o">=</span> <span class="mi">241</span><span class="p">,</span>                <span class="c1"># minimum average cloud top brightness temperature [K]</span>
    <span class="c1"># MCs detection</span>
    <span class="n">MCS_Minsize</span> <span class="o">=</span> <span class="mi">5000</span><span class="p">,</span>            <span class="c1"># minimum size of precipitation area [km2] </span>
    <span class="n">MCS_minPR</span> <span class="o">=</span> <span class="mi">15</span><span class="p">,</span>                <span class="c1"># minimum precipitation threshold [mm/h]</span>
    <span class="n">CL_MaxT</span> <span class="o">=</span> <span class="mi">215</span><span class="p">,</span>                 <span class="c1"># minimum brightness temperature in ice shield [K]</span>
    <span class="n">CL_Area</span> <span class="o">=</span> <span class="mi">40000</span><span class="p">,</span>               <span class="c1"># minimum cloud area size [km2]</span>
    <span class="n">MCS_minTime</span> <span class="o">=</span> <span class="mi">4</span><span class="p">,</span>               <span class="c1"># minimum lifetime of MCS [hours]</span>
    <span class="n">js_min_anomaly</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>           <span class="c1"># jet minimal anomaly [m/s]</span>
    <span class="n">MinTimeJS</span> <span class="o">=</span> <span class="mi">24</span><span class="p">,</span>                <span class="c1"># minimum lifetime of jets [h]</span>
    <span class="n">tropwave_minTime</span> <span class="o">=</span> <span class="mi">48</span><span class="p">,</span>          <span class="c1"># minimum lifetime of tropical waves [h]</span>
    <span class="n">dict_keys_offset</span> <span class="o">=</span> <span class="mi">0</span>            <span class="c1"># offset constant added to the label keys in the final dict</span>
    <span class="p">):</span>
    
    <span class="c1"># calculate grid spacing assuming regular lat/lon grid</span>
    <span class="n">_</span><span class="p">,</span><span class="n">_</span><span class="p">,</span><span class="n">Area</span><span class="p">,</span><span class="n">Gridspacing</span> <span class="o">=</span> <span class="n">calc_grid_distance_area</span><span class="p">(</span><span class="n">Lon</span><span class="p">,</span><span class="n">Lat</span><span class="p">)</span>
    <span class="n">Area</span><span class="p">[</span><span class="n">Area</span> <span class="o">&lt;</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
    <span class="c1">### JLa</span>
    <span class="c1"># Area=Area.T</span>
   
    <span class="n">EarthCircum</span> <span class="o">=</span> <span class="mi">40075000</span> <span class="c1">#[m]</span>
    <span class="n">Lat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span>
    <span class="n">Lon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Lon</span><span class="p">)</span>
    <span class="n">dLat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Lon</span><span class="p">);</span> <span class="n">dLat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">EarthCircum</span><span class="o">/</span><span class="p">(</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Lat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">dLon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Lon</span><span class="p">)</span>
    <span class="k">for</span> <span class="n">la</span> <span class="ow">in</span> <span class="nb">range</span><span class="p">(</span><span class="n">Lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">]):</span>
        <span class="n">dLon</span><span class="p">[</span><span class="n">la</span><span class="p">,:]</span> <span class="o">=</span> <span class="n">EarthCircum</span><span class="o">/</span><span class="p">(</span><span class="mi">360</span><span class="o">/</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="mi">1</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span><span class="o">-</span><span class="n">Lat</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span><span class="o">*</span><span class="n">np</span><span class="o">.</span><span class="n">cos</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Lat</span><span class="p">[</span><span class="n">la</span><span class="p">,</span><span class="mi">0</span><span class="p">]))</span>
    <span class="n">dLat</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dLat</span><span class="p">)</span>
    <span class="n">dLon</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">dLon</span><span class="p">)</span>
    
    <span class="n">StartDay</span> <span class="o">=</span> <span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span>
    <span class="c1">#SetupString = DataName+&#39;_dt-&#39;+str(dT)+&#39;h_MOAAP-masks&#39;</span>
    <span class="n">SetupString</span> <span class="o">=</span> <span class="n">DataName</span>
    <span class="n">NCfile</span> <span class="o">=</span> <span class="n">OutputFolder</span> <span class="o">+</span><span class="s1">&#39;ObjectMasks_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="o">+</span><span class="s1">&#39;.nc&#39;</span>
    <span class="c1">#NCfile = OutputFolder + str(StartDay.year)+str(StartDay.month).zfill(2)+&#39;_&#39;+DataName+&#39;_ObjectMasks_&#39;+SetupString+&#39;.nc&#39;</span>
    <span class="n">FrontMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Mask</span><span class="p">)</span>
    <span class="n">FrontMask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>

    <span class="c1"># connect over date line?</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="mi">0</span><span class="p">]</span> <span class="o">&lt;</span> <span class="o">-</span><span class="mi">176</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">Lon</span><span class="p">[</span><span class="mi">0</span><span class="p">,</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span> <span class="o">&gt;</span> <span class="mi">176</span><span class="p">):</span>
        <span class="n">connectLon</span><span class="o">=</span> <span class="mi">1</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">connectLon</span><span class="o">=</span> <span class="mi">0</span>


    <span class="c1">### print out which phenomenon can be investigated</span>
    <span class="k">if</span> <span class="n">slp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">slp_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">slp_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">ivte</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">ivtn</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">ar_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ar_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">t850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">front_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">front_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">slp</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> \
       <span class="o">&amp;</span> <span class="p">(</span><span class="n">t850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">pr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">tc_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">tc_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="n">z500</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">:</span>
        <span class="n">z500_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">z500_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">z500</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">front_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">)</span> <span class="o">&amp;</span> \
       <span class="p">(</span><span class="n">u200</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">col_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">col_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">v200</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">u200</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">jet_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">jet_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">tb</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">mcs_tb_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">mcs_tb_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">q850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> <span class="p">(</span><span class="n">v850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">)</span> <span class="o">&amp;</span> \
       <span class="p">(</span><span class="n">u850</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">ms_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ms_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    <span class="k">if</span> <span class="p">(</span><span class="n">pr</span> <span class="ow">is</span> <span class="ow">not</span> <span class="kc">None</span><span class="p">):</span>
        <span class="n">ew_test</span> <span class="o">=</span> <span class="s1">&#39;yes&#39;</span>
    <span class="k">else</span><span class="p">:</span>
        <span class="n">ew_test</span> <span class="o">=</span> <span class="s1">&#39;no&#39;</span>
    
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;The provided variables allow tracking the following phenomena&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;|  phenomenon  | tracking |&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Jetstream   |   &#39;</span> <span class="o">+</span> <span class="n">jet_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   PSL CY/ACY  |   &#39;</span> <span class="o">+</span> <span class="n">slp_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Z500 CY/ACY |   &#39;</span> <span class="o">+</span> <span class="n">z500_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   COLs        |   &#39;</span> <span class="o">+</span> <span class="n">col_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   IVT ARs     |   &#39;</span> <span class="o">+</span> <span class="n">ar_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   MS ARs      |   &#39;</span> <span class="o">+</span> <span class="n">ms_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Fronts      |   &#39;</span> <span class="o">+</span> <span class="n">front_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   TCs         |   &#39;</span> <span class="o">+</span> <span class="n">tc_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   MCSs        |   &#39;</span> <span class="o">+</span> <span class="n">mcs_tb_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;   Equ. Waves  |   &#39;</span> <span class="o">+</span> <span class="n">ew_test</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;---------------------------&#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    
    <span class="kn">import</span> <span class="nn">time</span>
    
    <span class="c1"># Mask data outside of Focus domain</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v850</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">u850</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">t850</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">q850</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">slp</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>  <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ivte</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">ivtn</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">z500</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">v200</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">u200</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">pr</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>
    <span class="k">try</span><span class="p">:</span>
        <span class="n">tb</span><span class="p">[:,</span><span class="n">Mask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span>   <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">nan</span>
    <span class="k">except</span><span class="p">:</span>
        <span class="k">pass</span>

    <span class="k">if</span> <span class="n">jet_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; track jetstream&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">uv200</span> <span class="o">=</span> <span class="p">(</span><span class="n">u200</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">v200</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

        <span class="n">jet_objects</span><span class="p">,</span> <span class="n">object_split</span> <span class="o">=</span> <span class="n">jetstream_tracking</span><span class="p">(</span><span class="n">uv200</span><span class="p">,</span>
                                      <span class="n">js_min_anomaly</span><span class="p">,</span>
                                      <span class="n">MinTimeJS</span><span class="p">,</span>
                                      <span class="n">dT</span><span class="p">,</span>
                                      <span class="n">Gridspacing</span><span class="p">,</span>
                                      <span class="n">connectLon</span><span class="p">)</span>
        <span class="n">jet_objects_characteristics</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">jet_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">uv200</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;jet_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeJS</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                     <span class="n">split_merge</span> <span class="o">=</span> <span class="n">object_split</span><span class="p">)</span>
        
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="n">ew_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; track tropical waves&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">mrg_objects</span><span class="p">,</span> <span class="n">igw_objects</span><span class="p">,</span> <span class="n">kelvin_objects</span><span class="p">,</span> <span class="n">eig0_objects</span><span class="p">,</span> <span class="n">er_objects</span> <span class="o">=</span> <span class="n">track_tropwaves</span><span class="p">(</span>
                        <span class="n">pr</span><span class="p">,</span>
                        <span class="n">Lat</span><span class="p">,</span>
                        <span class="n">connectLon</span><span class="p">,</span>
                        <span class="n">dT</span>
                        <span class="p">)</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        
        <span class="n">gr_mrg</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">mrg_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">pr</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;MRG_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">tropwave_minTime</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="n">gr_igw</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">igw_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">pr</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;IGW_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="n">gr_kelvin</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">kelvin_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">pr</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;Kelvin_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="n">gr_eig0</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">eig0_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">pr</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;Eig0_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="n">gr_er</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">er_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">pr</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;ER_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="mi">48</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        
    <span class="k">if</span> <span class="n">ms_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; track moisture streams and atmospheric rivers (ARs)&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">VapTrans</span> <span class="o">=</span> <span class="p">((</span><span class="n">u850</span> <span class="o">*</span> <span class="n">q850</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> 
                    <span class="p">(</span><span class="n">v850</span> <span class="o">*</span> <span class="n">q850</span><span class="p">)</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span><span class="o">**</span><span class="p">(</span><span class="mi">1</span><span class="o">/</span><span class="mi">2</span><span class="p">)</span>
        
        <span class="n">MS_objects</span> <span class="o">=</span> <span class="n">ar_850hpa_tracking</span><span class="p">(</span>
                                        <span class="n">VapTrans</span><span class="p">,</span>
                                        <span class="n">MinMSthreshold</span><span class="p">,</span>
                                        <span class="n">MinTimeMS</span><span class="p">,</span>
                                        <span class="n">MinAreaMS</span><span class="p">,</span>
                                        <span class="n">Area</span><span class="p">,</span>
                                        <span class="n">dT</span><span class="p">,</span>
                                        <span class="n">connectLon</span><span class="p">)</span>
        
        <span class="n">grMSs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">MS_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">VapTrans</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;MS850_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>        <span class="c1"># output file name and locaiton</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeMS</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        
    
    <span class="k">if</span> <span class="n">ar_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; track IVT streams and atmospheric rivers (ARs)&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">IVT</span> <span class="o">=</span> <span class="p">(</span><span class="n">ivte</span> <span class="o">**</span> <span class="mi">2</span> <span class="o">+</span> <span class="n">ivtn</span> <span class="o">**</span> <span class="mi">2</span><span class="p">)</span> <span class="o">**</span> <span class="mf">0.5</span>

        <span class="n">IVT_objects</span><span class="p">,</span> <span class="n">object_split_info</span> <span class="o">=</span> <span class="n">ar_ivt_tracking</span><span class="p">(</span><span class="n">IVT</span><span class="p">,</span>
                                    <span class="n">IVTtrheshold</span><span class="p">,</span>
                                    <span class="n">MinTimeIVT</span><span class="p">,</span>
                                    <span class="n">dT</span><span class="p">,</span>
                                    <span class="n">connectLon</span><span class="p">,</span>
                                    <span class="n">Time</span><span class="p">)</span> <span class="c1"># JLa: added object_split, Time</span>
                                           <span class="c1"># JRie added object_split_info)</span>

        <span class="c1">#moaap.var_IVT_objects=IVT_objects</span>
        <span class="c1">#moaap.var_IVT=IVT</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_OutputFolder</span><span class="o">=</span><span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;IVT_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_Time</span><span class="o">=</span><span class="n">Time</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_Lat</span><span class="o">=</span><span class="n">Lat</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_Lon</span><span class="o">=</span><span class="n">Lon</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_Gridspacing</span><span class="o">=</span><span class="n">Gridspacing</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_Area</span><span class="o">=</span><span class="n">Area</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">)</span>
        <span class="n">moaap</span><span class="o">.</span><span class="n">var_object_split</span> <span class="o">=</span> <span class="n">object_split_info</span> <span class="c1">#JRie</span>
        <span class="nb">print</span> <span class="p">(</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>

        <span class="n">grIVTs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">IVT</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;IVT_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeIVT</span><span class="o">/</span><span class="n">dT</span><span class="p">),</span>
                                     <span class="n">dict_keys_offset</span><span class="o">=</span><span class="n">dict_keys_offset</span><span class="p">,</span>
                                    <span class="n">split_merge</span> <span class="o">=</span> <span class="n">object_split_info</span><span class="p">)</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;        check if MSs quallify as ARs&#39;</span><span class="p">)</span>
        <span class="n">AR_obj</span> <span class="o">=</span> <span class="n">ar_check</span><span class="p">(</span><span class="n">IVT_objects</span><span class="p">,</span>
                         <span class="n">AR_Lat</span><span class="p">,</span>
                         <span class="n">AR_width_lenght_ratio</span><span class="p">,</span>
                         <span class="n">AR_MinLen</span><span class="p">,</span>
                         <span class="n">Lon</span><span class="p">,</span>
                         <span class="n">Lat</span><span class="p">)</span>
    
        <span class="n">grACs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">AR_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                         <span class="n">IVT</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                         <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;ARs_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                         <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                         <span class="n">Gridspacing</span><span class="p">,</span>
                         <span class="n">Area</span><span class="p">,</span>
                         <span class="c1">#split_merge = object_split_info,</span>
                         <span class="n">dict_keys_offset</span> <span class="o">=</span> <span class="n">dict_keys_offset</span><span class="p">)</span> <span class="c1"># JRie</span>

        <span class="n">AR_obj</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">AR_obj</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">AR_obj</span><span class="p">,</span><span class="n">AR_obj</span><span class="o">+</span><span class="n">dict_keys_offset</span><span class="p">)</span> <span class="c1"># add offset to elements in order to differentiate between objects of different years</span>
        <span class="n">IVT_objects</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">where</span><span class="p">(</span><span class="n">IVT_objects</span><span class="o">==</span><span class="mi">0</span><span class="p">,</span><span class="n">IVT_objects</span><span class="p">,</span><span class="n">IVT_objects</span><span class="o">+</span><span class="n">dict_keys_offset</span><span class="p">)</span> <span class="c1"># add offset to elements in order to differentiate between objects of different years</span>
        <span class="c1"># JLa indent</span>
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
    
    <span class="k">if</span> <span class="n">front_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; identify frontal zones&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>

        
        <span class="c1"># -------</span>
        <span class="n">dx</span> <span class="o">=</span> <span class="n">dLon</span>
        <span class="n">dy</span> <span class="o">=</span> <span class="n">dLat</span>
        <span class="n">du</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">u850</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">dv</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">v850</span><span class="p">)</span> <span class="p">)</span>
        <span class="n">PV</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span> <span class="n">dv</span><span class="p">[</span><span class="o">-</span><span class="mi">1</span><span class="p">]</span><span class="o">/</span><span class="n">dx</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="o">-</span> <span class="n">du</span><span class="p">[</span><span class="o">-</span><span class="mi">2</span><span class="p">]</span><span class="o">/</span><span class="n">dy</span><span class="p">[</span><span class="kc">None</span><span class="p">,:]</span> <span class="p">)</span>
        <span class="n">vgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">gradient</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">t850</span><span class="p">),</span> <span class="n">axis</span><span class="o">=</span><span class="p">(</span><span class="mi">1</span><span class="p">,</span><span class="mi">2</span><span class="p">))</span>
        <span class="n">Tgrad</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">sqrt</span><span class="p">(</span><span class="n">vgrad</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span> <span class="o">+</span> <span class="n">vgrad</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span><span class="o">**</span><span class="mi">2</span><span class="p">)</span>

        <span class="n">Fstar</span> <span class="o">=</span> <span class="n">PV</span> <span class="o">*</span> <span class="n">Tgrad</span>

        <span class="n">Tgrad_zero</span> <span class="o">=</span> <span class="mf">0.45</span> <span class="c1">#*100/(np.mean([dLon,dLat], axis=0)/1000.)  # 0.45 K/(100 km)</span>
        <span class="kn">import</span> <span class="nn">metpy.calc</span> <span class="k">as</span> <span class="nn">calc</span>
        <span class="kn">from</span> <span class="nn">metpy.units</span> <span class="kn">import</span> <span class="n">units</span>
        <span class="n">CoriolisPar</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">calc</span><span class="o">.</span><span class="n">coriolis_parameter</span><span class="p">(</span><span class="n">np</span><span class="o">.</span><span class="n">deg2rad</span><span class="p">(</span><span class="n">Lat</span><span class="p">)))</span>
        <span class="n">Frontal_Diagnostic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">Fstar</span><span class="o">/</span><span class="p">(</span><span class="n">CoriolisPar</span> <span class="o">*</span> <span class="n">Tgrad_zero</span><span class="p">))</span>
        
        <span class="n">FrontMask</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">copy</span><span class="p">(</span><span class="n">Mask</span><span class="p">)</span>
        <span class="n">FrontMask</span><span class="p">[</span><span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Lat</span><span class="p">)</span> <span class="o">&lt;</span> <span class="mi">10</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        
        <span class="n">Frontal_Diagnostic</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">abs</span><span class="p">(</span><span class="n">Frontal_Diagnostic</span><span class="p">)</span>
        <span class="n">Frontal_Diagnostic</span><span class="p">[:,</span><span class="n">FrontMask</span> <span class="o">==</span> <span class="mi">0</span><span class="p">]</span> <span class="o">=</span> <span class="mi">0</span>
        <span class="c1"># -------</span>
        
        
        <span class="n">FR_objects</span> <span class="o">=</span> <span class="n">frontal_identification</span><span class="p">(</span><span class="n">Frontal_Diagnostic</span><span class="p">,</span>
                              <span class="n">front_treshold</span><span class="p">,</span>
                              <span class="n">MinAreaFR</span><span class="p">,</span>
                              <span class="n">Area</span><span class="p">)</span>
        
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>
        
        
    <span class="k">if</span> <span class="n">slp_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; track cyclones from PSL&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        
        <span class="n">CY_objects</span><span class="p">,</span> <span class="n">ACY_objects</span><span class="o">=</span> <span class="n">cy_acy_psl_tracking</span><span class="p">(</span>
                                                    <span class="n">slp</span><span class="p">,</span>
                                                    <span class="n">MaxPresAnCY</span><span class="p">,</span>
                                                    <span class="n">MinTimeCY</span><span class="p">,</span>
                                                    <span class="n">MinPresAnACY</span><span class="p">,</span>
                                                    <span class="n">MinTimeACY</span><span class="p">,</span>
                                                    <span class="n">dT</span><span class="p">,</span>
                                                    <span class="n">Gridspacing</span><span class="p">,</span>
                                                    <span class="n">connectLon</span>
                                                    <span class="p">)</span>

        <span class="n">grCyclonesPT</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                         <span class="n">slp</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                         <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;CY_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                         <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                         <span class="n">Gridspacing</span><span class="p">,</span>
                                         <span class="n">Area</span><span class="p">,</span>
                                         <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 

        <span class="n">grACyclonesPT</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">ACY_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                         <span class="n">slp</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                         <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;ACY_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                         <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                         <span class="n">Gridspacing</span><span class="p">,</span>
                                         <span class="n">Area</span><span class="p">,</span>
                                         <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">z500_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; track cyclones from Z500&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        
        <span class="n">cy_z500_objects</span><span class="p">,</span> <span class="n">acy_z500_objects</span> <span class="o">=</span> <span class="n">cy_acy_z500_tracking</span><span class="p">(</span>
                                            <span class="n">z500</span><span class="p">,</span>
                                            <span class="n">MinTimeCY</span><span class="p">,</span>
                                            <span class="n">dT</span><span class="p">,</span>
                                            <span class="n">Gridspacing</span><span class="p">,</span>
                                            <span class="n">connectLon</span>
                                            <span class="p">)</span>
        
        <span class="n">cy_z500_objects_characteristics</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                     <span class="n">z500</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                     <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;CY-z500_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                     <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                     <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                     <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                     <span class="n">Gridspacing</span><span class="p">,</span>
                                     <span class="n">Area</span><span class="p">,</span>
                                     <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>
        
        <span class="n">acy_z500_objects_characteristics</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">acy_z500_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                                 <span class="n">z500</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                                 <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;ACY-z500_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                                 <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                                 <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                                 <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                                 <span class="n">Gridspacing</span><span class="p">,</span>
                                 <span class="n">Area</span><span class="p">,</span>
                                 <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeCY</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span> 
        
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;    Check if cyclones qualify as Cut Off Low (COL)&#39;</span><span class="p">)</span>
        <span class="n">col_obj</span> <span class="o">=</span> <span class="n">col_identification</span><span class="p">(</span><span class="n">cy_z500_objects</span><span class="p">,</span>
                               <span class="n">z500</span><span class="p">,</span>
                               <span class="n">u200</span><span class="p">,</span>
                               <span class="n">Frontal_Diagnostic</span><span class="p">,</span>
                               <span class="n">MinTimeC</span><span class="p">,</span>
                               <span class="n">dx</span><span class="p">,</span>
                               <span class="n">dy</span><span class="p">,</span>
                               <span class="n">Lon</span><span class="p">,</span>
                               <span class="n">Lat</span><span class="p">)</span>
        
        <span class="n">col_stats</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">col_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                         <span class="n">z500</span><span class="o">*</span><span class="mf">9.81</span><span class="p">,</span>            <span class="c1"># original file used for feature detection</span>
                         <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;COL_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                         <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                         <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                         <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                         <span class="n">Gridspacing</span><span class="p">,</span>
                         <span class="n">Area</span><span class="p">,</span>
                         <span class="n">min_tsteps</span><span class="o">=</span><span class="mi">1</span><span class="p">)</span>      <span class="c1"># minimum livetime in hours</span>

        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>


    <span class="k">if</span> <span class="n">mcs_tb_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s2">&quot;======&gt; &#39;check if Tb objects quallify as MCS (or selected storm type)&quot;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">MCS_objects_Tb</span><span class="p">,</span> <span class="n">C_objects</span> <span class="o">=</span> <span class="n">mcs_tb_tracking</span><span class="p">(</span><span class="n">tb</span><span class="p">,</span>
                            <span class="n">pr</span><span class="p">,</span>
                            <span class="n">SmoothSigmaC</span><span class="p">,</span>
                            <span class="n">Pthreshold</span><span class="p">,</span>
                            <span class="n">CL_Area</span><span class="p">,</span>
                            <span class="n">CL_MaxT</span><span class="p">,</span>
                            <span class="n">Cthreshold</span><span class="p">,</span>
                            <span class="n">MinAreaC</span><span class="p">,</span>
                            <span class="n">MinTimeC</span><span class="p">,</span>
                            <span class="n">MCS_minPR</span><span class="p">,</span>
                            <span class="n">MCS_minTime</span><span class="p">,</span>
                            <span class="n">MCS_Minsize</span><span class="p">,</span>
                            <span class="n">dT</span><span class="p">,</span>
                            <span class="n">Area</span><span class="p">,</span>
                            <span class="n">connectLon</span><span class="p">,</span>
                           <span class="p">)</span>
        
        <span class="n">grCs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">C_objects</span><span class="p">,</span> <span class="c1"># feature object file</span>
                             <span class="n">tb</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                             <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;Clouds_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                             <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                             <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                             <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                             <span class="n">Gridspacing</span><span class="p">,</span>
                             <span class="n">Area</span><span class="p">,</span>
                             <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        
        <span class="n">grMCSs_Tb</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span>
            <span class="n">MCS_objects_Tb</span><span class="p">,</span>  <span class="c1"># feature object file</span>
            <span class="n">pr</span><span class="p">,</span>  <span class="c1"># original file used for feature detection</span>
            <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;MCSs_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
            <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
            <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
            <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
            <span class="n">Gridspacing</span><span class="p">,</span>
            <span class="n">Area</span><span class="p">)</span>
        
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

<span class="c1">#     if (mcs_tb_test == &#39;yes&#39;) &amp; (ar_test == &#39;yes&#39;):</span>
<span class="c1">#         start = time.perf_counter()</span>
        
<span class="c1">#         PR_objects, MCS_obj = mcs_pr_tracking(pr,</span>
<span class="c1">#                             tb,</span>
<span class="c1">#                             C_objects,</span>
<span class="c1">#                             AR_obj,</span>
<span class="c1">#                             Area,</span>
<span class="c1">#                             Lon,</span>
<span class="c1">#                             Lat,</span>
<span class="c1">#                             SmoothSigmaP,</span>
<span class="c1">#                             Pthreshold,</span>
<span class="c1">#                             MinTimePR,</span>
<span class="c1">#                             MCS_minPR,</span>
<span class="c1">#                             MCS_Minsize,</span>
<span class="c1">#                             CL_Area,</span>
<span class="c1">#                             CL_MaxT,</span>
<span class="c1">#                             MCS_minTime,</span>
<span class="c1">#                             MinAreaPR,</span>
<span class="c1">#                             dT,</span>
<span class="c1">#                             connectLon)</span>
        
<span class="c1">#         grPRs = calc_object_characteristics(PR_objects, # feature object file</span>
<span class="c1">#                                  pr,         # original file used for feature detection</span>
<span class="c1">#                                  OutputFolder+&#39;PR_&#39;+str(StartDay.year)+str(StartDay.month).zfill(2)+&#39;_&#39;+SetupString,</span>
<span class="c1">#                                  Time,            # timesteps of the data</span>
<span class="c1">#                                  Lat,             # 2D latidudes</span>
<span class="c1">#                                  Lon,             # 2D Longitudes</span>
<span class="c1">#                                  Gridspacing,</span>
<span class="c1">#                                  Area,</span>
<span class="c1">#                                  min_tsteps=int(MinTimePR/dT)) </span>
        
<span class="c1">#         grMCSs = calc_object_characteristics(MCS_obj, # feature object file</span>
<span class="c1">#                              pr,         # original file used for feature detection</span>
<span class="c1">#                              OutputFolder+&#39;MCSs_&#39;+str(StartDay.year)+str(StartDay.month).zfill(2)+&#39;_&#39;+SetupString,</span>
<span class="c1">#                              Time,            # timesteps of the data</span>
<span class="c1">#                              Lat,             # 2D latidudes</span>
<span class="c1">#                              Lon,             # 2D Longitudes</span>
<span class="c1">#                              Gridspacing,</span>
<span class="c1">#                              Area)</span>
        
<span class="c1">#         end = time.perf_counter()</span>
<span class="c1">#         timer(start, end)    </span>
    
    <span class="k">if</span> <span class="n">tc_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;======&gt; Check if cyclones qualify as TCs&#39;</span><span class="p">)</span>
        <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        
        <span class="n">TC_obj</span><span class="p">,</span> <span class="n">TC_Tracks</span> <span class="o">=</span> <span class="n">tc_tracking</span><span class="p">(</span><span class="n">CY_objects</span><span class="p">,</span>
                        <span class="n">t850</span><span class="p">,</span>
                        <span class="n">slp</span><span class="p">,</span>
                        <span class="n">tb</span><span class="p">,</span>
                        <span class="n">C_objects</span><span class="p">,</span>
                        <span class="n">Lon</span><span class="p">,</span>
                        <span class="n">Lat</span><span class="p">,</span>
                        <span class="n">TC_lat_genesis</span><span class="p">,</span>
                        <span class="n">TC_deltaT_core</span><span class="p">,</span>
                        <span class="n">TC_T850min</span><span class="p">,</span>
                        <span class="n">TC_Pmin</span><span class="p">,</span>
                        <span class="n">TC_lat_max</span>
                       <span class="p">)</span>
        
        <span class="n">grTCs</span> <span class="o">=</span> <span class="n">calc_object_characteristics</span><span class="p">(</span><span class="n">TC_obj</span><span class="p">,</span> <span class="c1"># feature object file</span>
                             <span class="n">slp</span><span class="o">*</span><span class="mf">100.</span><span class="p">,</span>         <span class="c1"># original file used for feature detection</span>
                             <span class="n">OutputFolder</span><span class="o">+</span><span class="s1">&#39;TC_&#39;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">StartDay</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_&#39;</span><span class="o">+</span><span class="n">SetupString</span><span class="p">,</span>
                             <span class="n">Time</span><span class="p">,</span>            <span class="c1"># timesteps of the data</span>
                             <span class="n">Lat</span><span class="p">,</span>             <span class="c1"># 2D latidudes</span>
                             <span class="n">Lon</span><span class="p">,</span>             <span class="c1"># 2D Longitudes</span>
                             <span class="n">Gridspacing</span><span class="p">,</span>
                             <span class="n">Area</span><span class="p">,</span>
                             <span class="n">min_tsteps</span><span class="o">=</span><span class="nb">int</span><span class="p">(</span><span class="n">MinTimeC</span><span class="o">/</span><span class="n">dT</span><span class="p">))</span>      <span class="c1"># minimum livetime in hours</span>
        <span class="c1">### SAVE THE TC TRACKS TO PICKL FILE</span>
        <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">OutputFolder</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_TCs_tracks.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">TC_Tracks</span><span class="p">,</span> <span class="n">a_file</span><span class="p">)</span>
        <span class="n">a_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
        <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
        <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>  
    
    


    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39; &#39;</span><span class="p">)</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Save the object masks into a joint netCDF&#39;</span><span class="p">)</span>
    <span class="n">start</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="c1"># ============================</span>
    <span class="c1"># Write NetCDF</span>
    <span class="c1"># iTime = np.array((Time - Time[0]).total_seconds()).astype(&#39;int&#39;)</span>
    <span class="n">iTime</span> <span class="o">=</span> <span class="n">np</span><span class="o">.</span><span class="n">array</span><span class="p">(</span><span class="n">pd</span><span class="o">.</span><span class="n">Series</span><span class="p">((</span><span class="n">Time</span> <span class="o">-</span> <span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]))</span><span class="o">.</span><span class="n">dt</span><span class="o">.</span><span class="n">total_seconds</span><span class="p">()</span><span class="o">.</span><span class="n">values</span><span class="p">)</span><span class="o">.</span><span class="n">astype</span><span class="p">(</span><span class="s1">&#39;int&#39;</span><span class="p">)</span> <span class="c1"># JLa</span>

    <span class="n">dataset</span> <span class="o">=</span> <span class="n">Dataset</span><span class="p">(</span><span class="n">NCfile</span><span class="p">,</span><span class="s1">&#39;w&#39;</span><span class="p">,</span><span class="nb">format</span><span class="o">=</span><span class="s1">&#39;NETCDF4_CLASSIC&#39;</span><span class="p">)</span>
    <span class="n">yc</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span> <span class="n">Lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">0</span><span class="p">])</span>
    <span class="n">xc</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;xc&#39;</span><span class="p">,</span> <span class="n">Lat</span><span class="o">.</span><span class="n">shape</span><span class="p">[</span><span class="mi">1</span><span class="p">])</span>
    <span class="n">time</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createDimension</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="kc">None</span><span class="p">)</span>

    <span class="n">times</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float64</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;time&#39;</span><span class="p">,))</span>
    <span class="n">lat</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;rlat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">,))</span>
    <span class="n">lon</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;rlon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">,))</span>

    <span class="n">regular_lat</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;regular_lat&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,</span> <span class="p">(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span> <span class="s1">&#39;xc&#39;</span><span class="p">))</span>
    <span class="n">regular_lon</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;regular_lon&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span> <span class="s1">&#39;xc&#39;</span><span class="p">))</span>

    <span class="k">if</span> <span class="n">mcs_tb_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">PR_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;PR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="c1"># PR_obj = dataset.createVariable(&#39;PR_Objects&#39;, np.float32,(&#39;time&#39;,&#39;yc&#39;,&#39;xc&#39;),zlib=True)</span>
        <span class="c1"># MCSs = dataset.createVariable(&#39;MCS_Objects&#39;, np.float32,(&#39;time&#39;,&#39;yc&#39;,&#39;xc&#39;),zlib=True)</span>
        <span class="n">MCSs_Tb</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MCS_Tb_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Cloud_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;BT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Cloud_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;BT_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">front_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">FR_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;FR&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">FR_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;FR_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">T_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;T850&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">slp_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">CY_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CY_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ACY_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ACY_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">SLP_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;SLP&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">tc_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">TCs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;TC_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ms_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">MS_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MS&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">MS_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MS_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ar_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">IVT_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;IVT&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">IVT_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;IVT_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ARs</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;AR_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">z500_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">CY_z500_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;CY_z500_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ACY_z500_obj</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ACY_z500_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">Z500_real</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Z500&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">col_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">COL</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;COL_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">jet_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">JET</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;JET_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">UV200</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;UV200&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
    <span class="k">if</span> <span class="n">ew_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">MRG</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;MRG_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">IGW</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;IGW_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">KELVIN</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;Kelvin_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">EIG</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;EIG0_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        <span class="n">ER</span> <span class="o">=</span> <span class="n">dataset</span><span class="o">.</span><span class="n">createVariable</span><span class="p">(</span><span class="s1">&#39;ER_Objects&#39;</span><span class="p">,</span> <span class="n">np</span><span class="o">.</span><span class="n">float32</span><span class="p">,(</span><span class="s1">&#39;time&#39;</span><span class="p">,</span><span class="s1">&#39;yc&#39;</span><span class="p">,</span><span class="s1">&#39;xc&#39;</span><span class="p">),</span><span class="n">zlib</span><span class="o">=</span><span class="kc">True</span><span class="p">)</span>
        

    <span class="n">times</span><span class="o">.</span><span class="n">calendar</span> <span class="o">=</span> <span class="s2">&quot;standard&quot;</span>
    <span class="n">times</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;seconds since &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;-&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">day</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot; &quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">hour</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">minute</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;:00&quot;</span>
    <span class="n">times</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>
    <span class="n">times</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;time&quot;</span>

    <span class="n">lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;rotated latitude&quot;</span> <span class="p">;</span>
    <span class="n">lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_north&quot;</span> <span class="p">;</span>
    <span class="n">lat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;rotated latitude&quot;</span> <span class="p">;</span>

    <span class="n">lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;rotated longitude&quot;</span> <span class="p">;</span>
    <span class="n">lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_east&quot;</span> <span class="p">;</span>
    <span class="n">lon</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;rotated longitude&quot;</span> <span class="p">;</span>
    
    <span class="n">regular_lat</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;regular latitude&quot;</span> <span class="p">;</span>
    <span class="n">regular_lat</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_north&quot;</span> <span class="p">;</span>
    <span class="n">regular_lat</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;regular latitude&quot;</span> <span class="p">;</span>

    <span class="n">regular_lon</span><span class="o">.</span><span class="n">long_name</span> <span class="o">=</span> <span class="s2">&quot;regular longitude&quot;</span> <span class="p">;</span>
    <span class="n">regular_lon</span><span class="o">.</span><span class="n">units</span> <span class="o">=</span> <span class="s2">&quot;degrees_east&quot;</span> <span class="p">;</span>
    <span class="n">regular_lon</span><span class="o">.</span><span class="n">standard_name</span> <span class="o">=</span> <span class="s2">&quot;regular longitude&quot;</span> <span class="p">;</span>


    <span class="k">if</span> <span class="n">mcs_tb_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">PR_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">PR_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;precipitation&quot;</span>
        <span class="n">PR_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;mm/&quot;</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">dT</span><span class="p">)</span><span class="o">+</span><span class="s2">&quot;h&quot;</span>
        
<span class="c1">#         PR_obj.coordinates = &quot;lon lat&quot;</span>
<span class="c1">#         PR_obj.longname = &quot;precipitation objects&quot;</span>
<span class="c1">#         PR_obj.unit = &quot;&quot;</span>
        
<span class="c1">#         MCSs.coordinates = &quot;lon lat&quot;</span>
<span class="c1">#         MCSs.longname = &quot;MCSs object defined by their precipitation&quot;</span>
<span class="c1">#         MCSs.unit = &quot;&quot;</span>
        
        <span class="n">MCSs_Tb</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">MCSs_Tb</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;MCSs object defined by their Tb&quot;</span>
        <span class="n">MCSs_Tb</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">Cloud_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">Cloud_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Tb&quot;</span>
        <span class="n">Cloud_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>
        
        <span class="n">Cloud_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">Cloud_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Tb objects&quot;</span>
        <span class="n">Cloud_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">front_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">FR_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">FR_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;frontal index&quot;</span>
        <span class="n">FR_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">FR_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">FR_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;frontal objects&quot;</span>
        <span class="n">FR_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">T_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">T_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;850 hPa air temperature&quot;</span>
        <span class="n">T_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;K&quot;</span>
    <span class="k">if</span> <span class="n">slp_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">CY_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">CY_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;cyclone objects from SLP&quot;</span>
        <span class="n">CY_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">ACY_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">ACY_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;anticyclone objects from SLP&quot;</span>
        <span class="n">ACY_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">SLP_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">SLP_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;sea level pressure (SLP)&quot;</span>
        <span class="n">SLP_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;Pa&quot;</span>
    <span class="k">if</span> <span class="n">ms_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">MS_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">MS_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;850 hPa moisture flux&quot;</span>
        <span class="n">MS_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;g/g m/s&quot;</span>
        
        <span class="n">MS_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">MS_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;mosture streams objects according to 850 hPa moisture flux&quot;</span>
        <span class="n">MS_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">ar_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">IVT_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">IVT_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;vertically integrated moisture transport&quot;</span>
        <span class="n">IVT_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;kg m1 s1&quot;</span>
        
        <span class="n">IVT_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">IVT_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;IVT objects&quot;</span>
        <span class="n">IVT_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">ARs</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">ARs</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;atmospheric river objects&quot;</span>
        <span class="n">ARs</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">tc_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">TCs</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">TCs</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;tropical cyclone objects&quot;</span>
        <span class="n">TCs</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">z500_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">CY_z500_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">CY_z500_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;cyclone objects according to Z500&quot;</span>
        <span class="n">CY_z500_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">ACY_z500_obj</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">ACY_z500_obj</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;anticyclone objects according to Z500&quot;</span>
        <span class="n">ACY_z500_obj</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">Z500_real</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">Z500_real</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;500 hPa geopotential height&quot;</span>
        <span class="n">Z500_real</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;gpm&quot;</span>
    <span class="k">if</span> <span class="n">col_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">COL</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">COL</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;cut off low objects&quot;</span>
        <span class="n">COL</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
    <span class="k">if</span> <span class="n">jet_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">JET</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">JET</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;jet stream objects&quot;</span>
        <span class="n">JET</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">UV200</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">UV200</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;200 hPa wind speed&quot;</span>
        <span class="n">UV200</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;m s-1&quot;</span>
    <span class="k">if</span> <span class="n">ew_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">MRG</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">MRG</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Mixed Rosby Gravity wave objects&quot;</span>
        <span class="n">MRG</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">IGW</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">IGW</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Inertia Gravity wave objects&quot;</span>
        <span class="n">IGW</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">KELVIN</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">KELVIN</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Kelvin wave objects&quot;</span>
        <span class="n">KELVIN</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">EIG</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">EIG</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Eastward Inertio Gravirt wave objects&quot;</span>
        <span class="n">EIG</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>
        
        <span class="n">ER</span><span class="o">.</span><span class="n">coordinates</span> <span class="o">=</span> <span class="s2">&quot;lon lat&quot;</span>
        <span class="n">ER</span><span class="o">.</span><span class="n">longname</span> <span class="o">=</span> <span class="s2">&quot;Equatorial Rossby wave objects&quot;</span>
        <span class="n">ER</span><span class="o">.</span><span class="n">unit</span> <span class="o">=</span> <span class="s2">&quot;&quot;</span>

    <span class="n">lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Lat</span>
    <span class="n">lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Lon</span>
    <span class="n">regular_lat</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">regular_Lat</span>
    <span class="n">regular_lon</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">regular_Lon</span>

    <span class="k">if</span> <span class="n">mcs_tb_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">PR_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">pr</span>
        <span class="c1"># PR_obj[:] = PR_objects</span>
        <span class="c1"># MCSs[:] = MCS_obj</span>
        <span class="n">MCSs_Tb</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MCS_objects_Tb</span>
        <span class="n">Cloud_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">tb</span>
        <span class="n">Cloud_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">C_objects</span>
    <span class="k">if</span> <span class="n">front_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">FR_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">Frontal_Diagnostic</span>
        <span class="n">FR_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">FR_objects</span>
        <span class="n">T_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">t850</span>
    <span class="k">if</span> <span class="n">tc_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">TCs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">TC_obj</span>
    <span class="k">if</span> <span class="n">slp_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">CY_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">CY_objects</span>
        <span class="n">ACY_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">ACY_objects</span>
        <span class="n">SLP_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">slp</span>
    <span class="k">if</span> <span class="n">ms_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">MS_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">VapTrans</span>
        <span class="n">MS_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">MS_objects</span>
    <span class="k">if</span> <span class="n">ar_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">IVT_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">IVT</span>
        <span class="n">IVT_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">IVT_objects</span>
        <span class="n">ARs</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">AR_obj</span>
    <span class="k">if</span> <span class="n">z500_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">CY_z500_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">cy_z500_objects</span>
        <span class="n">ACY_z500_obj</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">acy_z500_objects</span>
        <span class="n">Z500_real</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">z500</span>
    <span class="k">if</span> <span class="n">col_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">COL</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">col_obj</span>
    <span class="k">if</span> <span class="n">jet_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">JET</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">jet_objects</span>
        <span class="n">UV200</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">uv200</span>
    <span class="k">if</span> <span class="n">ew_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="n">MRG</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">mrg_objects</span>
        <span class="n">IGW</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">igw_objects</span>
        <span class="n">KELVIN</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">kelvin_objects</span>
        <span class="n">EIG</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">eig0_objects</span>
        <span class="n">ER</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">er_objects</span>
                
    <span class="n">times</span><span class="p">[:]</span> <span class="o">=</span> <span class="n">iTime</span>

    <span class="n">dataset</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
    <span class="nb">print</span><span class="p">(</span><span class="s1">&#39;Saved: &#39;</span><span class="o">+</span><span class="n">NCfile</span><span class="p">)</span>
    <span class="kn">import</span> <span class="nn">time</span>
    <span class="n">end</span> <span class="o">=</span> <span class="n">time</span><span class="o">.</span><span class="n">perf_counter</span><span class="p">()</span>
    <span class="n">timer</span><span class="p">(</span><span class="n">start</span><span class="p">,</span> <span class="n">end</span><span class="p">)</span>

    <span class="k">if</span> <span class="n">tc_test</span> <span class="o">==</span> <span class="s1">&#39;yes&#39;</span><span class="p">:</span>
        <span class="c1">### SAVE THE TC TRACKS TO PICKL FILE</span>
        <span class="c1"># ============================</span>
        <span class="n">a_file</span> <span class="o">=</span> <span class="nb">open</span><span class="p">(</span><span class="n">OutputFolder</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">year</span><span class="p">)</span><span class="o">+</span><span class="nb">str</span><span class="p">(</span><span class="n">Time</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span><span class="o">.</span><span class="n">month</span><span class="p">)</span><span class="o">.</span><span class="n">zfill</span><span class="p">(</span><span class="mi">2</span><span class="p">)</span><span class="o">+</span><span class="s1">&#39;_TCs_tracks.pkl&#39;</span><span class="p">,</span> <span class="s2">&quot;wb&quot;</span><span class="p">)</span>
        <span class="n">pickle</span><span class="o">.</span><span class="n">dump</span><span class="p">(</span><span class="n">TC_Tracks</span><span class="p">,</span> <span class="n">a_file</span><span class="p">)</span>
        <span class="n">a_file</span><span class="o">.</span><span class="n">close</span><span class="p">()</span>
        
    <span class="k">if</span> <span class="s1">&#39;object_split&#39;</span> <span class="ow">in</span> <span class="nb">locals</span><span class="p">():</span> <span class="c1"># JLa</span>
        <span class="k">return</span> <span class="n">object_split</span> </div>
</pre></div>

           </div>
           
          </div>
          <footer>

  <hr/>

  <div role="contentinfo">
    <p>
        &#169; Copyright 2024, Johannes Riebold.

    </p>
  </div>
    
    
    
    Built with <a href="https://www.sphinx-doc.org/">Sphinx</a> using a
    
    <a href="https://github.com/readthedocs/sphinx_rtd_theme">theme</a>
    
    provided by <a href="https://readthedocs.org">Read the Docs</a>. 

</footer>
        </div>
      </div>

    </section>

  </div>
  

  <script type="text/javascript">
      jQuery(function () {
          SphinxRtdTheme.Navigation.enable(true);
      });
  </script>

  
  
    
   

</body>
</html>